<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Dine-In Book</title>
  <style>
    /* =====================
       THEME (Light / Dark) & ROOT VARS
       ===================== */
    :root{
      --bg: #f4f8ff;
      --surface: #ffffff;
      --text: #1f2a44;
      --muted: #6b7a99;
      --border: #d8e1ff;
      --brand: #1f70ff;
      --brand-2: #2a5298;
      --brand-3: #1e3c72;
      --chip: #eef4ff;
      --danger: #e54646;
      --success: #25d366;
      --shadow: 0 6px 24px rgba(0,0,0,.08);
      --qty-btn-bg: #eef4ff;
      --qty-btn-text: #1f2a44;
      --container-max: 1200px;
       --fixed-bar-height: 70px;
    }
    body.dark-mode{
      --bg: #0e1116;
      --surface: #141922;
      --text: #e6ebff;
      --muted: #aab6db;
      --border: #263148;
      --brand: #4da3ff;
      --chip: #0f1a2a;
      --shadow: 0 8px 28px rgba(0,0,0,.5);
      --qty-btn-bg: #263148;
      --qty-btn-text: #e6ebff;
    }

    /* =====================
       BASE
       ===================== */
    *{box-sizing:border-box}
    html,body{height:100%}
body {
  margin: 0;
  font-family: Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
  background: var(--bg);
  color: var(--text);
  transition: background .25s, color .25s;
  padding-bottom: var(--fixed-bar-height); /* ruang kosong sesuai tinggi fixbar */
}

    img{max-width:100%;display:block}
    .container{max-width:var(--container-max);margin:0 auto;padding:0 16px}

    /* HEADER */
    header{
      width:100%;
      background: linear-gradient(90deg,var(--brand-2),var(--brand-3));
      color:#fff;
      padding:16px;
      position:relative;
      box-shadow:var(--shadow);
    }
    .header-inner{
      display:flex;
      justify-content:space-between;
      align-items:stretch;
      gap:12px;
    }
    .header-left{
      display:flex;
      flex-direction:column;
      gap:6px;
      flex:1;
      min-width:0;
    }
    #restoLogo{height:60px;width:60px;object-fit:contain;border-radius:8px;background:rgba(255,255,255,.1);flex-shrink:0;margin-bottom:4px}
    .resto-info{display:flex;flex-direction:column;text-align:left;gap:2px}
    #restoName{margin:0;font-size:16px;font-weight:800;color:#fff;line-height:1.2;word-break:break-word}
    .contact-info{font-size:12px;opacity:.95;margin:0;line-height:1.2}
    #teleponRestoranDisplay{color:#fff;font-weight:500;margin:0}

    .header-right{
      display:flex;
      flex-direction:column;
      justify-content:space-between;
      align-items:flex-end;
      flex:0 0 auto;
      gap:8px;
    }
    .dark-toggle{
      background: rgba(255,255,255,0.12);
      border: none;
      font-size:1.2rem;
      cursor:pointer;
      color: #fff;
      padding:4px 6px;
      border-radius:6px;
    }
    .locale-select{
      padding:4px 6px;border-radius:6px;border:none;background:rgba(255,255,255,0.12);color:#fff;font-weight:600;font-size:12px;max-width:140px;
    }

    /* TABS */
    .tabs-wrap{background:var(--surface);top:96px;z-index:40;box-shadow:var(--shadow)}
    .tabs{display:flex;gap:8px;padding:10px;justify-content:center;flex-wrap:wrap}
    .tab{padding:8px 14px;border:1px solid var(--border);border-radius:999px;background:var(--chip);color:var(--text);cursor:pointer;font-weight:600}
    .tab.active{background:var(--brand);color:#fff;border-color:var(--brand)}

    .tab-content{display:none;padding:20px 0}
    .tab-content.active{display:block}
    .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:16px}

    /* menu card */
    .menu-card{
      background:var(--surface);border:1px solid var(--border);border-radius:8px;box-shadow:var(--shadow);padding:8px;display:flex;flex-direction:column;gap:6px;cursor:pointer;transition:transform .12s;
    }
    .menu-card:hover{transform:translateY(-4px)}
    .menu-thumb{aspect-ratio:1/1;height:auto;border-radius:8px;object-fit:cover;background:#e9eefc}
    .menu-title{font-weight:700;font-size:14px;text-align:center;margin:2px 0 0 0}
    .menu-desc{font-size:12px;color:var(--muted);text-align:center}
    .menu-price{font-size:13px;font-weight:800;text-align:center;margin-top:4px}
    
    /* Badge khusus di menu card */
.menu-card {
  position: relative; /* supaya badge bisa nempel relatif ke card */
}

.menu-card .badge {
  position: absolute;
  top: 8px;       /* jarak dari atas card */
  right: 8px;     /* jarak dari kanan card */
  background-color: #007bff; /* biru elegan */
  color: white;
  font-size: 12px;
  font-weight: bold;
  width: 20px;
  height: 20px;
  border-radius: 50%; /* bikin bulat */
  display: flex;
  align-items: center;
  justify-content: center;
  box-shadow: 0 0 2px rgba(0,0,0,0.3);
}
   .promo-card {
  position: relative; /* supaya anak absolute bisa nempel di dalam card */
}
    .promo-card {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: 8px;
  box-shadow: var(--shadow);
  padding: 8px;
  display: flex;
  flex-direction: column;
  gap: 6px;
  cursor: pointer;
  transition: transform .12s;
  position: relative; /* biar badge bisa nempel */
}
.promo-card:hover { transform: translateY(-4px); }

.promo-card img,
.promo-card .menu-thumb {
  aspect-ratio: 1/1;
  border-radius: 8px;
  object-fit: cover;
  background: #e9eefc;
}

.promo-name {
  font-weight: 700;
  font-size: 14px;
  text-align: center;
  margin: 2px 0 0 0;
}
.promo-menu-desc {
  font-size: 12px;
  color: var(--muted);
  text-align: center;
}
.promo-price {
  font-size: 13px;
  font-weight: 800;
  text-align: center;
  margin-top: 4px;
}

.promo-card .badge {
  position: absolute;
  top: 8px;
  right: 8px;
  background: #007bff;
  color: #fff;
  font-size: 12px;
  font-weight: bold;
  border-radius: 50%;
  min-width: 20px;
  min-height: 20px;
  display: flex;
  align-items: center;
  justify-content: center;
  box-shadow: 0 0 2px rgba(0,0,0,0.3);
}

    /* CART / FOOTER */
 footer {
  background: var(--surface);
  margin-top: 24px;
  box-shadow: var(--shadow);
  padding-bottom: calc(var(--fixed-bar-height) + 20px); /* kasih extra biar lebih lega */
}

    .footer-inner{padding:18px 0 24px;}
    .cart{border:1px solid var(--border);border-radius:16px;padding:12px;background:var(--surface)}
    .cart h3{margin:6px 6px 10px;font-size:18px;position:relative;padding-right:56px} 
    .cart-empty{color:var(--muted);padding:8px}

    .order-count{
      position:absolute;
      top:6px;
      right:6px;
      background:var(--brand);
      color:#fff;
      font-size:12px;
      font-weight:800;
      padding:4px 8px;
      border-radius:999px;
      display:none;
    }

    .cart-row{display:grid;grid-template-columns:1fr 76px 92px 28px;gap:8px;align-items:center;padding:6px 8px;border-bottom:1px dashed var(--border)}
    .cart-row:last-child{border-bottom:none}
    .qty-wrap{display:inline-flex;border:1px solid var(--border);border-radius:999px;overflow:hidden}
    .qty-wrap button{width:28px;height:28px;border:0;background:var(--qty-btn-bg);color:var(--qty-btn-text);cursor:pointer;font-weight:800;border-radius:6px}
    .qty-wrap input{width:36px;text-align:center;border:0;background:transparent;color:var(--text);font-weight:700}
    .price-right{text-align:right;font-weight:700}
    .remove-btn{border:0;background:transparent;color:var(--danger);font-size:18px;cursor:pointer}

    /* summary (vertical) */
    .cart-total{margin-top:15px;display:flex;flex-direction:column;gap:6px;padding-top:6px;border-top:1px solid var(--border);font-weight:800}
    .total-row{display:flex;justify-content:space-between;width:100%;align-items:center}
    .grand-total{font-size:1rem}

    /* FORM */
    .form{margin-top:18px;display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .form label{display:block;font-weight:700;font-size:13px;margin-bottom:4px;color:var(--muted)}
    .form input,.form textarea{width:100%;padding:10px 12px;border-radius:10px;border:1px solid var(--border);background:var(--surface);color:var(--text)}
    .form textarea{grid-column:1/-1;min-height:80px;resize:vertical}

    .actions{display:flex;gap:10px;margin-top:12px}
    .btn{flex:1;padding:12px;border-radius:12px;border:0;cursor:pointer;font-weight:800}
    .btn-wa{background:var(--success);color:#fff}
    .btn-back{background:#f39c12;color:#fff}

/* fixed bottom bar */
.fixed-bar {
  position: fixed;
  bottom: 0;
  left: 0;
  width: 100%;
  height: var(--fixed-bar-height); /* tinggi fixbar konsisten */
  background: var(--surface);      /* jangan dihapus, biar fixbar kelihatan */
  display: flex;
  align-items: center; /* tombol selalu sejajar tengah */
  justify-content: space-between;
  gap: 10px;
  padding: 0 12px;     /* horizontal padding aja */
  z-index: 100;
}

.fixed-bar button {
  flex: 1;
  height: 46px;
  font-size: 15px;
  font-weight: 700;
  border-radius: 8px;
  border: 0;
  cursor: pointer;
}

.btn-wa {
  background: var(--brand-2);
  color: #fff;
}
.btn-back {
  background: #ddd;
  color: #222;
}
    /* voucher UI */
    .voucher-box{display:flex;gap:8px;justify-content:flex-start}
    .voucher-box input{width:220px;max-width:60%;padding:8px;border:1px solid #ccc;border-radius:6px}
    #voucherMessage{margin-top:8px;font-size:0.9em;color:var(--muted);}

    /* responsive tweaks */
    @media (max-width:640px){
      .form{grid-template-columns:1fr}
      .cart-row{grid-template-columns:1fr 84px 84px 28px}
      #restoLogo{height:44px;width:44px}
    }
  </style>
</head>
<body>
  <header>
    <div class="header-inner container">
      <div class="header-left">
        <img id="restoLogo" alt="Logo" />
        <div class="resto-info">
          <h1 id="restoName">Nama Restoran</h1>
          <div class="contact-info">
            <div id="alamatRestoranDisplay"></div>
            <div id="teleponRestoranDisplay"></div>
          </div>
        </div>
      </div>

      <div class="header-right">
        <button class="dark-toggle" id="darkToggle" title="Toggle theme">ðŸŒ™</button>
        <select id="localeSelect" class="locale-select" title="Change locale / currency">
          <option value="auto">Auto (browser)</option>
          <option value="en-US|USD">US â€” USD</option>
          <option value="id-ID|IDR">INA â€” IDR</option>
          <option value="en-GB|GBP">UK â€” GBP</option>
          <option value="de-DE|EUR">Germany â€” EUR</option>
          <option value="ja-JP|JPY">Japan â€” JPY</option>
          <option value="zh-CN|CNY">China â€” CNY</option>
          <option value="fr-FR|EUR">France â€” EUR</option>
        </select>
      </div>
    </div>
  </header>

  <div class="tabs-wrap">
    <div class="container">
      <div class="tabs">
        <div class="tab active" onclick="switchTab('food')">Food</div>
        <div class="tab" onclick="switchTab('snack')">Snack & Dessert</div>
        <div class="tab" onclick="switchTab('drink')">Drink</div>
        <div class="tab" onclick="switchTab('special')">Special</div>
        <div class="tab" onclick="switchTab('promo')">Promo</div>
      </div>
    </div>
  </div>

  <main class="container" style="padding-top:12px">
    <section id="food" class="tab-content active"><div class="grid" id="foodGrid"></div></section>
    <section id="snack" class="tab-content"><div class="grid" id="snackGrid"></div></section>
    <section id="drink" class="tab-content"><div class="grid" id="drinkGrid"></div></section>
    <section id="special" class="tab-content"><div class="grid" id="specialGrid"></div></section>
    <section id="promo" class="tab-content"><div class="grid" id="promoGrid"></div></section>
  </main>

<footer>
  <div class="container footer-inner">
    <div class="cart" id="cartBox">
      <h3>ðŸ›’ Your Cart</h3>

      <!-- Voucher selalu tampil -->
      <div id="voucherSection" style="margin:15px 0;">
        <div class="voucher-box">
          <input 
            type="text" 
            id="voucherInput" 
            placeholder="Use Voucher Code"
          >
        </div>
        <p id="voucherMessage"></p>
      </div>

      <div id="cartRows" class="cart-rows"></div>
      <div id="cartEmpty" class="cart-empty">No items choice</div>

      <div class="cart-total">
        <div class="total-row">
          <span>Total Price</span>
          <span id="cartTotal">0</span>
        </div>
        <div class="total-row" id="discountRow" style="display:none; color:green;">
          <span>Discount</span>
          <span id="voucherDiscount">0</span>
        </div>
        <div class="total-row grand-total">
          <span>Grand Total</span>
          <span id="grandTotal">0</span>
        </div>
      </div>
    </div> <!-- tutup cart -->

    <!-- form masih di dalam container yang sama -->
    <div class="form" style="margin-top:12px">
      <div>
        <label for="custName">Customer Name</label>
        <input type="text" id="custName" placeholder="e.g. John Doe">
      </div>
      <div>
        <label for="custTable">Table No</label>
        <input type="text" id="custTable" placeholder="e.g. A12">
      </div>
      <div>
        <label for="custDate">Date</label>
        <input type="text" id="custDate" readonly>
      </div>
      <div>
        <label for="custTime">Time</label>
        <input type="text" id="custTime" readonly>
      </div>
      <div style="grid-column:1/-1">
        <label for="custNote">Special Request / Notes</label>
        <textarea id="custNote" placeholder="e.g. no spicy, extra sauce"></textarea>
      </div>
    </div>

    <div class="fixed-bar">
      <button class="btn btn-wa" id="btnSend" onclick="sendOrder()">ðŸ“¤ Submit Order</button>
      <button class="btn btn-back" onclick="history.back()">ðŸ”™ Back</button>
    </div>
  </div> <!-- tutup container -->
</footer>


  <!-- ========================= FULL JS (self-contained) ========================= -->
  <script>
  /* ------------------ CONFIG / STATE ------------------- */
  const DB_NAME = 'MenuvaDB';
  const STORE_NAME = 'menuvaData';
  let db = null;
  let menuData = [];
  let menuPromo = [];
  let restoData = {};
  let cart = [];
  let activeVoucherCode = null;
  const LOCALE_KEY = 'menuva_localeChoice';

  /* ------------------ LOCALE / CURRENCY ---------------- */
  const localeToCurrencyFallback = {
    'id': 'IDR','en-US': 'USD','en': 'USD','en-GB': 'GBP','de': 'EUR','fr': 'EUR','ja': 'JPY','zh': 'CNY'
  };

  function parseLocaleCurrency(value) {
    if (!value || value === 'auto') return { mode: 'auto' };
    const parts = String(value).split('|');
    return { mode: 'manual', locale: parts[0] || '', currency: parts[1] || '' };
  }

  function detectBrowserLocaleCurrency() {
    const locale = navigator.language || 'en-US';
    let currency = localeToCurrencyFallback[locale.split('-')[0]] || localeToCurrencyFallback[locale] || 'IDR';
    if (localeToCurrencyFallback[locale]) currency = localeToCurrencyFallback[locale];
    return { locale, currency };
  }

  function getActiveLocaleCurrency() {
    const saved = localStorage.getItem(LOCALE_KEY) || 'auto';
    const parsed = parseLocaleCurrency(saved);
    if (parsed.mode === 'auto') return detectBrowserLocaleCurrency();
    return {
      locale: parsed.locale || detectBrowserLocaleCurrency().locale,
      currency: parsed.currency || detectBrowserLocaleCurrency().currency
    };
  }

  function saveLocaleChoice(value) { localStorage.setItem(LOCALE_KEY, value); }

  function formatPrice(amount, currency, locale) {
    if (!isFinite(Number(amount))) amount = 0;
    amount = Number(amount);
    const zeroFractionCurrencies = ['IDR', 'JPY', 'KRW'];
    const opts = {
      style: 'currency',
      currency: currency || 'IDR',
      maximumFractionDigits: zeroFractionCurrencies.includes((currency || '').toUpperCase()) ? 0 : 2,
      minimumFractionDigits: zeroFractionCurrencies.includes((currency || '').toUpperCase()) ? 0 : 2
    };
    try { return new Intl.NumberFormat(locale || undefined, opts).format(amount); }
    catch (e) { return (currency ? currency + ' ' : '') + amount.toLocaleString(); }
  }

  function formatWithActive(amount) {
    const ac = getActiveLocaleCurrency();
    return formatPrice(amount, ac.currency, ac.locale);
  }

  /* ------------------ HELPERS ------------------- */
  function escapeHtml(str) {
    if (str === null || str === undefined) return '';
    return String(str).replace(/&/g,'&amp;').replace(/"/g,'&quot;').replace(/'/g,'&#39;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
  }

  function getQueryRestoId() {
    const p = new URLSearchParams(window.location.search);
    return p.get('resto') || null;
  }

  /* ------------------ IndexedDB (init & load) ------------------- */
  function initDB() {
    return new Promise((resolve,reject)=>{
      if (db) return resolve(db);
      const req = indexedDB.open(DB_NAME);
      req.onerror = () => reject(req.error);
      req.onsuccess = (e) => { db = e.target.result; resolve(db); };
    });
  }

  function loadDataFromDB(restoId) {
    return new Promise((resolve,reject)=>{
      if (!db) return reject(new Error('DB not initialized'));
      if (!db.objectStoreNames.contains(STORE_NAME)) {
        console.warn('Store not found:', STORE_NAME);
        return resolve(null);
      }
      const tx = db.transaction(STORE_NAME, 'readonly');
      const store = tx.objectStore(STORE_NAME);

      const getByKey = (k) => new Promise(res=>{
        try{
          const r = store.get(k);
          r.onsuccess = ()=>res(r.result||null);
          r.onerror = ()=>res(null);
        }catch(e){res(null)}
      });

      (async ()=>{
        try{
          if (restoId) {
            const byKey = await getByKey(restoId);
            if (byKey) return resolve(byKey);
          }
          const allReq = store.getAll();
          allReq.onsuccess = ()=>{
            const all = allReq.result || [];
            if (restoId) {
              const found = all.find(r => r && (r.restoId === restoId || r.restoPhone === restoId));
              if (found) return resolve(found);
            }
            if (all.length === 1) return resolve(all[0]);
            return resolve(null);
          };
          allReq.onerror = ()=> resolve(null);
        }catch(err){ console.error(err); resolve(null); }
      })();
    });
  }

  /* ------------------ CART FUNCTIONS ------------------- */
  function updateCartCount() {
    const el = document.getElementById('cartCount');
    if (!el) return;
    const totalItems = cart.reduce((s,i)=> s + (Number(i.qty)||0), 0);
    if (totalItems > 0) { el.style.display = 'inline-block'; el.textContent = totalItems; }
    else el.style.display = 'none';
  }

  function renderCart() {
    const rows = document.getElementById('cartRows');
    const empty = document.getElementById('cartEmpty');
    if (!rows || !empty) return;
    rows.innerHTML = '';

    if (!cart || cart.length === 0) {
      empty.style.display = 'block';
      const cartTotalEl = document.getElementById('cartTotal');
      const grandTotalEl = document.getElementById('grandTotal');
      if (cartTotalEl) { cartTotalEl.dataset.raw = 0; cartTotalEl.textContent = formatWithActive(0); }
      if (grandTotalEl) { grandTotalEl.dataset.raw = 0; grandTotalEl.textContent = formatWithActive(0); }
      const discountRow = document.getElementById('discountRow');
      if (discountRow) discountRow.style.display = 'none';
      updateCartCount();
      return;
    }

    empty.style.display = 'none';
    let total = 0;
    cart.forEach((c,i)=>{
      const subtotal = (Number(c.harga)||0) * (Number(c.qty)||0);
      total += subtotal;

      const row = document.createElement('div');
      row.className = 'cart-row';
      row.innerHTML = `
        <div>
          <strong>${escapeHtml(c.nama)}</strong>
          <div style="font-size:12px;color:var(--muted)">${formatWithActive(c.harga)} Ã— ${c.qty}</div>
        </div>
        <div class="qty-wrap">
          <button onclick="updateQty(${i}, -1)">-</button>
          <input type="text" value="${c.qty}" readonly />
          <button onclick="updateQty(${i}, 1)">+</button>
        </div>
        <div class="price-right">${formatWithActive(subtotal)}</div>
        <button class="remove-btn" title="Remove" onclick="removeFromCart(${i})">âœ•</button>
      `;
      rows.appendChild(row);
    });

    // store raw total on element for voucher calculation
    const cartTotalEl = document.getElementById('cartTotal');
    if (cartTotalEl) cartTotalEl.dataset.raw = String(total);

    refreshAllPriceDisplays(); // will compute discount & grand total via patched function
    updateCartCount();
  }

  function addToCart(name, price) {
    const harga = typeof price === 'string' ? parseFloat(String(price).replace(/[^0-9.]/g,'')) : Number(price);
    const key = name;
    const idx = cart.findIndex(i => i.key === key);
    if (idx >= 0) cart[idx].qty += 1;
    else cart.push({ key, nama: name, harga: harga || 0, qty: 1 });
    renderCart();
  }

  function updateQty(index, delta) {
    if (!cart[index]) return;
    cart[index].qty += delta;
    if (cart[index].qty <= 0) cart.splice(index,1);
    renderCart();
  }

  function removeFromCart(index) {
    cart.splice(index,1);
    renderCart();
  }
/* ------------------ RENDER MENU ---------------------- */
function renderMenu() {
  const map = { food:'foodGrid', snack:'snackGrid', drink:'drinkGrid', special:'specialGrid' };
  Object.keys(map).forEach(k=>{
    const grid = document.getElementById(map[k]);
    if (!grid) return;
    grid.innerHTML = '';
    const items = (menuData || []).filter(m => m.kategori === k);
    if (!items || items.length ===0) {
      grid.innerHTML = '<div class="cart-empty">No item yet</div>';
      return;
    }
    items.forEach(m=>{
      const card = document.createElement('div');
      card.className = 'menu-card';
      card.onclick = () => tambahPesanan(m, card);
      const hargaNum = Number(m.harga) || 0;
      card.innerHTML = `
        ${m.image ? `<img class="menu-thumb" src="${m.image}" alt="${escapeHtml(m.nama)}">` : `<div class="menu-thumb"></div>`}
        <div class="menu-title">${escapeHtml(m.nama)}</div>
        <div class="menu-desc">${escapeHtml(m.deskripsi || '')}</div>
        <div class="menu-price" data-price="${hargaNum}">${formatWithActive(hargaNum)}</div>
        <span class="badge">0</span>
      `;
      grid.appendChild(card);
    });
  });
}

/* ------------------ RENDER PROMO -------------------- */
function renderPromo(){
  const grid = document.getElementById('promoGrid');
  if (!grid) return;
  grid.innerHTML = '';
  const now = Date.now();
  const promos = (menuPromo||[]).filter(p=>{
    if (!p.tanggalAkhir) return true;
    const end = new Date(p.tanggalAkhir).getTime();
    return isFinite(end) ? end > now : true;
  });
  if (!promos || promos.length === 0) {
    grid.innerHTML = '<div class="cart-empty">No promo choice</div>';
    stopPromoCountdown();
    return;
  }
  promos.forEach(p=>{
    const card = document.createElement('div');
    card.className = 'promo-card';
    const item = { nama: p.namaPromo || p.namaMenu || 'Promo Item', harga: Number(p.harga)||0, deskripsi: p.deskripsi||'', image: p.image||'' };
    card.addEventListener('click', ()=> {
      if (p.tanggalAkhir) {
        const end = new Date(p.tanggalAkhir).getTime();
        if (isFinite(end) && Date.now() > end) return;
      }
      tambahPesanan(item, card);
    });

    const promoBadge = document.createElement('span');
    promoBadge.className='badge';
    promoBadge.textContent='0';
    card.appendChild(promoBadge);

    if (p.image) { 
      const img = document.createElement('img'); 
      img.src = p.image; 
      img.alt = item.nama; 
      card.appendChild(img); 
    } else { 
      const ph = document.createElement('div'); 
      ph.className='menu-thumb'; 
      card.appendChild(ph); 
    }
    const title = document.createElement('div'); title.className='promo-name'; title.textContent = p.namaPromo || p.namaMenu || 'Promo'; card.appendChild(title);
    const desc = document.createElement('div'); desc.className='promo-menu-desc'; desc.textContent = p.deskripsi||''; card.appendChild(desc);
    const price = document.createElement('div'); price.className='promo-price'; price.dataset.price = Number(p.harga)||0; price.textContent = formatWithActive(Number(p.harga)||0); card.appendChild(price);
    if (p.tanggalAkhir) { const c = document.createElement('div'); c.className='promo-count'; c.dataset.end = p.tanggalAkhir; card.appendChild(c); }

    grid.appendChild(card);
  });
  startPromoCountdown();
}

/* ------------------ TAMBAH PESANAN ------------------ */
function tambahPesanan(item, cardEl) {
  const existing = cart.find(c => c.nama === item.nama);
  const hargaNum = Number(item.harga) || 0;

  if (existing) {
    existing.qty += 1;
  } else {
    cart.push({ key:item.nama, nama:item.nama, harga:hargaNum, qty:1 });
  }

  const counter = cardEl.querySelector('.badge');
  if (counter) {
    const cartItem = cart.find(c => c.nama === item.nama);
    counter.textContent = cartItem.qty;
    counter.style.display = 'flex';
  }

  renderCart();
}

/* ------------------ INPUT VOUCHER ------------------ */
const voucherInput = document.getElementById("voucherInput");
const voucherMessage = document.getElementById("voucherMessage");

function applyVoucher() {
  const code = voucherInput.value.trim().toUpperCase();
  if (!code) {
    voucherMessage.textContent = "Please enter voucher code!";
    return;
  }

  // validasi voucher sesuai project lo
  if (code === "DISKON10") {
    voucherMessage.textContent = "Voucher applied! 10% off";
  } else {
    voucherMessage.textContent = "Invalid voucher code!";
  }
}

document.getElementById("applyVoucherBtn")?.addEventListener("click", applyVoucher);

/* ------------------ HELPERS ------------------ */
function escapeHtml(text) {
  const map = { '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#039;' };
  return text.replace(/[&<>"']/g, m => map[m]);
}

function formatWithActive(num) {
  return formatCurrency(num);
}

 // âœ… deklarasi global di atas semua function
let promoCountdownTimer = null;

function startPromoCountdown() {
  stopPromoCountdown();
  promoCountdownTimer = setInterval(()=>{
    document.querySelectorAll('.promo-count').forEach(el=>{
      const end = new Date(el.dataset.end).getTime();
      const now = Date.now();
      let diff = end - now;
      if (diff <= 0) {
        el.textContent = "Expired";
      } else {
        let h = Math.floor(diff / (1000*60*60));
        let m = Math.floor((diff % (1000*60*60)) / (1000*60));
        let s = Math.floor((diff % (1000*60)) / 1000);
        el.textContent = `${h}h ${m}m ${s}s`;
      }
    });
  }, 1000);
}

function stopPromoCountdown() {
  if (promoCountdownTimer) {
    clearInterval(promoCountdownTimer);
    promoCountdownTimer = null;
  }
}

  /* ------------------ SEND ORDER (WhatsApp) ------------- */
  function sendOrder(){
    // validate WA
    const adminNos = restoData.nomorWaAdmin || restoData.nomor_admin || restoData.nomor || [];
    if (!adminNos || (Array.isArray(adminNos) && adminNos.length === 0)) {
      alert("WhatsApp admin number not configured.");
      return;
    }

    const name = document.getElementById('custName').value.trim();
    const table = document.getElementById('custTable').value.trim();
    if (!name || !table) { alert('Please fill customer name and table number!'); return; }
    if (!cart || cart.length === 0) { alert('Cart is empty!'); return; }

    const adminNoRaw = Array.isArray(adminNos) ? adminNos[0] : adminNos;
    const adminNo = String(adminNoRaw).replace(/[^0-9]/g,'');
    const date = document.getElementById('custDate').value || '';
    const time = document.getElementById('custTime').value || '';
    const note = document.getElementById('custNote').value.trim() || '';

    let msg = `ðŸ½ï¸ New Dine-in Order - ${restoData.namaRestoran || ''}\n\n`;
    msg += `Name: ${name}\nTable: ${table}\nDate: ${date}\nTime: ${time}\n\nðŸ“ Order:\n`;

    let subtotal = 0;
    cart.forEach((c,i)=>{
      const itemTotal = (Number(c.harga)||0) * (Number(c.qty)||0);
      subtotal += itemTotal;
      msg += `${i+1}. ${c.nama} x${c.qty} - ${formatWithActive(itemTotal)}\n`;
    });

    // voucher
    let discount = 0;
    let voucherCode = null;
    let discountPercent = 0;
    if (activeVoucherData) {
  discountPercent = parseFloat(activeVoucherData.discount) || 0;
  discount = subtotal * (discountPercent / 100);
  voucherCode = activeVoucherData.code;
}
    if (discount > 0) {
      const finalTotal = subtotal - discount;
      msg += `\nSubtotal: ${formatWithActive(subtotal)}`;
      msg += `\nDiscount (${voucherCode} - ${discountPercent}%): -${formatWithActive(discount)}`;
      msg += `\nGrand Total: ${formatWithActive(finalTotal)}`;
    } else {
      msg += `\nGrand Total: ${formatWithActive(subtotal)}`;
    }

    if (note) msg += `\n\nNotes: ${note}`;

    const url = `https://wa.me/${adminNo}?text=${encodeURIComponent(msg)}`;
    window.open(url, '_blank');
  }

  /* ------------------ LOCALE UI ------------------------- */
  function initLocaleSelect(){
    const sel = document.getElementById('localeSelect');
    if (!sel) return;
    const saved = localStorage.getItem(LOCALE_KEY) || 'auto';
    sel.value = saved;
    sel.addEventListener('change', ()=>{
      saveLocaleChoice(sel.value);
      refreshAllPriceDisplays();
    });
  }

  /* refresh price elements */
  function refreshAllPriceDisplays(){
    document.querySelectorAll('.menu-price').forEach(el=>{
      const p = Number(el.dataset.price) || 0;
      el.textContent = formatWithActive(p);
    });
    // call renderCart to ensure cartTotal.dataset.raw is correct
    // but to avoid loops we won't call renderCart here; renderCart sets dataset.raw.
    // Instead compute discount & grand total here using cartTotal.dataset.raw
    try { applyVoucherAndUpdateSummary(); } catch(e){}
  }

  /* ---------- Voucher: auto apply & display ---------- */
  function cleanNumber(val){
    if (val == null) return 0;
    return parseFloat(String(val).replace(/[^0-9.-]/g,'')) || 0;
  }

  function applyVoucherAndUpdateSummary(){
    const cartTotalEl = document.getElementById('cartTotal');
    const grandTotalEl = document.getElementById('grandTotal');
    const discountRow = document.getElementById('discountRow');
    const voucherDiscountEl = document.getElementById('voucherDiscount');

    if (!cartTotalEl || !grandTotalEl) return;

    const rawTotal = cleanNumber(cartTotalEl.dataset.raw) || 0;
    let discount = 0;

    if (activeVoucherCode) {
      const voucher = JSON.parse(localStorage.getItem("voucher") || "null");
      if (voucher && voucher.code === activeVoucherCode) {
        discount = rawTotal * (parseFloat(voucher.discount) / 100);
      }
    }

    const newTotal = Math.max(0, rawTotal - discount);
    cartTotalEl.textContent = formatWithActive(rawTotal);
    if (discount > 0) {
      if (discountRow) discountRow.style.display = 'flex';
      if (voucherDiscountEl) voucherDiscountEl.textContent = formatWithActive(discount);
    } else {
      if (discountRow) discountRow.style.display = 'none';
      if (voucherDiscountEl) voucherDiscountEl.textContent = formatWithActive(0);
    }
    if (grandTotalEl) grandTotalEl.textContent = formatWithActive(newTotal);
  }

  // patch renderAll (safe wrapper so earlier code can call refreshAllPriceDisplays)
  const _origRefresh = window.refreshAllPriceDisplays;
  window.refreshAllPriceDisplays = function(){
    try { _origRefresh?.(); } catch(e){}
    // also call applyVoucherAndUpdateSummary in case cartTotal.dataset.raw already set by renderCart
    applyVoucherAndUpdateSummary();
  };

  /* === auto-apply voucher on input (multi-event for mobile compatibility) === */
function initVoucherInput(){
  const voucherInput = document.getElementById('voucherInput');
  const voucherMessage = document.getElementById('voucherMessage');
  if (!voucherInput || !voucherMessage) return;

  const apply = ()=>{
    const code = voucherInput.value.trim();
    const voucher = JSON.parse(localStorage.getItem("voucher") || "null");
    if (voucher && code.toUpperCase() === (voucher.code||'').toUpperCase()) {
      activeVoucherCode = voucher.code;
      activeVoucherData = voucher; // âœ… simpan data voucher
      voucherMessage.textContent = `âœ… Voucher applied: ${voucher.discount}% off`;
      voucherMessage.style.color = 'green';
    } else if (code.length > 0) {
      activeVoucherCode = null;
      activeVoucherData = null;
      voucherMessage.textContent = 'âŒ Invalid voucher code';
      voucherMessage.style.color = 'red';
    } else {
      activeVoucherCode = null;
      activeVoucherData = null;
      voucherMessage.textContent = '';
    }
  };

  // tambahin event listener biar langsung apply saat input berubah
  voucherInput.addEventListener("input", apply);
}

  /* ------------------ THEME (dark toggle) ------------------ */
  function initTheme(){
    const btn = document.getElementById('darkToggle');
    const saved = localStorage.getItem('darkMode') || 'disabled';
    if (saved === 'enabled') { document.body.classList.add('dark-mode'); btn.textContent = 'â˜€ï¸'; }
    else btn.textContent = 'ðŸŒ™';
    btn.addEventListener('click', ()=> {
      document.body.classList.toggle('dark-mode');
      if (document.body.classList.contains('dark-mode')) {
        btn.textContent = 'â˜€ï¸'; localStorage.setItem('darkMode','enabled');
      } else { btn.textContent = 'ðŸŒ™'; localStorage.setItem('darkMode','disabled'); }
    });
  }

  /* ------------------ TABS ------------------ */
  function switchTab(tabName){
    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
    const target = document.getElementById(tabName);
    if (target) target.classList.add('active');
    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
    const activeTab = Array.from(document.querySelectorAll('.tab')).find(x => x.getAttribute('onclick')?.includes(tabName));
    if (activeTab) activeTab.classList.add('active');
  }

  /* ------------------ INIT (on DOM ready) ---------------- */
  window.addEventListener('DOMContentLoaded', async ()=>{
    try{ initTheme(); } catch(e){console.warn(e);}
    initLocaleSelect();

    // init DB & load data
    try{
      await initDB();
      const restoId = getQueryRestoId();
      const data = await loadDataFromDB(restoId);
      restoData = data || {};
      menuData = Array.isArray(data?.menu) ? data.menu : [];
      menuPromo = Array.isArray(data?.menuPromo) ? data.menuPromo : [];
    }catch(e){ console.warn('DB init error',e) }

    // header info
    const logoEl = document.getElementById('restoLogo'); if (logoEl) { logoEl.src = restoData?.logo || ''; logoEl.style.display = restoData?.logo ? 'block' : 'none'; }
    const nameEl = document.getElementById('restoName'); if (nameEl) nameEl.innerText = restoData?.namaRestoran || 'Nama Restoran';
    const alamatEl = document.getElementById('alamatRestoranDisplay'); if (alamatEl) alamatEl.innerText = restoData?.restoAddress || '';
    const telEl = document.getElementById('teleponRestoranDisplay'); if (telEl) telEl.innerText = restoData?.restoPhone || '';

    // set default date/time
    const now = new Date();
    const pad = n => String(n).padStart(2,'0');
    const dateStr = `${now.getFullYear()}-${pad(now.getMonth()+1)}-${pad(now.getDate())}`;
    const timeStr = `${pad(now.getHours())}:${pad(now.getMinutes())}`;
    const dateInput = document.getElementById('custDate'); if (dateInput) dateInput.value = dateStr;
    const timeInput = document.getElementById('custTime'); if (timeInput) timeInput.value = timeStr;

    // render UI
    renderMenu();
    renderPromo();
    renderCart();
    applyVoucherAndUpdateSummary();

    // voucher UI show logic
    const plan = localStorage.getItem('user_plan');
    const voucherEnabled = localStorage.getItem('page_voucher') === 'true';
    if (plan !== 'monthly' && voucherEnabled) {
      const vs = document.getElementById('voucherSection'); if (vs) vs.style.display = 'block';
    }
    initVoucherInput();

    // expose for debug
    window._menuva = { getActiveLocaleCurrency, formatWithActive, refreshAllPriceDisplays, addToCart, loadDataFromDB };

    console.log('book.html initialized. restoId param=', getQueryRestoId(), 'loaded:', !!restoData);
  });

  </script>
<script>
// Helper aman parse angka
function cleanNumber(val) {
  if (val == null) return 0;
  return parseFloat(String(val).replace(/[^0-9.-]/g, "")) || 0;
}

let activeLocale = "id-ID";
let activeCurrency = "IDR";

// Listener dropdown
document.getElementById("localeSelect").addEventListener("change", (e) => {
  const val = e.target.value;
  if (val === "auto") {
    activeLocale = navigator.language || "id-ID";
    activeCurrency = "IDR";
  } else {
    const [loc, cur] = val.split("|");
    activeLocale = loc;
    activeCurrency = cur;
  }
  rerenderPrices(); // refresh harga setelah ganti
});

// Format currency fleksibel
function formatCurrency(num) {
  return Number(num).toLocaleString(activeLocale, {
    style: "currency",
    currency: activeCurrency,
    minimumFractionDigits: 0,
    maximumFractionDigits: 0
  });
}

// === Apply Voucher otomatis ===
function autoApplyVoucher() {
  const voucher = JSON.parse(localStorage.getItem("voucher") || "null");
  const input = document.getElementById("voucherInput")?.value.trim();
  const msg = document.getElementById("voucherMessage");

  const totalEl = document.getElementById("cartTotal");
  const discountEl = document.getElementById("voucherDiscount");
  const grandEl = document.getElementById("grandTotal");

  if (!totalEl || !msg || !grandEl) return;

  if (!totalEl.dataset.rawOriginal) {
    totalEl.dataset.rawOriginal = String(cleanNumber(totalEl.dataset.raw) || 0);
  }

  const originalTotal = cleanNumber(totalEl.dataset.rawOriginal);

  if (!input) {
    totalEl.innerText = formatCurrency(originalTotal);
    totalEl.dataset.raw = String(originalTotal);
    if (discountEl) { discountEl.parentElement.style.display = "none"; discountEl.innerText = ""; }
    msg.innerText = "";
    grandEl.innerText = formatCurrency(originalTotal);
    return;
  }

  const today = new Date().toISOString().split("T")[0];

  if (voucher && input.toUpperCase() === (voucher.code || "").toUpperCase() && today <= voucher.expiry) {
    const discountPercent = parseFloat(voucher.discount) || 0;
    const potongan = originalTotal * (discountPercent / 100);
    const discounted = originalTotal - potongan;

    totalEl.innerText = formatCurrency(originalTotal);
    totalEl.dataset.raw = String(discounted);

    msg.innerText = `âœ… Voucher valid! Diskon ${discountPercent}% diterapkan`;
    msg.style.color = "green";

    if (discountEl) {
      discountEl.parentElement.style.display = "flex";
      discountEl.innerText = `${formatCurrency(potongan)}`;
    }

    grandEl.innerText = formatCurrency(discounted);
  } else {
    totalEl.innerText = formatCurrency(originalTotal);
    totalEl.dataset.raw = String(originalTotal);

    msg.innerText = "âŒ Voucher Code is invalid or expired";
    msg.style.color = "red";

    if (discountEl) {
      discountEl.parentElement.style.display = "none";
      discountEl.innerText = "";
    }

    grandEl.innerText = formatCurrency(originalTotal);
  }
}

// === Attach event multiple biar aman di HP/desktop ===
document.addEventListener("DOMContentLoaded", () => {
  const voucherInput = document.getElementById("voucherInput");
  if (voucherInput) {
    ["input", "keyup", "change", "blur"].forEach(evt => {
      voucherInput.addEventListener(evt, autoApplyVoucher);
    });
  }
});
</script>
</body>
</html>

