<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Dine-In Book</title>
  
  <style>
    /* =====================
       THEME (Light / Dark) & ROOT VARS
       ===================== */
    :root{
      --bg: #f4f8ff;
      --surface: #ffffff;
      --text: #1f2a44;
      --muted: #6b7a99;
      --border: #d8e1ff;
      --brand: #1f70ff;
      --brand-2: #2a5298;
      --brand-3: #1e3c72;
      --chip: #eef4ff;
      --danger: #e54646;
      --success: #25d366;
      --shadow: 0 6px 24px rgba(0,0,0,.08);
      --qty-btn-bg: #eef4ff;
      --qty-btn-text: #1f2a44;
      --container-max: 1200px;
       --fixed-bar-height: 70px;
    }
    body.dark-mode{
      --bg: #0e1116;
      --surface: #141922;
      --text: #e6ebff;
      --muted: #aab6db;
      --border: #263148;
      --brand: #4da3ff;
      --chip: #0f1a2a;
      --shadow: 0 8px 28px rgba(0,0,0,.5);
      --qty-btn-bg: #263148;
      --qty-btn-text: #e6ebff;
    }

    /* =====================
       BASE
       ===================== */
    *{box-sizing:border-box}
    html,body{height:100%}
body {
  margin: 0;
  font-family: Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
  background: var(--bg);
  color: var(--text);
  transition: background .25s, color .25s;
  padding-bottom: var(--fixed-bar-height); /* ruang kosong sesuai tinggi fixbar */
}

    img{max-width:100%;display:block}
    .container{max-width:var(--container-max);margin:0 auto;padding:0 16px}

    /* HEADER */
    header{
      width:100%;
      background: linear-gradient(90deg,var(--brand-2),var(--brand-3));
      color:#fff;
      padding:16px;
      position:relative;
      box-shadow:var(--shadow);
    }
    .header-inner{
      display:flex;
      justify-content:space-between;
      align-items:stretch;
      gap:12px;
    }
    .header-left{
      display:flex;
      flex-direction:column;
      gap:6px;
      flex:1;
      min-width:0;
    }
    #restoLogo{height:60px;width:60px;object-fit:contain;border-radius:8px;background:rgba(255,255,255,.1);flex-shrink:0;margin-bottom:4px}
    .resto-info{display:flex;flex-direction:column;text-align:left;gap:2px}
    #restoName{margin:0;font-size:16px;font-weight:800;color:#fff;line-height:1.2;word-break:break-word}
    .contact-info{font-size:12px;opacity:.95;margin:0;line-height:1.2}
    #teleponRestoranDisplay{color:#fff;font-weight:500;margin:0}

    .header-right{
      display:flex;
      flex-direction:column;
      justify-content:space-between;
      align-items:flex-end;
      flex:0 0 auto;
      gap:8px;
    }
    .dark-toggle{
      background: rgba(255,255,255,0.12);
      border: none;
      font-size:1.2rem;
      cursor:pointer;
      color: #fff;
      padding:4px 6px;
      border-radius:6px;
    }
    .locale-select{
      padding:4px 6px;border-radius:6px;border:none;background:rgba(255,255,255,0.12);color:#fff;font-weight:600;font-size:12px;max-width:140px;
    }

    /* TABS */
    .tabs-wrap{background:var(--surface);top:96px;z-index:40;box-shadow:var(--shadow)}
    .tabs{display:flex;gap:8px;padding:10px;justify-content:center;flex-wrap:wrap}
    .tab{padding:8px 14px;border:1px solid var(--border);border-radius:999px;background:var(--chip);color:var(--text);cursor:pointer;font-weight:600}
    .tab.active{background:var(--brand);color:#fff;border-color:var(--brand)}

    .tab-content{display:none;padding:20px 0}
    .tab-content.active{display:block}
    .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:16px}

    /* menu card */
    .menu-card{
      background:var(--surface);border:1px solid var(--border);border-radius:8px;box-shadow:var(--shadow);padding:8px;display:flex;flex-direction:column;gap:6px;cursor:pointer;transition:transform .12s;
    }
    .menu-card:hover{transform:translateY(-4px)}
    .menu-thumb{aspect-ratio:1/1;height:auto;border-radius:8px;object-fit:cover;background:#e9eefc}
    .menu-title{font-weight:700;font-size:14px;text-align:center;margin:2px 0 0 0}
    .menu-desc{font-size:12px;color:var(--muted);text-align:center}
    .menu-price{font-size:13px;font-weight:800;text-align:center;margin-top:4px}
    
    /* Badge khusus di menu card */
.menu-card {
  position: relative; /* supaya badge bisa nempel relatif ke card */
}

.menu-card .badge {
  position: absolute;
  top: 8px;       /* jarak dari atas card */
  right: 8px;     /* jarak dari kanan card */
  background-color: #007bff; /* biru elegan */
  color: white;
  font-size: 12px;
  font-weight: bold;
  width: 20px;
  height: 20px;
  border-radius: 50%; /* bikin bulat */
  display: flex;
  align-items: center;
  justify-content: center;
  box-shadow: 0 0 2px rgba(0,0,0,0.3);
}
   .promo-card {
  position: relative; /* supaya anak absolute bisa nempel di dalam card */
}
  .promo-card {
  position: relative;
  background: #fff8e1;
  border-radius: 12px;
  box-shadow: 0 2px 5px rgba(0,0,0,0.1);
  padding: 16px;
  text-align: center; /* ‚ú® Biar semua isi di tengah */
  overflow: hidden;
}
.promo-card:hover { transform: translateY(-4px); }

.promo-card img,
.promo-card .menu-thumb {
  aspect-ratio: 1/1;
  border-radius: 8px;
  object-fit: cover;
  background: #e9eefc;
}

.promo-name {
  font-weight: 700;
  font-size: 14px;
  text-align: center;
  margin: 2px 0 0 0;
}
.promo-desc {
  font-size: 14px;
  color: #444;
  text-align: center; /* üß≠ pastikan deskripsi center */
  margin: 4px 0 10px;
}
.promo-price {
  font-size: 13px;
  font-weight: 800;
  text-align: center;
  margin-top: 4px;
}

.promo-badge {
  position: absolute;
  top: 10px;
  left: 10px;
  background: #ffcc00;
  color: #222;
  font-weight: 800;
  font-size: 13px;
  padding: 4px 10px;
  border-radius: 999px;
  text-transform: uppercase;
  box-shadow: 0 2px 6px rgba(0,0,0,.25);
  z-index: 5;
}
    /* === FIX TEKS PROMO UNTUK DARK MODE === */
.promo-card {
  background: var(--surface);
  color: var(--text);
  border: 1px solid var(--border);
}

.promo-desc {
  color: var(--muted);
}

.promo-name,
.promo-price {
  color: var(--text);
}

body.dark-mode .promo-card {
  background: var(--surface);
  box-shadow: 0 2px 6px rgba(0,0,0,0.5);
}

body.dark-mode .promo-badge {
  background: #ffcc00;
  color: #111;
}

    /* CART / FOOTER */
 footer {
  background: var(--surface);
  margin-top: 24px;
  box-shadow: var(--shadow);
  padding-bottom: calc(var(--fixed-bar-height) + 20px); /* kasih extra biar lebih lega */
}

    .footer-inner{padding:18px 0 24px;}
    .cart{border:1px solid var(--border);border-radius:16px;padding:12px;background:var(--surface)}
    .cart h3{margin:6px 6px 10px;font-size:18px;position:relative;padding-right:56px} 
    .cart-empty{color:var(--muted);padding:8px}

    .order-count{
      position:absolute;
      top:6px;
      right:6px;
      background:var(--brand);
      color:#fff;
      font-size:12px;
      font-weight:800;
      padding:4px 8px;
      border-radius:999px;
      display:none;
    }

    .cart-row{display:grid;grid-template-columns:1fr 76px 92px 28px;gap:8px;align-items:center;padding:6px 8px;border-bottom:1px dashed var(--border)}
    .cart-row:last-child{border-bottom:none}
    .qty-wrap{display:inline-flex;border:1px solid var(--border);border-radius:999px;overflow:hidden}
    .qty-wrap button{width:28px;height:28px;border:0;background:var(--qty-btn-bg);color:var(--qty-btn-text);cursor:pointer;font-weight:800;border-radius:6px}
    .qty-wrap input{width:36px;text-align:center;border:0;background:transparent;color:var(--text);font-weight:700}
    .price-right{text-align:right;font-weight:700}
    .remove-btn{border:0;background:transparent;color:var(--danger);font-size:18px;cursor:pointer}

    /* summary (vertical) */
    .cart-total{margin-top:15px;display:flex;flex-direction:column;gap:6px;padding-top:6px;border-top:1px solid var(--border);font-weight:800}
    .total-row{display:flex;justify-content:space-between;width:100%;align-items:center}
    .grand-total{font-size:1rem}

    /* FORM */
    .form{margin-top:18px;display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .form label{display:block;font-weight:700;font-size:13px;margin-bottom:4px;color:var(--muted)}
    .form input,.form textarea{width:100%;padding:10px 12px;border-radius:10px;border:1px solid var(--border);background:var(--surface);color:var(--text)}
    .form textarea{grid-column:1/-1;min-height:80px;resize:vertical}

    .actions{display:flex;gap:10px;margin-top:12px}
    .btn{flex:1;padding:12px;border-radius:12px;border:0;cursor:pointer;font-weight:800}
    .btn-wa{background:var(--success);color:#fff}
    .btn-back{background:#f39c12;color:#fff}

/* fixed bottom bar */
.fixed-bar {
  position: fixed;
  bottom: 0;
  left: 0;
  width: 100%;
  height: var(--fixed-bar-height); /* tinggi fixbar konsisten */
  background: var(--surface);      /* jangan dihapus, biar fixbar kelihatan */
  display: flex;
  align-items: center; /* tombol selalu sejajar tengah */
  justify-content: space-between;
  gap: 10px;
  padding: 0 12px;     /* horizontal padding aja */
  z-index: 100;
}

.fixed-bar button {
  flex: 1;
  height: 46px;
  font-size: 15px;
  font-weight: 700;
  border-radius: 8px;
  border: 0;
  cursor: pointer;
}

.btn-wa {
  background: var(--brand-2);
  color: #fff;
}
.btn-back {
  background: #ddd;
  color: #222;
}
    /* voucher UI */
    .voucher-box{display:flex;gap:8px;justify-content:flex-start}
    .voucher-box input{width:220px;max-width:60%;padding:8px;border:1px solid #ccc;border-radius:6px}
    #voucherMessage{margin-top:8px;font-size:0.9em;color:var(--muted);}

    /* responsive tweaks */
    @media (max-width:640px){
      .form{grid-template-columns:1fr}
      .cart-row{grid-template-columns:1fr 84px 84px 28px}
      #restoLogo{height:44px;width:44px}
    }

  .toast {
    position: fixed;
    left: 50%;
    transform: translateX(-50%);
    background: rgba(30, 60, 114, 0.95);
    color: #fff;
    padding: 14px 22px;
    border-radius: 10px;
    font-size: 15px;
    font-weight: 500;
    z-index: 9999;
    box-shadow: 0 3px 10px rgba(0,0,0,0.3);
    animation: fadeInOut 3s ease forwards;
  }

  .toast.success {
    background: #2e7d32;
  }

  .toast.info {
    background: #1565c0;
  }

  .toast-top {
    top: 20%;
  }

  .toast-bottom {
    bottom: 20%;
  }

  @keyframes fadeInOut {
    0% { opacity: 0; transform: translate(-50%, -10px); }
    10% { opacity: 1; transform: translate(-50%, 0); }
    90% { opacity: 1; transform: translate(-50%, 0); }
    100% { opacity: 0; transform: translate(-50%, 10px); }
  }
    .fade-in {
  animation: fadeIn 0.3s ease forwards;
}
.fade-out {
  animation: fadeOut 0.3s ease forwards;
}

@keyframes fadeIn {
  from { opacity: 0; transform: translateY(6px); }
  to { opacity: 1; transform: translateY(0); }
}

@keyframes fadeOut {
  from { opacity: 1; transform: translateY(0); }
  to { opacity: 0; transform: translateY(6px); }
}

  </style>

</head>
<body>
<header>
  <div class="header-inner container">
    <div class="header-left">
      <img id="restoLogo" alt="Logo" />
      <div class="resto-info">
        <h1 id="restoName">Nama Restoran</h1>
        <div class="contact-info">
          <div id="alamatRestoranDisplay"></div>
          <div id="teleponRestoranDisplay"></div>
        </div>
      </div>
    </div>

    <div class="header-right">
     <button 
  type="button" 
  class="dark-toggle" 
  id="darkToggle" 
  title="Toggle theme">üåô
</button>

     <select id="localeSelect" name="localeSelect" class="locale-select" title="Change locale / currency">
        <option value="auto">Auto (browser)</option>
        <option value="en-US|USD">US ‚Äî USD</option>
        <option value="id-ID|IDR">INA ‚Äî IDR</option>
        <option value="en-GB|GBP">UK ‚Äî GBP</option>
        <option value="de-DE|EUR">Germany ‚Äî EUR</option>
        <option value="ja-JP|JPY">Japan ‚Äî JPY</option>
        <option value="zh-CN|CNY">China ‚Äî CNY</option>
        <option value="fr-FR|EUR">France ‚Äî EUR</option>
      </select>
    </div>
  </div>
</header>

<div class="tabs-wrap">
  <div class="container">
    <div class="tabs">
      <div class="tab active" onclick="switchTab('food')">Food</div>
      <div class="tab" onclick="switchTab('snack')">Snack & Dessert</div>
      <div class="tab" onclick="switchTab('drink')">Drink</div>
      <div class="tab" onclick="switchTab('special')">Special</div>
      <div class="tab" onclick="switchTab('promo')">Promo</div>
    </div>
  </div>
</div>

<main class="container" style="padding-top:12px">
  <section id="food" class="tab-content active"><div class="grid" id="foodGrid"></div></section>
  <section id="snack" class="tab-content"><div class="grid" id="snackGrid"></div></section>
  <section id="drink" class="tab-content"><div class="grid" id="drinkGrid"></div></section>
  <section id="special" class="tab-content"><div class="grid" id="specialGrid"></div></section>
  <section id="promo" class="tab-content"><div class="grid" id="promoGrid"></div></section>
</main>

<footer>
  <div class="container footer-inner">
    <div class="cart" id="cartBox">
      <h3>üõí Your Cart</h3>

      <!-- Voucher selalu tampil -->
      <div id="voucherSection" style="margin:15px 0;">
        <div class="voucher-box">
          <input 
            type="text" 
            id="voucherInput" 
            name="voucherInput"
            placeholder="Use Voucher Code"
          >
        </div>
        <p id="voucherMessage"></p>
      </div>

      <div id="cartRows" class="cart-rows"></div>
      <div id="cartEmpty" class="cart-empty">No items choice</div>

      <div class="cart-total">
        <div class="total-row">
          <span>Total Price</span>
          <span id="cartTotal">0</span>
        </div>
        <div class="total-row" id="discountRow" style="display:none; color:green;">
          <span>Discount</span>
          <span id="voucherDiscount">0</span>
        </div>
        <div class="total-row grand-total">
          <span>Grand Total</span>
          <span id="grandTotal">0</span>
        </div>
      </div>
    </div> <!-- tutup cart -->

    <!-- form masih di dalam container yang sama -->
    <div class="form" style="margin-top:12px">
      <div>
        <label for="custName">Customer Name</label>
        <input type="text" id="custName" name="custName" placeholder="e.g. John Doe">
      </div>
      <div>
        <label for="custTable">Table No</label>
        <input type="text" id="custTable" name="custTable" placeholder="e.g. A12">
      </div>
      <div>
        <label for="custDate">Date</label>
        <input type="text" id="custDate" name="custDate" readonly>
      </div>
      <div>
        <label for="custTime">Time</label>
        <input type="text" id="custTime" name="custTime" readonly>
      </div>
      <div style="grid-column:1/-1">
        <label for="custNote">Special Request / Notes</label>
        <textarea id="custNote" name="custNote" placeholder="e.g. no spicy, extra sauce"></textarea>
      </div>
    </div>

    <!-- Toast -->
<div id="toast" class="toast"></div>

<!-- Suara -->
<audio id="sound-success" preload="auto">
  <source src="https://actions.google.com/sounds/v1/cartoon/clang_and_wobble.ogg" type="audio/ogg">
</audio>
<audio id="sound-error" preload="auto">
  <source src="https://actions.google.com/sounds/v1/alarms/beep_short.ogg" type="audio/ogg">
</audio>

<button id="clearDataBtn" class="danger-btn" style="background:#c62828;color:#fff;border:none;padding:10px 16px;border-radius:8px;margin-top:8px;">
  üóëÔ∏è Hapus Data
</button>

    <div class="fixed-bar">
      <button class="btn btn-wa" id="btnSend" onclick="sendOrder()">üì§ Submit Order</button>
      <button class="btn btn-back" onclick="history.back()">üîô Back</button>
    </div>
  </div> <!-- tutup container -->
</footer>

  <script>
(async () => {
  /* =========================
     CONFIG / SHARED STATE
     ========================= */
  const DB_NAME = 'MenuvaDB';
  const STORE_NAME = 'menuvaData';
  const LOCALE_KEY = 'menuva_localeChoice';
  const DB_VERSION = 10;

  let db = null;                 // IndexedDB instance
  let menuData = [];
  let menuPromo = [];
  let restoData = {};
  let cart = [];
  let activeVoucherData = null;  // object voucher aktif (null jika none)
  let promoCountdownTimer = null;

  /* ---------------------
     LOCALE / CURRENCY HELPERS
     --------------------- */
  const localeToCurrencyFallback = {
    'id': 'IDR','en-US': 'USD','en': 'USD','en-GB': 'GBP','de': 'EUR','fr': 'EUR','ja': 'JPY','zh': 'CNY'
  };

  function parseLocaleCurrency(value) {
    if (!value || value === 'auto') return { mode: 'auto' };
    const parts = String(value).split('|');
    return { mode: 'manual', locale: parts[0] || '', currency: parts[1] || '' };
  }

  function detectBrowserLocaleCurrency() {
    const locale = navigator.language || 'en-US';
    let currency = localeToCurrencyFallback[locale.split('-')[0]] || localeToCurrencyFallback[locale] || 'IDR';
    if (localeToCurrencyFallback[locale]) currency = localeToCurrencyFallback[locale];
    return { locale, currency };
  }

  function getActiveLocaleCurrency() {
    const saved = localStorage.getItem(LOCALE_KEY) || 'auto';
    const parsed = parseLocaleCurrency(saved);
    if (parsed.mode === 'auto') return detectBrowserLocaleCurrency();
    return {
      locale: parsed.locale || detectBrowserLocaleCurrency().locale,
      currency: parsed.currency || detectBrowserLocaleCurrency().currency
    };
  }

  function saveLocaleChoice(value) { localStorage.setItem(LOCALE_KEY, value); }

  function formatPrice(amount, currency, locale) {
    if (!isFinite(Number(amount))) amount = 0;
    amount = Number(amount);
    const zeroFractionCurrencies = ['IDR', 'JPY', 'KRW'];
    const opts = {
      style: 'currency',
      currency: currency || 'IDR',
      maximumFractionDigits: zeroFractionCurrencies.includes((currency || '').toUpperCase()) ? 0 : 2,
      minimumFractionDigits: zeroFractionCurrencies.includes((currency || '').toUpperCase()) ? 0 : 2
    };
    try { return new Intl.NumberFormat(locale || undefined, opts).format(amount); }
    catch (e) { return (currency ? currency + ' ' : '') + amount.toLocaleString(); }
  }

  function formatWithActive(amount) {
    const ac = getActiveLocaleCurrency();
    return formatPrice(amount, ac.currency, ac.locale);
  }

  /* ---------------------
     GENERIC HELPERS
     --------------------- */
  function escapeHtml(str) {
    if (str === null || str === undefined) return '';
    return String(str)
      .replace(/&/g,'&amp;')
      .replace(/"/g,'&quot;')
      .replace(/'/g,'&#39;')
      .replace(/</g,'&lt;')
      .replace(/>/g,'&gt;');
  }

  function cleanNumber(val){
    if (val == null) return 0;
    return parseFloat(String(val).replace(/[^0-9.-]/g,'')) || 0;
  }

  function getQueryRestoId() {
    const p = new URLSearchParams(window.location.search);
    return p.get('resto') || null;
  }

  /* =========================
     INDEXEDDB: init, getDB helpers
     ========================= */
  function initDB() {
    return new Promise((resolve, reject) => {
      if (db) return resolve(db);
      const request = indexedDB.open(DB_NAME, DB_VERSION);

      request.onerror = (e) => {
        console.warn('‚ö†Ô∏è IndexedDB open error', e.target?.error || e);
        // don't reject hard ‚Äî caller will handle fallback
        reject(e.target?.error || e);
      };

      request.onblocked = () => {
        console.warn("‚ö†Ô∏è DB upgrade blocked. Tutup tab lain yang masih pakai DB ini.");
      };

      request.onupgradeneeded = (e) => {
        const idb = e.target.result;
        if (!idb.objectStoreNames.contains(STORE_NAME)) {
          idb.createObjectStore(STORE_NAME, { keyPath: "id", autoIncrement: true });
        }
        if (!idb.objectStoreNames.contains("ordersData")) {
          const orders = idb.createObjectStore("ordersData", { keyPath: "id", autoIncrement: true });
          orders.createIndex("status", "status", { unique: false });
          orders.createIndex("orderTime", "orderTime", { unique: false });
        }
      };

      request.onsuccess = (e) => {
        db = e.target.result;
        resolve(db);
      };
    });
  }

  async function getDB() {
    if (db) return db;
    try {
      return await initDB();
    } catch (err) {
      // bubble up
      throw err;
    }
  }

  /* =========================
     DATA LOAD: loadDataFromDB (menu/resto)
     ========================= */
  function loadDataFromDB(restoId) {
    return new Promise(async (resolve) => {
      try {
        const database = await getDB();
        if (!database) return resolve(null);
        if (!database.objectStoreNames.contains(STORE_NAME)) return resolve(null);

        const tx = database.transaction(STORE_NAME, "readonly");
        const store = tx.objectStore(STORE_NAME);
        const req = store.getAll();

        req.onsuccess = () => {
          const all = req.result || [];
          if (!all.length) return resolve(null);

          if (restoId) {
            const found = all.find(r =>
              r?.restoId === restoId ||
              r?.restoPhone === restoId ||
              r?.id === Number(restoId)
            );
            if (found) return resolve(found);
          }
          resolve(all[0]);
        };

        req.onerror = () => resolve(null);
      } catch (err) {
        // can't open DB
        console.warn('‚ö†Ô∏è loadDataFromDB fail', err);
        resolve(null);
      }
    });
  }

  /* =========================
     CART RELATED
     ========================= */
  function updateCartCount() {
    const el = document.getElementById('cartCount');
    if (!el) return;
    const totalItems = cart.reduce((s,i)=> s + (Number(i.qty)||0), 0);
    if (totalItems > 0) { el.style.display = 'inline-block'; el.textContent = totalItems; }
    else el.style.display = 'none';
  }

  function refreshAllPriceDisplays(){
    document.querySelectorAll('.menu-price').forEach(el=>{
      const p = Number(el.dataset.price) || 0;
      el.textContent = formatWithActive(p);
    });
    // update cart totals formatting too
    try { applyVoucherAndUpdateSummary(); } catch(e){}
  }

  function renderCart() {
    const rows = document.getElementById('cartRows');
    const empty = document.getElementById('cartEmpty');
    if (!rows || !empty) return;
    rows.innerHTML = '';

    if (!cart || cart.length === 0) {
      empty.style.display = 'block';
      const cartTotalEl = document.getElementById('cartTotal');
      const grandTotalEl = document.getElementById('grandTotal');
      if (cartTotalEl) { cartTotalEl.dataset.raw = 0; cartTotalEl.textContent = formatWithActive(0); }
      if (grandTotalEl) { grandTotalEl.dataset.raw = 0; grandTotalEl.textContent = formatWithActive(0); }
      const discountRow = document.getElementById('discountRow');
      if (discountRow) discountRow.style.display = 'none';
      updateCartCount();

      // simpan kondisi cart kosong ke storage
      saveCartToStorage();
      restoreVoucherFromStorage();
      return;
    }

    empty.style.display = 'none';
    let total = 0;
    cart.forEach((c,i)=>{
      const subtotal = (Number(c.harga)||0) * (Number(c.qty)||0);
      total += subtotal;

      const row = document.createElement('div');
      row.className = 'cart-row';
      row.innerHTML = `
        <div>
          <strong>${escapeHtml(c.nama)}</strong>
          <div style="font-size:12px;color:var(--muted)">${formatWithActive(c.harga)} √ó ${c.qty}</div>
        </div>
        <div class="qty-wrap">
          <button type="button" onclick="window._menuva.updateQty(${i}, -1)">-</button>
          <input 
            type="text" 
            id="cart-qty-${i}" 
            name="cart-qty-${i}" 
            value="${c.qty}" 
            readonly 
          />
          <button type="button" onclick="window._menuva.updateQty(${i}, 1)">+</button>
        </div>
        <div class="price-right">${formatWithActive(subtotal)}</div>
        <button class="remove-btn" title="Remove" onclick="window._menuva.removeFromCart(${i})">‚úï</button>
      `;
      rows.appendChild(row);
    });

    const cartTotalEl = document.getElementById('cartTotal');
    if (cartTotalEl) cartTotalEl.dataset.raw = String(total);

    refreshAllPriceDisplays();
    updateCartCount();

    // ‚úÖ simpan cart setiap kali render ulang
    saveCartToStorage();
    restoreVoucherFromStorage();
    applyVoucherAndUpdateSummary();
  }

  function addToCartObj(name, price) {
    const idx = cart.findIndex(i => i.key === name);
    if (idx >= 0) cart[idx].qty += 1;
    else cart.push({ key: name, nama: name, harga: Number(price) || 0, qty: 1 });
    renderCart();
  }

  function updateQty(index, delta) {
    if (!cart[index]) return;
    cart[index].qty += delta;
    if (cart[index].qty <= 0) cart.splice(index,1);
    renderCart();
  }

  function removeFromCart(index) {
    if (!cart[index]) return;
    cart.splice(index, 1);
    renderCart();
    saveCartToStorage(); // pastikan tersimpan ulang

    // kalau cart kosong, bersihkan voucher juga
    if (cart.length === 0) {
      activeVoucherData = null;
      localStorage.removeItem('menuva_voucher');
      applyVoucherAndUpdateSummary();
    }
  }

  window._menuva = window._menuva || {};
  window._menuva.addToCart = addToCartObj;
  window._menuva.updateQty = updateQty;
  window._menuva.removeFromCart = removeFromCart;
  window._menuva.getActiveLocaleCurrency = getActiveLocaleCurrency;
  window._menuva.formatWithActive = formatWithActive;
  window._menuva.refreshAllPriceDisplays = refreshAllPriceDisplays;

  /* =========================
     PROMO / MENU RENDER
     ========================= */
  function renderMenu() {
    const map = { food:'foodGrid', snack:'snackGrid', drink:'drinkGrid', special:'specialGrid' };
    Object.keys(map).forEach(k=>{
      const grid = document.getElementById(map[k]);
      if (!grid) return;
      grid.innerHTML = '';
      const items = (menuData || []).filter(m => m.kategori === k);
      if (!items || items.length ===0) {
        grid.innerHTML = '<div class="cart-empty">No item yet</div>';
        return;
      }
      items.forEach(m=>{
        const card = document.createElement('div');
        card.className = 'menu-card';
        card.onclick = () => { addToCartObj(m.nama, Number(m.harga)||0); updateBadge(card, m.nama); };
        const hargaNum = Number(m.harga) || 0;
        card.innerHTML = `
          ${m.image ? `<img class="menu-thumb" src="${m.image}" alt="${escapeHtml(m.nama)}">` : `<div class="menu-thumb"></div>`}
          <div class="menu-title">${escapeHtml(m.nama)}</div>
          <div class="menu-desc">${escapeHtml(m.deskripsi || '')}</div>
          <div class="menu-price" data-price="${hargaNum}">${formatWithActive(hargaNum)}</div>
          <span class="badge" style="display:none">0</span>
        `;
        grid.appendChild(card);
      });
    });
  }

  function renderPromo(list) {
    const grid = document.getElementById('promoGrid');
    if (!grid) return;
    grid.innerHTML = '';

    const promos = (list && list.length ? list : menuPromo || []).filter(p => {
      const now = Date.now();
      if (!p.tanggalAkhir) return true;
      const end = new Date(p.tanggalAkhir).getTime();
      return isFinite(end) ? end > now : true;
    });

    if (!promos.length) {
      grid.innerHTML = '<div class="cart-empty">No promo choice</div>';
      stopPromoCountdown?.();
      return;
    }

    promos.forEach(p => {
      const card = document.createElement('div');
      card.className = 'promo-card';
      card.style.position = 'relative';

      const endAttr = p.tanggalAkhir ? `data-end="${p.tanggalAkhir}"` : '';

      card.innerHTML = `
        ${p.image ? `<img src="${p.image}" class="promo-thumb">` : ''}
        <div class="promo-title">${escapeHtml(p.namaPromo || p.namaMenu)}</div>
        <div class="promo-desc">${escapeHtml(p.deskripsi || '')}</div>
        <div class="promo-price">${formatWithActive(p.harga || 0)}</div>
        <div class="promo-count" ${endAttr}></div>
      `;

      const badgeLabel = document.createElement('div');
      badgeLabel.className = 'promo-badge';
      badgeLabel.textContent = (p.kategori || 'PROMO').toUpperCase();
      card.appendChild(badgeLabel);

      const badgeCount = document.createElement('div');
      badgeCount.className = 'promo-click-badge';
      badgeCount.textContent = '0';
      Object.assign(badgeCount.style, {
        position: 'absolute', top: '6px', right: '6px', background: '#ff3b30',
        color: '#fff', fontWeight: 'bold', borderRadius: '50%', width: '22px', height: '22px',
        display: 'none', justifyContent: 'center', alignItems: 'center', fontSize: '13px',
        boxShadow: '0 2px 6px rgba(0,0,0,0.2)', zIndex: '2'
      });
      card.appendChild(badgeCount);

      let count = 0;
      card.onclick = () => {
        addToCartObj(p.namaPromo || p.namaMenu, p.harga);
        count++;
        badgeCount.textContent = count;
        badgeCount.style.display = 'flex';
        try { badgeCount.animate([{ transform: 'scale(1.3)' }, { transform: 'scale(1)' }], { duration: 200 }); } catch(e){}
      };

      grid.appendChild(card);
    });

    startPromoCountdown?.();
  }

  function updateBadge(cardEl, itemName) {
    try {
      const badge = cardEl.querySelector('.badge');
      if (!badge) return;
      const cartItem = cart.find(c => c.nama === itemName);
      if (!cartItem) { badge.style.display = 'none'; return; }
      badge.textContent = cartItem.qty;
      badge.style.display = 'flex';
    } catch(e){}
  }

  function startPromoCountdown(){
    stopPromoCountdown();
    promoCountdownTimer = setInterval(()=>{
      document.querySelectorAll('.promo-count[data-end]').forEach(el=>{
        const end = new Date(el.dataset.end).getTime();
        if (!isFinite(end)) { el.textContent=''; return; }
        const diff = end - Date.now();
        if (diff <= 0) { el.textContent='Expired'; return; }
        const d = Math.floor(diff/86400000);
        const h = Math.floor((diff%86400000)/3600000);
        const m = Math.floor((diff%3600000)/60000);
        const s = Math.floor((diff%60000)/1000);
        el.textContent = `Ends in ${d}d ${h}h ${m}m ${s}s`;
      });
    }, 1000);
  }
  function stopPromoCountdown(){ if (promoCountdownTimer){ clearInterval(promoCountdownTimer); promoCountdownTimer = null; } }

  /* ============================================================
     VOUCHER SYSTEM (ROBUST)
     - load from DB (menuvaData -> menuVoucher)
     - fallback to localStorage keys
     - normalize a lot of possible voucher field names
     - cache results
     ============================================================ */

  let cachedVoucherList = null;

  // read voucher array from DB (id=1) safely
  async function loadVoucherListFromDB() {
    try {
      const database = await getDB();
      if (!database) throw new Error('no-db');
      if (!database.objectStoreNames.contains(STORE_NAME)) return [];
      const tx = database.transaction(STORE_NAME, 'readonly');
      const store = tx.objectStore(STORE_NAME);

      return await new Promise((resolve) => {
        const req = store.get(1);
        req.onsuccess = () => {
          const row = req.result;
          if (!row) return resolve([]);
          // possible names: menuVoucher, menu_voucher, voucherList, vouchers
          const candidates = ['menuVoucher','menu_voucher','voucherList','vouchers','voucher','menuVoucherList'];
          for (const k of candidates) {
            if (Array.isArray(row[k]) && row[k].length) return resolve(row[k]);
          }
          // maybe saved under 'menu' or another structure - try to detect voucher-like objects
          // scan object properties for arrays that look like voucher arrays
          for (const key of Object.keys(row)) {
            const val = row[key];
            if (Array.isArray(val) && val.length && val.every(it => typeof it === 'object')) {
              // quick heuristic: contains at least one voucher-like field
              if (val.some(it => it.code || it.kodeVoucher || it.kode || it.kod || it.voucherCode || it.discount)) {
                return resolve(val);
              }
            }
          }
          resolve([]);
        };
        req.onerror = () => resolve([]);
      });
    } catch (err) {
      console.warn('‚ö†Ô∏è loadVoucherListFromDB failed:', err);
      return [];
    }
  }

  // fallback to localStorage keys
  function loadVoucherListFromLocalStorage() {
    const keys = ['menuVoucher','voucher','menuva_voucher','vouchers','voucherList'];
    for (const k of keys) {
      try {
        const raw = localStorage.getItem(k);
        if (!raw) continue;
        const parsed = JSON.parse(raw);
        if (Array.isArray(parsed) && parsed.length) return parsed;
        if (parsed && typeof parsed === 'object') return [parsed];
      } catch(e){}
    }
    return [];
  }

  // normalize voucher object (map many possible fields to canonical ones)
  function normalizeVoucher(v) {
    if (!v || typeof v !== 'object') return null;
    const obj = {};
    obj.code = String(v.code || v.kodeVoucher || v.kode || v.voucherCode || v.codeVoucher || v.kod || v.k).trim();
    // discount percent
    obj.discount = Number(v.discount ?? v.diskon ?? v.persen ?? v.pct ?? 0) || 0;
    // expiry
    const expiryRaw = v.expiry || v.tanggalAkhir || v.exp || v.validUntil || v.valid_thru || v.berlakuSampai || v.expired;
    if (expiryRaw) {
      const d = new Date(expiryRaw);
      obj.expiry = isFinite(d.getTime()) ? d.toISOString() : null;
    } else obj.expiry = null;
    // keep original raw object
    obj._raw = v;
    return obj;
  }

  async function ensureVoucherLoaded() {
    if (Array.isArray(cachedVoucherList)) return cachedVoucherList;

    // try DB first
    let list = [];
    try {
      list = await loadVoucherListFromDB();
    } catch(e) { list = []; }

    // fallback to LS
    if (!Array.isArray(list) || list.length === 0) {
      const fromLS = loadVoucherListFromLocalStorage();
      if (Array.isArray(fromLS) && fromLS.length) list = fromLS;
    }

    // normalize entries
    cachedVoucherList = (Array.isArray(list) ? list.map(normalizeVoucher).filter(Boolean) : []);
    console.log('üì¶ Voucher loaded/cached:', cachedVoucherList);
    return cachedVoucherList;
  }

  // synchronous accessor for list (returns empty array if not loaded yet)
  function getActiveVoucherList() {
    return Array.isArray(cachedVoucherList) ? cachedVoucherList : [];
  }

  // find voucher (case-insensitive), respects expiry if present
  function findVoucherSync(codeInput) {
    if (!codeInput) return null;
    const code = String(codeInput).trim().toLowerCase();
    const list = getActiveVoucherList();
    if (!list.length) return null;
    const now = Date.now();
    return list.find(v => {
      if (!v || !v.code) return false;
      if (String(v.code).trim().toLowerCase() !== code) return false;
      if (v.expiry) {
        const t = Date.parse(v.expiry);
        if (!isFinite(t)) return true; // can't parse expiry ‚Üí assume valid
        return t >= now;
      }
      return true;
    }) || null;
  }

  /* -------------------------
     UI: voucher input & apply
     ------------------------- */

  function applyVoucherAndUpdateSummary() {
    const cartTotalEl = document.getElementById('cartTotal');
    const grandTotalEl = document.getElementById('grandTotal');
    const discountRow = document.getElementById('discountRow');
    const voucherDiscountEl = document.getElementById('voucherDiscount');
    const inputCode = (document.getElementById('voucherInput')?.value || '').trim();

    const rawTotal = (cartTotalEl && cartTotalEl.dataset && cleanNumber(cartTotalEl.dataset.raw)) ? cleanNumber(cartTotalEl.dataset.raw) : 0;
    let discount = 0;

    const voucher = findVoucherSync(inputCode);

    let voucherValid = false;
    if (voucher) {
      const pct = Number(voucher.discount) || 0;
      discount = rawTotal * (pct / 100);
      voucherValid = true;
      activeVoucherData = voucher;
      try { showToast && showToast(`üéâ Voucher ${voucher.code} aktif! Diskon ${pct}%`, 'success'); } catch(e){}
    } else if (inputCode) {
      activeVoucherData = null;
      try { showToast && showToast('‚ùå Kode voucher salah atau kadaluarsa.', 'error'); } catch(e){}
    }

    const newTotal = Math.max(0, rawTotal - discount);

    if (cartTotalEl) cartTotalEl.textContent = formatWithActive ? formatWithActive(rawTotal) : rawTotal;
    if (voucherDiscountEl) voucherDiscountEl.textContent = formatWithActive ? formatWithActive(discount) : discount;
    if (grandTotalEl) grandTotalEl.textContent = formatWithActive ? formatWithActive(newTotal) : newTotal;

    if (discountRow) {
      if (voucherValid && discount > 0) {
        discountRow.style.display = 'flex';
        discountRow.classList.add('fade-in');
        discountRow.classList.remove('fade-out');
      } else {
        discountRow.classList.remove('fade-in');
        discountRow.classList.add('fade-out');
        setTimeout(() => (discountRow.style.display = 'none'), 300);
      }
    }
  }

  function saveVoucherToStorage() {
    if (!activeVoucherData) {
      localStorage.removeItem('menuva_voucher');
      return;
    }
    // save the raw object (to allow restore)
    localStorage.setItem('menuva_voucher', JSON.stringify(activeVoucherData._raw || activeVoucherData));
  }

  function restoreVoucherFromStorage() {
    const saved = localStorage.getItem('menuva_voucher');
    if (!saved) return;
    try {
      const parsed = JSON.parse(saved);
      // normalize and set activeVoucherData if still valid
      const norm = normalizeVoucher(parsed);
      if (!norm) return;
      // if cached vouchers loaded, try to find actual canonical voucher
      const candidate = getActiveVoucherList().find(v => v.code.toLowerCase() === norm.code.toLowerCase());
      if (candidate) activeVoucherData = candidate;
      else activeVoucherData = norm; // allow a voucher restored from local storage
      applyVoucherAndUpdateSummary();
    } catch(e) {
      console.warn('Gagal load voucher dari storage:', e);
    }
  }

  function initVoucherInput() {
    const voucherInput = document.getElementById('voucherInput');
    const voucherMessage = document.getElementById('voucherMessage');

    if (!voucherInput) return;

    const applyHandler = async ()=> {
      // Ensure voucher list loaded before checking
      try { await ensureVoucherLoaded(); } catch(e) {}
      const code = (voucherInput.value || '').trim();
      const voucher = findVoucherSync(code);

      if (voucher) {
        activeVoucherData = voucher;
        if (voucherMessage) {
          voucherMessage.textContent = `‚úÖ Voucher applied: ${voucher.discount}% off`;
          voucherMessage.style.color = 'green';
        }
      } else if (code.length > 0) {
        activeVoucherData = null;
        if (voucherMessage) {
          voucherMessage.textContent = '‚ùå Invalid voucher code';
          voucherMessage.style.color = 'red';
        }
      } else {
        activeVoucherData = null;
        if (voucherMessage) voucherMessage.textContent = '';
      }

      applyVoucherAndUpdateSummary();
      saveVoucherToStorage();
    };

    ['input','keyup','change','blur'].forEach(evt => voucherInput.addEventListener(evt, applyHandler));
  }

  // A helper used by some legacy code: synchronous findVoucher wrapper (will try to use cached)
  function findVoucher(code) {
    return findVoucherSync(code);
  }

  /* =========================
     CART PERSISTENCE & CUSTOMER FORM
     ========================= */
  function saveCartToStorage() {
    localStorage.setItem("menuva_cart", JSON.stringify(cart));
  }

  function loadCartFromStorage() {
    try {
      const data = JSON.parse(localStorage.getItem("menuva_cart") || "[]");
      if (Array.isArray(data)) cart = data;
    } catch(e) {
      cart = [];
    }
  }

  function saveCustomerForm() {
    const formData = {
      name: document.getElementById('custName')?.value || '',
      table: document.getElementById('custTable')?.value || '',
      date: document.getElementById('custDate')?.value || '',
      time: document.getElementById('custTime')?.value || '',
      note: document.getElementById('custNote')?.value || ''
    };
    localStorage.setItem("menuva_customer", JSON.stringify(formData));
  }

  function loadCustomerForm() {
    try {
      const data = JSON.parse(localStorage.getItem("menuva_customer") || "{}");
      if (!data) return;
      if (data.name) document.getElementById('custName').value = data.name;
      if (data.table) document.getElementById('custTable').value = data.table;
      if (data.date) document.getElementById('custDate').value = data.date;
      if (data.time) document.getElementById('custTime').value = data.time;
      if (data.note) document.getElementById('custNote').value = data.note;
    } catch(e) {}
  }

  /* =========================
     ORDER SAVE (same as original, but uses initDB/getDB)
     ========================= */
  async function sendOrder() {
    const name = (document.getElementById('custName')?.value || '').trim();
    const table = (document.getElementById('custTable')?.value || '').trim();
    const date = document.getElementById('custDate')?.value || '';
    const time = document.getElementById('custTime')?.value || '';
    const note = (document.getElementById('custNote')?.value || '').trim();

    if (!name) return showToast('‚ö†Ô∏è Please fill in customer name!', "error"), playSound("error");
    if (!table) return showToast('‚ö†Ô∏è Please fill in table number!', "error"), playSound("error");
    if (!cart || !cart.length) return showToast('‚ö†Ô∏è Please add items to cart before submitting!', "error"), playSound("error");

    let subtotal = 0;
    cart.forEach(c => subtotal += (Number(c.harga) || 0) * (Number(c.qty) || 0));

    let discount = 0, voucherCode = null, discountPercent = 0;
    if (activeVoucherData) {
      discountPercent = parseFloat(activeVoucherData.discount) || 0;
      discount = subtotal * (discountPercent / 100);
      voucherCode = activeVoucherData.code;
    }
    const grandTotal = subtotal - discount;
    const now = new Date();

    const orderData = {
      resto: restoData?.namaRestoran || '',
      customer: name,
      table,
      date,
      time,
      note: note || '-',
      items: cart.map(c => ({
        nama: c.nama,
        qty: c.qty,
        harga: c.harga,
        total: (Number(c.harga) || 0) * (Number(c.qty) || 0)
      })),
      subtotal,
      discount,
      discountPercent,
      voucherCode,
      grandTotal,
      status: "new",
      orderTime: now.toLocaleString("id-ID", { dateStyle: "short", timeStyle: "medium" })
    };

    try {
      const database = await initDB();
      const tx = database.transaction("ordersData", "readwrite");
      const store = tx.objectStore("ordersData");
      const req = store.add(orderData);

      req.onsuccess = (e) => {
        const newId = e.target.result;
        console.log("‚úÖ Order stored:", { ...orderData, id: newId });
        showToast("‚úÖ Order submitted successfully!", "success", "top");
        playSound("success");

        try {
          const bc = new BroadcastChannel("menuvaOrders");
          bc.postMessage({
            type: "newOrder",
            data: { ...orderData, id: newId }
          });
          bc.close();
        } catch (err) {
          console.warn("‚ö†Ô∏è Broadcast gagal:", err);
        }

        showToast("üßæ Order is being processed", "info", "bottom");
      };

      req.onerror = (e) => {
        console.error("‚ùå Failed saving order:", e.target.error);
        showToast("‚ùå Failed to save order, please try again.", "error");
        playSound("error");
      };

    } catch (err) {
      console.error("‚ùå DB Error:", err);
      showToast("‚ùå Database not initialized", "error");
    }
  }

  /* =========================
     SOUND & TOAST HELPERS
     ========================= */
  function playSound(type) {
    let file = "";
    if (type === "success") file = "clik.mp3";
    else if (type === "error") file = "beep.mp3";
    if (!file) return;
    const audio = new Audio(`./${file}`);
    audio.play().catch(err => console.warn("Sound error:", err));
  }

  function showToast(message, type = "info", position = "top") {
    const toast = document.createElement("div");
    toast.className = `toast ${type} toast-${position}`;
    toast.textContent = message;
    document.body.appendChild(toast);
    setTimeout(() => toast.remove(), 3000);
  }

  /* =========================
     TABS & UI INIT
     ========================= */
  function switchTab(tabName){
    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
    const target = document.getElementById(tabName);
    if (target) target.classList.add('active');
    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
    const activeTab = Array.from(document.querySelectorAll('.tab')).find(x => x.getAttribute('onclick')?.includes(tabName));
    if (activeTab) activeTab.classList.add('active');
  }

  window.sendOrder = sendOrder;
  window.switchTab = switchTab;

  /* =========================
     CLEAR CUSTOMER DATA (kept)
     ========================= */
  async function clearCustomerData(confirmRequired = true) {
    if (confirmRequired) {
      if (!confirm('Yakin mau hapus semua data pesanan di halaman ini?')) return;
    }

    try {
      cart = [];
      activeVoucherData = null;

      localStorage.removeItem('menuva_cart');
      localStorage.removeItem('menuva_customer');
      localStorage.removeItem('menuva_voucher');
      localStorage.removeItem('voucher');

      const idsToClear = ['custName', 'custTable', 'custNote'];
      idsToClear.forEach(id => {
        const el = document.getElementById(id);
        if (el) el.value = '';
      });

      const now = new Date();
      const pad = n => String(n).padStart(2, '0');
      const dateStr = `${now.getFullYear()}-${pad(now.getMonth() + 1)}-${pad(now.getDate())}`;
      const timeStr = `${pad(now.getHours())}:${pad(now.getMinutes())}`;
      const dateInput = document.getElementById('custDate');
      const timeInput = document.getElementById('custTime');
      if (dateInput) dateInput.value = dateStr;
      if (timeInput) timeInput.value = timeStr;

      saveCartToStorage();
      saveCustomerForm();
      saveVoucherToStorage();

      renderCart();
      applyVoucherAndUpdateSummary();
      renderMenu();
      renderPromo(menuPromo);
      updateCartCount();

      try {
        const notifyBc = new BroadcastChannel('menuvaOrders');
        notifyBc.postMessage({ type: 'customer_cleared' });
        notifyBc.close();
      } catch (e) {}

      showToast('üßπ Semua data pesanan Anda telah dihapus.', 'success', 'top');
      playSound('delete');
    } catch (err) {
      console.error('‚ùå clearCustomerData error:', err);
      showToast('‚ùå Gagal menghapus data. Coba lagi.', 'error');
    }
  }

  const clearBtn = document.getElementById('clearDataBtn');
  if (clearBtn) {
    clearBtn.replaceWith(clearBtn.cloneNode(true));
    const newBtn = document.getElementById('clearDataBtn');
    newBtn.addEventListener('click', () => clearCustomerData(true));
  }

  /* =========================
     LOCALE SELECT INIT
     ========================= */
  function initLocaleSelect(){
    const sel = document.getElementById('localeSelect');
    if (!sel) return;
    const saved = localStorage.getItem(LOCALE_KEY) || 'auto';
    sel.value = saved;
    sel.addEventListener('change', ()=>{
      saveLocaleChoice(sel.value);
      refreshAllPriceDisplays();
      renderCart();
    });
  }

  /* =========================
     VOUCHER + INIT ORDER: main DOM ready
     - ensure vouchers loaded BEFORE rendering cart so findVoucherSync works
     ========================= */
  window.addEventListener('DOMContentLoaded', async () => {
    // initialize locale, voucher input handlers, dark mode handled elsewhere
    initLocaleSelect();
    initVoucherInput();

    try {
      // open DB first (may throw if device denies it)
      try {
        await initDB();
      } catch (err) {
        console.warn('‚ö†Ô∏è initDB error (will fallback to localStorage):', err);
      }

      // load base data (menu / resto) if DB available
      try {
        const restoId = getQueryRestoId();
        const data = await loadDataFromDB(restoId);
        restoData = data || {};
        menuData = Array.isArray(data?.menu) ? data.menu : Array.isArray(data?.menuData) ? data.menuData : [];
        menuPromo = Array.isArray(data?.menuPromo) ? data.menuPromo : [];
      } catch (e) {
        console.warn('‚ö†Ô∏è DB init error:', e);
      }

      // ensure vouchers loaded (DB first, fallback LS)
      try { await ensureVoucherLoaded(); } catch(e){ console.warn('Voucher ensure failed', e); }

    } catch (err) {
      console.warn('Init error:', err);
    }

    // ========== Header Info ==========
    const logoEl = document.getElementById('restoLogo');
    if (logoEl) {
      logoEl.src = restoData?.logo || '';
      logoEl.style.display = restoData?.logo ? 'block' : 'none';
    }

    const nameEl = document.getElementById('restoName');
    if (nameEl) nameEl.innerText = restoData?.namaRestoran || 'Nama Restoran';

    const alamatEl = document.getElementById('alamatRestoranDisplay');
    if (alamatEl) alamatEl.innerText = restoData?.restoAddress || '';

    const telEl = document.getElementById('teleponRestoranDisplay');
    if (telEl) telEl.innerText = restoData?.restoPhone || '';

    // default date/time
    const now = new Date();
    const pad = n => String(n).padStart(2, '0');
    const dateStr = `${now.getFullYear()}-${pad(now.getMonth() + 1)}-${pad(now.getDate())}`;
    const timeStr = `${pad(now.getHours())}:${pad(now.getMinutes())}`;
    const dateInput = document.getElementById('custDate');
    if (dateInput) dateInput.value = dateStr;
    const timeInput = document.getElementById('custTime');
    if (timeInput) timeInput.value = timeStr;

    // initial render
    renderMenu();
    renderPromo(menuPromo);

    loadCartFromStorage();
    loadCustomerForm();
    renderCart();
    // applyVoucherAndUpdateSummary will consider cached vouchers loaded above
    applyVoucherAndUpdateSummary();
    restoreVoucherFromStorage();

    // auto-save form inputs
    ['custName', 'custTable', 'custDate', 'custTime', 'custNote'].forEach(id => {
      const el = document.getElementById(id);
      if (el) el.addEventListener('input', saveCustomerForm);
    });

    // locale select UI set
    const sel = document.getElementById('localeSelect');
    if (sel) sel.value = localStorage.getItem(LOCALE_KEY) || 'auto';

    console.log('‚úÖ Menuva JS (clean) initialized');
  });

  /* =========================
     expose some functions to window (keperluan template)
     ========================= */
  window.findVoucher = findVoucher; // compatibility
  window.applyVoucherAndUpdateSummary = applyVoucherAndUpdateSummary;
  window.saveVoucherToStorage = saveVoucherToStorage;
  window.restoreVoucherFromStorage = restoreVoucherFromStorage;
  window.ensureVoucherLoaded = ensureVoucherLoaded;
  window.initVoucherInput = initVoucherInput;
  window.getActiveVoucherList = getActiveVoucherList;

})();
</script>
<script>
// ===================== THEME MODE =====================
function applyTheme() {
    const saved = localStorage.getItem("themeMode") || "light";
    document.documentElement.setAttribute("data-theme", saved);
}

// toggle theme
function toggleTheme() {
    const current = localStorage.getItem("themeMode") || "light";
    const next = current === "light" ? "dark" : "light";
    localStorage.setItem("themeMode", next);
    applyTheme();
}

document.addEventListener("DOMContentLoaded", () => {
    applyTheme();
    const btn = document.getElementById("themeToggleBtn");
    if (btn) {
        btn.addEventListener("click", toggleTheme);
    }
});
</script>

</body>
</html>

