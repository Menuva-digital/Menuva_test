<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Reserve Room</title>
<style>
/* ===================== RESET & THEME ===================== */
*{box-sizing:border-box;margin:0;padding:0}
:root{
  --bg:#1e3c72;
  --surface:#ffffff;
  --text:#1c2d4f;
  --muted:#5c6f91;
  --border:#c3d4f7;
  --primary:#1f70ff;
  --success:#25d366;
  --card-light:#ffffff;
  --card-dark:#1c2333;
  --chip:#dce7ff;
  --shadow:0 6px 24px rgba(0,0,0,.08);
}
body.dark{
  --bg:#0e1116;
  --surface:#141922;
  --text:#e6ebff;
  --muted:#aab6db;
  --border:#263148;
  --primary:#4da3ff;
  --chip:#0f1a2a;
  --shadow:0 8px 28px rgba(0,0,0,.5);
}
body{
  font-family:system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial;
  background:var(--bg);
  color:var(--text);
  transition:background .25s,color .25s;
  padding-bottom:72px;
}

/* ===== HEADER ===== */
header{
  position:relative;
  padding:12px 16px;
  display:flex;
  align-items:center;
  justify-content:center;
}
.header-inner{
  width:100%;
  max-width:1200px;
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:12px;
}

/* left area: logo + text (center vertical) */
.header-left{
  display:flex;
  align-items:center;
  gap:12px;
}
#restoLogo{
  width:56px;
  height:56px;
  object-fit:contain;
  border-radius:8px;
  display:block;
  background:rgba(255,255,255,0.04);
}

/* centre text stack */
.header-center{
  display:flex;
  flex-direction:column;
  gap:4px;
  align-items:flex-start;
}
#namaRestoranDisplay{
  font-size:1.05rem;
  font-weight:700;
  color: #fff;
}
.contact-info{
  font-size:0.82rem;
  color: rgba(255,255,255,0.9);
  line-height:1.2;
}

/* right controls: vertical stack (toggle above, dropdown below) */
.header-right{
  display:flex;
  flex-direction:column;
  align-items:flex-end;
  gap:8px;
}

/* toggle */
.dark-toggle{
  width:44px;height:36px;border-radius:8px;border:0;background:transparent;color:#fff;font-size:18px;cursor:pointer;
  display:inline-flex;align-items:center;justify-content:center;
}

/* locale dropdown */
.locale-select{
  padding:6px 8px;border-radius:8px;border:0;background:rgba(255,255,255,0.12);color:#fff;font-weight:600;
  min-width:150px;
}

/* ===== MAIN ===== */
.main-container{
  width:95%;
  max-width:1200px;
  margin:14px auto;
  padding:14px;
  background:rgba(255,255,255,0.02);
  border-radius:12px;
  color: #fff;
}

/* Tabs */
.tabs{
  display:grid;
  grid-template-columns:repeat(3,1fr);
  gap:10px;
  margin-bottom:12px;
}
.tabs button{
  padding:10px 12px;border-radius:999px;border:1px solid rgba(255,255,255,0.08);
  background:rgba(255,255,255,0.04);color:inherit;font-weight:600;cursor:pointer;
}
.tabs button.active{background:linear-gradient(90deg,var(--primary),#2a5298);color:#fff;border-color:transparent;}

/* grid cards */
.grid{
  display:grid;
  gap:12px;
  grid-template-columns:repeat(auto-fill,minmax(180px,1fr));
}

/* room card */
.room-card{
  background:var(--card-light);
  color:var(--text);
  border-radius:10px;padding:10px;border:1px solid #e6e6e6;
  transition:transform .14s,box-shadow .14s;
  display:flex;flex-direction:column;gap:8px;
}
body.dark .room-card{background:var(--card-dark);color:var(--text)}
.room-card img{width:100%;height:110px;object-fit:cover;border-radius:6px}
.room-card h3{font-size:1rem;margin:0}
.room-card p{margin:0;font-size:.85rem;color:var(--muted)}
.room-card button{margin-top:auto;padding:8px;border-radius:8px;border:0;background:var(--success);color:#fff;cursor:pointer}

/* cart preview and form */
.reservasi-container{margin-top:16px}
#cartPreview{background:var(--chip);padding:10px;border-radius:8px;margin-bottom:8px;color:var(--text)}
.cart-item{display:flex;align-items:center;justify-content:space-between;padding:6px 8px;border-radius:8px;background:rgba(0,0,0,0.03)}
.qty-controls{display:flex;gap:8px;align-items:center}
.remove-btn{background:linear-gradient(145deg,#e74c3c,#c0392b);color:#fff;border-radius:50%;width:28px;height:28px;border:0;cursor:pointer}

/* fixed bottom */
.fixed-bar{
  position:fixed;left:0;right:0;bottom:0;padding:10px 14px;background:linear-gradient(135deg,#1e3c72,#2a5298);
  box-shadow:0 -6px 18px rgba(0,0,0,0.2);display:flex;gap:12px;justify-content:center;z-index:999;
}
.fixed-bar .btn-wa,.fixed-bar .btn-back{flex:1;padding:10px;border-radius:8px;border:0;color:#fff;font-weight:700;cursor:pointer}
.btn-wa{background:var(--success)}
.btn-back{background:#f39c12;color:#111}

/* loader */
#loadingIndicator{display:none;padding:12px;text-align:center;color:var(--muted)}
#loadingIndicator.active{display:block}

/* responsive */
@media (max-width:900px){
  .header-inner{padding:0 6px}
  .header-right{align-items:flex-end}
  .locale-select{min-width:120px}
}
@media (max-width:600px){
  .header-inner{flex-direction:column;align-items:stretch;gap:8px}
  .header-left{justify-content:flex-start}
  .header-right{align-items:flex-end}
  .grid{grid-template-columns:repeat(2,1fr)}
}
</style>
</head>
<body>
<header>
  <div class="header-inner">
    <div class="header-left">
      <img id="restoLogo" alt="Logo" />
      <div class="header-center">
        <div id="namaRestoranDisplay">Loading...</div>
        <div class="contact-info">
          <div id="alamatRestoranDisplay"></div>
          <div id="teleponRestoranDisplay"></div>
        </div>
      </div>
    </div>

    <div class="header-right">
      <button id="darkToggle" class="dark-toggle" aria-label="Toggle theme">üåô</button>
      <select id="localeSelect" class="locale-select" title="Change locale / currency">
        <option value="auto">Auto (browser)</option>
        <option value="id-ID|IDR">Indonesia ‚Äî IDR</option>
        <option value="en-US|USD">US ‚Äî USD</option>
        <option value="en-GB|GBP">UK ‚Äî GBP</option>
        <option value="de-DE|EUR">Germany ‚Äî EUR</option>
        <option value="ja-JP|JPY">Japan ‚Äî JPY</option>
        <option value="zh-CN|CNY">China ‚Äî CNY</option>
        <option value="fr-FR|EUR">France ‚Äî EUR</option>
      </select>
    </div>
  </div>
</header>

<div id="loadingIndicator">‚è≥ Loading data...</div>

<main class="main-container" id="app">
  <div class="tabs" role="tablist">
    <button class="active" data-target="rooms" role="tab">Rooms</button>
    <button data-target="meetings" role="tab">Meeting Rooms</button>
    <button data-target="packages" role="tab">Packages</button>
  </div>

  <section id="rooms" class="grid" aria-live="polite"></section>
  <section id="meetings" class="grid hidden" aria-live="polite"></section>
  <section id="packages" class="grid hidden" aria-live="polite"></section>

  <p id="empty" class="hidden" style="text-align:center;color:var(--muted);margin-top:12px">No rooms found.</p>

  <div class="reservasi-container">
    <div id="cartPreview"><i>No choice</i></div>
    <p id="cartTotal">Total: 0</p>

    <div class="form-input"><label>Orderer Name</label><input id="custName" type="text" /></div>
    <div class="form-input"><label>Address</label><input id="custAddress" type="text" /></div>
    <div class="form-input"><label>Telephone Number</label><input id="custPhone" type="text" /></div>
    <div class="form-input"><label>Date Used</label><input id="custDate" type="date" /></div>
    <div class="form-input"><label>Notes</label><textarea id="custNote"></textarea></div>
  </div>
</main>

<div class="fixed-bar">
  <button id="btnSend" class="btn-wa">üì§ Send Request</button>
  <button class="btn-back" onclick="history.back()">üîô Back To Menu</button>
</div>

<script>
(() => {
  const DB_NAME = "MenuvaDB";
  const STORE_NAME = "menuvaData";
  const DB_VERSION = 2;
  let db = null;
  let restoData = {};
  let cart = [];
  // locale/currency
  let currentLocale = navigator.language || "id-ID";
  let currentCurrency = "IDR";

  // helpers
  const $ = id => document.getElementById(id);
  const safeText = (id, txt) => { const el=$(id); if(el) el.textContent = txt ?? ''; };

  // format currency
  function formatCurrency(n){
    try{
      return new Intl.NumberFormat(currentLocale, {style:'currency', currency: currentCurrency, minimumFractionDigits: 0}).format(Number(n||0));
    }catch(e){
      return Number(n||0).toLocaleString();
    }
  }

  // indexedDB init (safe)
  function initDB(){
    return new Promise((resolve, reject) => {
      const req = indexedDB.open(DB_NAME, DB_VERSION);
      req.onerror = () => reject(req.error);
      req.onsuccess = e => { db = e.target.result; resolve(db); };
      req.onupgradeneeded = e => {
        db = e.target.result;
        if(!db.objectStoreNames.contains(STORE_NAME)) {
          db.createObjectStore(STORE_NAME, { keyPath: "restoId" });
          console.info("[room] created fallback store", STORE_NAME);
        }
      };
    });
  }

  // load data -> choose first valid record
  function loadDataFromDB(){
    return new Promise((resolve) => {
      if(!db) return resolve({});
      if(!db.objectStoreNames.contains(STORE_NAME)) return resolve({});
      try {
        const tx = db.transaction(STORE_NAME, "readonly");
        const store = tx.objectStore(STORE_NAME);
        const req = store.getAll();
        req.onsuccess = () => {
          const all = req.result || [];
          if(all.length === 0) return resolve({});
          // prefer one that has namaRestoran or restoId
          const found = all.find(r => r && (r.restoId || r.namaRestoran || r.restoPhone)) || all[0];
          resolve(found || {});
        };
        req.onerror = () => resolve({});
      } catch (err) {
        console.warn("[room] loadDataFromDB err", err);
        resolve({});
      }
    });
  }

  // UI building
  function createRoomCard(room = {}){
    const card = document.createElement('div');
    card.className = 'room-card';
    const img = document.createElement('img');
    if(room.image) { img.src = room.image; img.alt = room.nama || 'room'; } else img.style.display = 'none';
    card.appendChild(img);

    const h = document.createElement('h3'); h.textContent = room.nama || 'Untitled'; card.appendChild(h);
    const pPrice = document.createElement('p'); pPrice.innerHTML = `<b>Price:</b> ${formatCurrency(room.harga)}`; card.appendChild(pPrice);
    const pCap = document.createElement('p'); pCap.innerHTML = `<b>Capacity:</b> ${room.kapasitas || 0} person`; card.appendChild(pCap);
    const pSize = document.createElement('p'); pSize.innerHTML = `<b>Room size:</b> ${room.luas || 0} m¬≤`; card.appendChild(pSize);
    const pDesc = document.createElement('p'); pDesc.textContent = room.deskripsi || ''; card.appendChild(pDesc);

    const btn = document.createElement('button'); btn.textContent = 'Add To Cart';
    btn.onclick = () => addToCart(room);
    card.appendChild(btn);

    return card;
  }

  function renderData(){
    if(!restoData || !restoData.namaRestoran){
      $('empty')?.classList.remove('hidden');
      safeText('namaRestoranDisplay','No restaurant data');
      return;
    }
    // header
    const logoEl = $('restoLogo');
    if(logoEl){
      if(restoData.logo){ logoEl.src = restoData.logo; logoEl.style.display = ''; logoEl.onerror = () => { logoEl.style.display = 'none'; }; }
      else logoEl.style.display = 'none';
    }
    safeText('namaRestoranDisplay', restoData.namaRestoran || '');
    safeText('alamatRestoranDisplay', restoData.restoAddress || '');
    safeText('teleponRestoranDisplay', restoData.restoPhone || '');

    // grids
    const gRooms = $('rooms'), gMeet = $('meetings'), gPack = $('packages');
    if(gRooms) gRooms.innerHTML = '';
    if(gMeet) gMeet.innerHTML = '';
    if(gPack) gPack.innerHTML = '';

    let count = 0;
    const arr = Array.isArray(restoData.rooms) ? restoData.rooms : [];
    arr.forEach(r => {
      count++;
      const card = createRoomCard(r);
      if(r.kategori === 'meeting' && gMeet) gMeet.appendChild(card);
      else if(r.kategori === 'package' && gPack) gPack.appendChild(card);
      else if(gRooms) gRooms.appendChild(card);
    });

    $('empty')?.classList.toggle('hidden', count > 0);
  }

  // cart
  function addToCart(room){
    if(!room || !room.nama) return;
    const idx = cart.findIndex(c => c.nama === room.nama);
    if(idx >= 0) cart[idx].qty = (cart[idx].qty || 0) + 1;
    else cart.push({...room, qty:1});
    renderCart();
  }
  function removeFromCart(i){ cart.splice(i,1); renderCart(); }
  function changeQty(i, delta){ cart[i].qty = Math.max(1, (cart[i].qty||0)+delta); renderCart(); }
  function renderCart(){
    const preview = $('cartPreview'); if(!preview) return;
    preview.innerHTML = '';
    if(cart.length === 0){ preview.innerHTML = '<i>No choice</i>'; $('cartTotal').textContent = 'Total: 0'; return; }
    let total = 0;
    cart.forEach((it, idx) => {
      const subtotal = (Number(it.harga)||0) * (it.qty||0);
      total += subtotal;
      const div = document.createElement('div'); div.className = 'cart-item';
      const left = document.createElement('div'); left.textContent = `${it.nama} - ${formatCurrency(it.harga)} x ${it.qty} = ${formatCurrency(subtotal)}`;
      div.appendChild(left);

      const right = document.createElement('div'); right.style.display='flex'; right.style.gap='8px'; right.style.alignItems='center';
      if(it.kategori === 'package'){
        const dec = document.createElement('button'); dec.textContent='-'; dec.onclick = () => changeQty(idx,-1);
        const span = document.createElement('span'); span.textContent = it.qty;
        const inc = document.createElement('button'); inc.textContent = '+'; inc.onclick = () => changeQty(idx,1);
        right.appendChild(dec); right.appendChild(span); right.appendChild(inc);
      }
      const rem = document.createElement('button'); rem.className='remove-btn'; rem.textContent='X'; rem.onclick = () => removeFromCart(idx);
      right.appendChild(rem);
      div.appendChild(right);
      preview.appendChild(div);
    });
    $('cartTotal').textContent = 'Total: ' + formatCurrency(total);
  }

  // tabs
  function setupTabs(){
    document.querySelectorAll('.tabs button').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('.tabs button').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        document.querySelectorAll('main .grid').forEach(g => g.classList.add('hidden'));
        const t = btn.dataset.target;
        const el = document.getElementById(t);
        if(el) el.classList.remove('hidden');
      });
    });
  }

  // locale select change
  function setupLocale(){
    const sel = $('localeSelect');
    if(!sel) return;
    // restore
    const saved = localStorage.getItem('menuva_locale');
    if(saved) sel.value = saved;
    sel.addEventListener('change', () => {
      const val = sel.value;
      if(val === 'auto'){
        currentLocale = navigator.language || 'id-ID';
        currentCurrency = (currentLocale.startsWith('en') ? 'USD' : 'IDR');
      } else {
        const [loc,cur] = val.split('|');
        currentLocale = loc || currentLocale;
        currentCurrency = cur || currentCurrency;
      }
      localStorage.setItem('menuva_locale', sel.value);
      renderData();
      renderCart();
    });
    // apply initial
    const ev = new Event('change'); sel.dispatchEvent(ev);
  }

  // dark toggle
  function applyTheme(){
    const saved = localStorage.getItem('menuva_theme');
    const btn = $('darkToggle');
    if(saved === 'dark') document.body.classList.add('dark'); else document.body.classList.remove('dark');
    if(btn) btn.textContent = document.body.classList.contains('dark') ? '‚òÄÔ∏è' : 'üåô';
  }
  function toggleDark(){
    document.body.classList.toggle('dark');
    localStorage.setItem('menuva_theme', document.body.classList.contains('dark') ? 'dark' : 'light');
    applyTheme();
  }

  // WA send
  function setupWA(){
    const btn = $('btnSend');
    if(!btn) return;
    btn.addEventListener('click', () => {
      const admin = restoData.nomorWaAdmin;
      if(!admin || (Array.isArray(admin) && admin.length===0)){ alert("Admin's WhatsApp number not set."); return; }
      if(cart.length === 0){ alert('Cart is empty'); return; }
      const adminNo = (Array.isArray(admin)?admin[0]:admin).replace(/[^0-9]/g,'');
      let msg = `Hello ${restoData.namaRestoran||'Admin'}, I want a reservation:\n\n`;
      cart.forEach((it,i)=> msg += `${i+1}. ${it.nama} - ${formatCurrency(it.harga)} x ${it.qty} = ${formatCurrency((it.harga||0)*it.qty)}\n`);
      const total = cart.reduce((s,it)=> s + ((Number(it.harga)||0) * (it.qty||0)), 0);
      msg += `\nTotal: ${formatCurrency(total)}\n\n`;
      msg += `Name: ${$('custName')?.value||''}\nAddress: ${$('custAddress')?.value||''}\nPhone: ${$('custPhone')?.value||''}\nDate: ${$('custDate')?.value||''}\nNotes: ${$('custNote')?.value||''}\n`;
      window.open(`https://wa.me/${adminNo}?text=${encodeURIComponent(msg)}`,'_blank');
    });
  }

  // init
  document.addEventListener('DOMContentLoaded', async () => {
    applyTheme();
    // wire toggle
    $('darkToggle')?.addEventListener('click', toggleDark);

    // locale & tabs
    setupLocale();
    setupTabs();

    // loader show
    $('loadingIndicator')?.classList.add('active');

    try{
      await initDB();
      restoData = await loadDataFromDB();
    }catch(e){
      console.warn('[room] DB error', e);
      restoData = {};
    }

    renderData();
    renderCart();
    setupWA();

    $('loadingIndicator')?.classList.remove('active');
  });
})();
</script>
</body>
</html>
