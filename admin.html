<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>

  <title>Admin Menuva</title>
  <style>
    * { box-sizing: border-box; }
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
      padding-bottom: 80px;
      background: linear-gradient(135deg, #003366, #003366);
      margin: 0;
      position: relative;
      overflow-x: hidden;
    }
   /* =====================
   MOBILE-FIRST LOGO & HEADER
   ===================== */
.menuva-logo {
  text-align: center;
  margin-bottom: 10px;
  padding: 0 10px; /* beri sedikit jarak kiri-kanan di HP */
}

.menuva-logo img {
  max-width: 70%;   /* logo menyesuaikan lebar layar HP */
  height: auto;     /* menjaga proporsi asli */
  max-height: 80px; /* batasi tinggi supaya tidak terlalu besar */
  display: block;
  margin: 0 auto;   /* center logo */
}

.menuva-logo p {
  color: white;
  font-size: 13px;  /* ukuran font nyaman di HP */
  margin: 4px 0 0 0;
  line-height: 1.3;
}

/* =====================
   TABLET (min-width: 481px)
   ===================== */
@media (min-width: 481px) {
  .menuva-logo img {
    max-width: 50%;
    max-height: 90px;
  }
  .menuva-logo p {
    font-size: 14px;
  }
}

/* =====================
   DESKTOP (min-width: 769px)
   ===================== */
@media (min-width: 769px) {
  .menuva-logo img {
    max-width: 35%;
    max-height: 100px;
  }
  .menuva-logo p {
    font-size: 16px;
  }
}
    h1, h2, h3 {
      text-align: center;
      margin: 10px 0;
    }
    .section {
      background: #fff;
      padding: 20px;
      margin-bottom: 20px;
      border-radius: 10px;
      box-shadow: 0 3px 6px rgba(0,0,0,0.1);
    }
    input, button, textarea {
      padding: 10px;
      margin: 5px 0;
      border-radius: 5px;
      border: 1px solid #ccc;
      width: 100%;
      font-size: 1rem;
    }
    .menu-item {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items: center;
      margin-bottom: 10px;
    }
    .menu-item input {
      flex: 1 1 40%;
    }
    .menu-item button {
      flex: 1 1 auto;
      white-space: nowrap;
      background: linear-gradient(135deg, #7f5af0, #2cb5e8);
    }
    .btn-danger {
      background-color: #e74c3c;
      color: white;
    }
    .btn-success {
      background-color: #2ecc71;
      color: white;
    }
    .btn-secondary {
      background-color: #3498db;
      color: white;
    }
    .btn-orange {
      background-color: orange;
      color: white;
      border: none;
    }
    .preview img {
      max-width: 100px;
      margin: 5px;
      border-radius: 5px;
      box-shadow: 0 1px 4px rgba(0,0,0,0.1);
    }
    @media (max-width: 600px) {
      .menu-item input, .menu-item button {
        width: 100%;
      }
    }
    .room-section > div:nth-child(2) button {
      padding: 6px 14px;
      border-radius: 6px;
      background-color: #007bff;
      color: white;
      border: none;
      cursor: pointer;
    }
    .room-section-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
    }
    .room-form {
      padding: 10px;
      border: 1px dashed #ccc;
      margin-bottom: 12px;
      border-radius: 6px;
      background-color: #fff;
    }
    .room-form input[type="text"],
    .room-form input[type="number"],
    .room-form input[type="file"] {
      display: block;
      margin-bottom: 8px;
      width: 100%;
      padding: 6px;
      font-size: 14px;
    }
    .room-form .room-preview img {
      max-height: 80px;
      margin-top: 4px;
    }
    .gambar-preview-wrapper {
      position: relative;
      display: inline-block;
      margin-top: 10px;
    }
    .gambar-preview {
      height: auto !important;
      width: auto !important;
      max-height: 200px !important;
      max-width: 100% !important;
      display: block;
    }
    .hapus-gambar {
      position: absolute;
      top: -8px;
      right: -8px;
      background: red;
      color: white;
      border: none;
      border-radius: 50%;
      font-size: 14px;
      width: 24px;
      height: 24px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 2px 6px rgba(0,0,0,0.2);
      transition: background 0.2s;
    }
    .hapus-gambar:hover { background: #cc0000; }
    .btn-hapus-gambar {
      width: 24px;
      height: 24px;
      border-radius: 50%;
      border: none;
      background: red;
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      padding: 0;
      font-size: 14px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.2);
      transition: background 0.2s, transform 0.1s ease;
    }
    .btn-hapus-gambar:hover {
      background: #cc0000;
      transform: scale(1.05);
    }
    .section-box {
      border: none;
      padding: 16px;
      margin-bottom: 24px;
      border-radius: 8px;
      background: #fff;
    }
    .section-box h2,
    .section-box h3 { margin-top: 0; }
    .room-section { margin-bottom: 20px; }
    .room-section button {
      margin-bottom: 10px;
      background-color: #17a2b8;
    }
    .btn-simpan {
      background-color: #17a2b8;
      color: white;
      font-weight: bold;
      border: none;
      padding: 10px 16px;
      border-radius: 6px;
      cursor: pointer;
    }
    .btn-tambah-room {
      background: linear-gradient(135deg, #7f5af0, #2cb5e8);
      color: #fff;
      padding: 8px 14px;
      border: none;
      border-radius: 8px;
      font-weight: bold;
      box-shadow: 0 4px 10px rgba(127, 90, 240, 0.3);
      cursor: pointer;
      transition: transform 0.2s ease;
    }
    .btn-tambah-room:hover {
      transform: scale(1.05);
      box-shadow: 0 4px 12px rgba(44, 181, 232, 0.5);
    }
    .btn-hapus-room {
      background: linear-gradient(135deg, #ff6b6b, #fbc687);
      color: #fff;
      padding: 8px 14px;
      border: none;
      border-radius: 8px;
      font-weight: bold;
      box-shadow: 0 4px 10px rgba(255, 107, 107, 0.3);
      margin-top: 10px;
      cursor: pointer;
      transition: transform 0.2s ease;
    }
    .btn-hapus-room:hover {
      transform: scale(1.05);
      box-shadow: 0 4px 12px rgba(251, 198, 135, 0.5);
    }
    .btn-upload-gambar {
      background: linear-gradient(135deg, #00c6ff, #0072ff);
      color: white;
      padding: 6px 12px;
      border: none;
      border-radius: 6px;
      margin-top: 6px;
      font-weight: 500;
      cursor: pointer;
      transition: opacity 0.3s ease;
    }
    .btn-upload-gambar:hover { opacity: 0.85; }
    .fixed-bar {
      position: fixed !important;
      bottom: 0;
      left: 0;
      width: 100vw;
      background: linear-gradient(135deg, #003366, #003366);
      box-shadow: 0 -2px 6px rgba(0,0,0,0.1);
      display: flex;
      justify-content: center;
      gap: 15px;
      padding: 10px 20px;
      z-index: 9999;
    }
    /* Style umum untuk tombol aksi penting */
.btn-action {
  display: inline-block;
  padding: 10px 16px;
  margin: 6px 4px;
  font-size: 14px;
  font-weight: 600;
  border-radius: 8px;
  border: none;
  cursor: pointer;
  color: #fff;
  transition: all 0.3s ease;
  box-shadow: 0 3px 6px rgba(0,0,0,0.15);
}

/* Copy Link → biru elegan */
#btnSalinLink.btn-action {
  background: #007BFF;
}
#btnSalinLink.btn-action:hover {
  background: #0056b3;
}

/* Download QR → hijau segar */
#btnDownloadQR.btn-action {
  background: #28a745;
}
#btnDownloadQR.btn-action:hover {
  background: #1e7e34;
}

/* Print QR → oranye elegan */
#btnPrintQR.btn-action {
  background: #fd7e14;
}
#btnPrintQR.btn-action:hover {
  background: #e8590c;
}

/* Backup Data → ungu premium */
#btnBackup.btn-action {
  background: #6f42c1;
}
#btnBackup.btn-action:hover {
  background: #5936a2;
}
/* Blue – untuk backup */
.btn-blue {
  background: linear-gradient(135deg, #3b82f6, #1e3a8a);
  color: white;
}
.btn-blue:hover {
  background: linear-gradient(135deg, #1e3a8a, #172554);
  transform: scale(1.05);
}
/* Base style tombol */
button {
  padding: 10px 16px;
  font-size: 15px;
  border: none;
  border-radius: 6px;
  cursor: pointer;
  font-weight: 600;
  transition: all 0.25s ease;
}

/* Orange – utama */
.btn-orange {
  background: linear-gradient(135deg, #ff914d, #ff6a00);
  color: white;
}
.btn-orange:hover {
  background: linear-gradient(135deg, #ff6a00, #cc5500);
  transform: scale(1.05);
}

/* Teal – untuk salin link */
.btn-teal {
  background: linear-gradient(135deg, #20c997, #0f766e);
  color: white;
}
.btn-teal:hover {
  background: linear-gradient(135deg, #0f766e, #0c5f56);
  transform: scale(1.05);
}

/* Purple – untuk download */
.btn-purple {
  background: linear-gradient(135deg, #a855f7, #6b21a8);
  color: white;
}
.btn-purple:hover {
  background: linear-gradient(135deg, #6b21a8, #4c1d95);
  transform: scale(1.05);
}

/* Red – untuk print */
.btn-red {
  background: linear-gradient(135deg, #ef4444, #b91c1c);
  color: white;
}
.btn-red:hover {
  background: linear-gradient(135deg, #b91c1c, #7f1d1d);
  transform: scale(1.05);
}

  </style>
</head>
<body>

  <div class="menuva-logo">
    <img src="menuva-logo.png" alt="Logo Menuva">
    <br>
    <p style="color: white;">Digital Solution For Restaurant, Hotel, & Cafe's</p>
  </div>

  <div class="section">
    <h2>📇 Business Identity</h2>
    <label for="logoInput">Your Business Logo</label>
    <input type="file" id="logoInput" accept="image/*" />
    <img id="previewLogo" src="" alt="Logo Restoran" style="max-height: 80px; margin-top: 10px;" />
    <input type="text" id="namaRestoran" placeholder="Your Business Name" />
    <label for="restoAddress">Your Business Address</label>
    <input id="restoAddress" type="text" placeholder="Jl. Sudirman No. 10, Jakarta" />
    <label for="restoPhone">Phone Number</label>
    <input id="restoPhone" type="text" placeholder="08xx-xxxx-xxxx" />
  </div>

  <div class="section">
    <h2>🔥 Menu Promo</h2>
    <div id="promoContainer"></div>
    <button class="btn-orange" onclick="tambahPromo()">+ Add Promo Menu</button>
  </div>

  <div class="section">
    <h2>📋 SPECIAL MENU</h2>
    <div id="menuSpecialContainer"></div>
    <button class="btn-success" onclick="tambahMenu('special')">+ Add Special Menu</button>
  </div>

  <div class="section">
    <h2>📋 FOOD MENU</h2>
    <div id="menuFoodContainer"></div>
    <button class="btn-success" onclick="tambahMenu('food')">+ Add Menu</button>
  </div>

  <div class="section">
    <h2>📋 SNACK & DESSERT</h2>
    <div id="menuSnackContainer"></div>
    <button class="btn-success" onclick="tambahMenu('snack')">+ Add Menu</button>
  </div>

  <div class="section">
    <h2>📋 DRINK</h2>
    <div id="menuDrinkContainer"></div>
    <button class="btn-success" onclick="tambahMenu('drink')">+ Add Menu</button>
  </div>

  <div class="section-box" id="waContainerBox">
    <h3>📱 Admin WhatsApp Number (Order/Reservation Recipient)</h3>
    <div id="nomorWaContainer">
      <input type="text" class="nomor-wa" placeholder="Example: 6281234567890">
    </div>
    <button onclick="tambahNomorWa()">+ Add WA Number</button>
  </div>

  <div class="section">
    <h2>📸 Room Gallery</h2>
    <button onclick="tambahGambar('ruangan')">+ Add Room Image</button>
    <input type="file" id="flipbookRuanganUpload" accept="image/*" multiple style="display:none;" />
    <div id="flipbookRuanganPreview"></div>
  </div>

  <div class="section">
    <h2>📖 Restaurant Menu</h2>
    <button onclick="tambahGambar('menu')">+ Add Menu Image</button>
    <input type="file" id="flipbookMenuUpload" accept="image/*" multiple style="display:none;" />
    <div id="flipbookMenuPreview"></div>
  </div>

  <div class="section-box" id="roomContainerBox">
    <h2>🏨 Room / Packages</h2>
    <div class="room-section">
      <h3>🛏️ Room Hotel</h3>
      <button onclick="tambahRoom('hotel')" class="btn-tambah-room">+ Add Hotel Room</button>
      <div id="roomHotelContainer"></div>
    </div>
    <div class="room-section">
      <h3>💼 Meeting Room</h3>
      <button onclick="tambahRoom('meeting')" class="btn-tambah-room">+ Add Meeting Room</button>
      <div id="meetingRoomContainer"></div>
    </div>
    <div class="room-section">
      <h3>🎁 Packages</h3>
      <button onclick="tambahRoom('package')" class="btn-tambah-room">+ Add Packages</button>
      <div id="packageContainer"></div>
    </div>
  </div>

  <hr>

  <div class="section">
    <button class="btn-simpan" onclick="simpanData()">💾 Save All</button>
   
   <input type="hidden" id="restoId" />

  <button id="btnOpenCustomer" class="btn-orange" onclick="openCustomerPage()">👁️ See Customer Page</button>

  <button id="btnSalinLink" class="btn-teal" style="display:none;">📋 Copy Link to Share with Customers</button>

  <div id="qrcodePreview" style="margin-top:10px;"></div>

  <button id="btnDownloadQR" class="btn-purple" style="margin-top:10px; display:none;">⬇️ Download QR Code</button>

  <button id="btnPrintQR" class="btn-red" style="margin-top:5px; display:none;">🖨️ Print QR Code</button>


    <div class="section">
      <h2>🔁 Backup & Restore Data</h2>
     <button id="btnBackup" class="btn-blue" onclick="backupData()">📦 Backup Data</button>
      <div id="backupDownloadLink" style="margin-top:10px;"></div>
      <label for="restoreInput" style="margin-top: 20px; display: block;">
        📂 Select JSON File to Restore:
      </label>
      <input type="file" id="restoreInput" accept=".json" onchange="restoreDataFromFile(event)" />
    </div>
<!-- Tambahin loader di HTML -->
<div id="loader" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; 
  background:rgba(255,255,255,0.7); z-index:9999; text-align:center; padding-top:20%;">
  <div style="font-size:20px; font-weight:bold; color:#007bff;">⏳ Loading...</div>
</div>

    <div style="background: #fef9e7; padding: 10px; border-left: 5px solid #f1c40f; margin-top: 10px; font-size: 14px;">
      <strong>Panduan Penggunaan:</strong><br>
      PENTING!!<br>
      🔹 Klik <strong>⬇️ Backup Data</strong> untuk menyimpan semua data restoran ke file berformat <strong>.json</strong>.<br>
      🔹 Simpan file tersebut dengan baik dan aman di perangkat Anda.<br>
      🔹 Klik <strong>📂 Pilih File</strong> untuk me-restore data dari file <strong>.json</strong> hasil backup.<br>
      ⚠️ Proses restore akan menggantikan seluruh data yang ada saat ini dan tidak bisa dibatalkan.<br>
      💡 Gunakan fitur ini sebelum mengganti perangkat atau membersihkan data browser.
    </div>
    <div style="background: #fef9e7; padding: 10px; border-left: 5px solid #f1c40f; margin-top: 10px; font-size: 14px;">
      <strong>User Guide:</strong><br>
      IMPORTANT!!<br>
      🔹 Click <strong>⬇️ Backup Data</strong> to save all restaurant data into a <strong>.json</strong> file.<br>
      🔹 Keep the file safe and secure on your device.<br>
      🔹 Click <strong>📂 Choose File</strong> to restore data from the backup <strong>.json</strong> file.<br>
      ⚠️ The restore process will replace all existing data and cannot be undone.<br>
      💡 Use this feature before switching devices or clearing your browser data.
    </div>
  </div>

</body>
</html>

 <script>
console.log("Admin Script Version: 2025-09-15-01");
 let db;
const DB_NAME = "MenuvaDB";
const STORE_NAME = "menuvaData";
const DB_VERSION = 2;

// ====================== Init DB ======================
function initDB() {
  return new Promise((resolve, reject) => {
    if (db) return resolve(db);

    const req = indexedDB.open(DB_NAME, DB_VERSION);

    req.onerror = () => reject(req.error);
    req.onsuccess = (e) => {
      db = e.target.result;
      resolve(db);
    };

    req.onupgradeneeded = (e) => {
      const _db = e.target.result;
      if (!_db.objectStoreNames.contains(STORE_NAME)) {
        _db.createObjectStore(STORE_NAME, { keyPath: "id" });
      }
    };
  });
}
   async function saveDataToDB(data) {
  await initDB();
  return new Promise((resolve, reject) => {
    const tx = db.transaction(STORE_NAME, "readwrite");
    const store = tx.objectStore(STORE_NAME);

    // pakai id=1 anchor utama
    const payload = { id: 1, ...data };

    const req = store.put(payload);
    req.onsuccess = () => {
      console.log("✅ Data saved", payload);
      resolve(payload);
    };
    req.onerror = () => reject(req.error);
  });
}
// HANYA ambil data dari DB, jangan isi form
function loadDataFromDB() {
  return new Promise((resolve, reject) => {
    if (!db) return reject(new Error("Not Initialized"));
    const tx = db.transaction(STORE_NAME, "readonly");
    const store = tx.objectStore(STORE_NAME);
    const req = store.get(1);

    req.onsuccess = () => {
      const data = req.result;
      if (data) {
        console.log("📂 Data loaded:", data);
        resolve(data); // balikin data aja
      } else {
        console.warn("⚠️ Tidak ada data ditemukan.");
        resolve(null);
      }
    };

    req.onerror = () => {
      console.error("❌ Failed load:", req.error);
      reject(req.error);
    };
  });
}
  function clearDataDB() {
    return new Promise((resolve, reject) => {
      if (!db) return reject(new Error("DB belum diinisialisasi"));
      const tx = db.transaction(STORE_NAME, "readwrite");
      const store = tx.objectStore(STORE_NAME);
      const req = store.clear();
      req.onsuccess = () => resolve();
      req.onerror = () => reject(req.error);
    });
  }

  // ====================== Variabel Global ======================
  let menuPromo = [];
  let flipbookRuanganImages = [];
  let flipbookMenuImages = [];

  // ====================== PROMO ======================
  function renderPromoUI() {
    const container = document.getElementById("promoContainer");
    container.innerHTML = "";
    menuPromo.forEach((promo, index) => {
      const div = document.createElement("div");
      div.className = "menu-item";
      div.innerHTML = `
        <input type="text" placeholder="Promo Name" value="${promo.namaPromo || ""}" onchange="updatePromo(${index}, 'namaPromo', this.value)">
        <input type="file" accept="image/*" onchange="uploadPromoImage(event, ${index})">
        <img id="promoImgPreview${index}" src="${promo.image || ""}" style="max-height:80px; margin:5px 0">
        <input type="text" placeholder="Deskription Promo" value="${promo.deskripsi || ""}" onchange="updatePromo(${index}, 'deskripsi', this.value)">
        <input type="number" placeholder="Promo Price" value="${promo.harga || ""}" onchange="updatePromo(${index}, 'harga', this.value)">
        <input type="text" placeholder="Kategori Promo" value="${promo.kategori || ""}" onchange="updatePromo(${index}, 'kategori', this.value)">
        <input type="date" value="${promo.tanggalAkhir || ""}" onchange="updatePromo(${index}, 'tanggalAkhir', this.value)">
        <button class="btn-danger" onclick="hapusPromo(${index})">Delete Promo List</button>
      `;
      container.appendChild(div);
    });
  }

  function tambahPromo(promo = {}) {
    menuPromo.push({
      namaPromo: promo.namaPromo || "",
      image: promo.image || "",
      deskripsi: promo.deskripsi || "",
      harga: promo.harga || "",
      kategori: promo.kategori || "",
      tanggalAkhir: promo.tanggalAkhir || "",
    });
    renderPromoUI();
  }

  function updatePromo(index, key, value) {
    if (!menuPromo[index]) return;
    menuPromo[index][key] = value;
  }

  function hapusPromo(index) {
  menuPromo.splice(index, 1);
  renderPromoUI();
  if (window._saveTimeout) clearTimeout(window._saveTimeout);
  window._saveTimeout = setTimeout(() => { simpanData().catch(e=>console.error(e)); }, 300);
}
  function uploadPromoImage(event, index) {
    const file = event.target.files[0];
    if (!file) return;
    resizeIfNeeded(file)
      .then((resized) => {
        document.getElementById(`promoImgPreview${index}`).src = resized;
        updatePromo(index, "image", resized);
      })
      .catch(err => console.error("Failed upload promo:", err));
  }

 // ====================== MENU ======================
function tambahMenu(kategori = "food", nama = "", harga = "", image = "") {
  // Mapping kategori ke container
  const containerId = {
    food: "menuFoodContainer",
    snack: "menuSnackContainer",
    drink: "menuDrinkContainer",
    special: "menuSpecialContainer"
  }[kategori] || "menuFoodContainer";

  const container = document.getElementById(containerId);
  if (!container) return;

  const div = document.createElement("div");
  div.className = "menu-item";
  div.innerHTML = `
    <input type="text" placeholder="Menu Name" value="${nama}" />
    <input type="number" placeholder="Price" value="${harga}" />
    <select>
      <option value="food" ${kategori === "food" ? "selected" : ""}>Food</option>
      <option value="snack" ${kategori === "snack" ? "selected" : ""}>Snack</option>
      <option value="drink" ${kategori === "drink" ? "selected" : ""}>Drink</option>
      <option value="special" ${kategori === "special" ? "selected" : ""}>Special</option>
    </select>
    <input type="file" accept="image/*" onchange="uploadMenuImage(event, this)" data-image="${image}">
    <img class="menuPreview" src="${image}" style="max-height:80px; margin:5px 0; ${image ? "" : "display:none"}">
    <button class="btn-danger" onclick="this.parentElement.remove()">Delete</button>
  `;
  container.appendChild(div);
}

function uploadMenuImage(event, inputEl) {
  const file = event.target.files[0];
  if (!file) return;
  resizeIfNeeded(file)
    .then((resized) => {
      const preview = inputEl.parentElement.querySelector(".menuPreview");
      preview.src = resized;
      preview.style.display = "block";
      inputEl.setAttribute("data-image", resized); // simpan base64 ke attribute
    })
    .catch(err => console.error("Upload menu image failed:", err));
}


function ambilMenu(containerId) {
  const container = document.getElementById(containerId);
  const items = container ? container.querySelectorAll(".menu-item") : [];
  const result = [];

  items.forEach(item => {
    const inputs = item.querySelectorAll("input, select");
    const nama = inputs[0]?.value || "";
    const harga = parseInt(inputs[1]?.value || "0");
    const kategori = inputs[2]?.value || "food";
    const image = inputs[3]?.getAttribute("data-image") || ""; // ambil base64 dari attribute

    if (nama && harga) {
      result.push({ nama, harga, kategori, image });
    }
  });

  return result;
}

  // ====================== ROOM ======================
  function tambahRoom(kategori) {
    const containerId = {
      hotel: "roomHotelContainer",
      meeting: "meetingRoomContainer",
      package: "packageContainer"
    }[kategori];
    if (!containerId) return;
    const container = document.getElementById(containerId);
    const wrapper = document.createElement("div");
    wrapper.className = "room-form";
    wrapper.innerHTML = `
      <input type="text" class="room-nama" placeholder="Name" />
      <input type="number" class="room-harga" placeholder="Price" />
      <input type="number" class="room-kapasitas" placeholder="Capacity (Person)" />
      <input type="number" class="room-luas" placeholder="room size (m²)" />
      <textarea class="room-deskripsi" placeholder="notes"></textarea>
      <div class="gambar-preview-wrapper">
        <img class="gambar-preview" style="display:none; max-width:120px; margin-top:6px;" />
        <button class="hapus-gambar" onclick="hapusGambarRoom(this)" style="display:none;">×</button>
      </div>
      <button class="btn-upload-gambar room-image-upload" onclick="uploadGambarRoom(this)">🖼️ Upload Image</button>
      <button class="btn-hapus-room" onclick="hapusFormRoom(this)">🗑️ Delete</button>
      <hr>
    `;
    container.appendChild(wrapper);
  }

  function ambilSemuaRoom() {
    const kategoriIds = [
      { id: "roomHotelContainer", kategori: "hotel" },
      { id: "meetingRoomContainer", kategori: "meeting" },
      { id: "packageContainer", kategori: "package" }
    ];
    const hasil = [];
    kategoriIds.forEach(({ id, kategori }) => {
      const container = document.getElementById(id);
      if (!container) return;
      const forms = container.querySelectorAll(".room-form");
      forms.forEach(form => {
        const nama = form.querySelector(".room-nama")?.value || "";
        const harga = parseInt(form.querySelector(".room-harga")?.value || "0");
        const kapasitas = parseInt(form.querySelector(".room-kapasitas")?.value || "0");
        const luas = parseInt(form.querySelector(".room-luas")?.value || "0");
        const deskripsi = form.querySelector(".room-deskripsi")?.value || "";
        const image = form.querySelector(".room-image-upload")?.getAttribute("data-image") || "";

        if (nama && harga) {
          hasil.push({
            id: "R" + Date.now() + Math.floor(Math.random() * 1000), // ✅ id unik
            nama,
            harga,
            kapasitas,
            luas,
            deskripsi,
            image,
            kategori
          });
        }
      });
    });
    return hasil;
  }

  function restoreRoomFromData(rooms = []) {
    rooms.forEach(room => {
      tambahRoom(room.kategori);
      const containerId = {
        hotel: "roomHotelContainer",
        meeting: "meetingRoomContainer",
        package: "packageContainer"
      }[room.kategori];
      const container = document.getElementById(containerId);
      const forms = container.querySelectorAll(".room-form");
      const lastForm = forms[forms.length - 1];
      lastForm.querySelector(".room-nama").value = room.nama || "";
      lastForm.querySelector(".room-harga").value = room.harga || "";
      lastForm.querySelector(".room-kapasitas").value = room.kapasitas || "";
      lastForm.querySelector(".room-luas").value = room.luas || "";
      lastForm.querySelector(".room-deskripsi").value = room.deskripsi || "";
      const preview = lastForm.querySelector(".gambar-preview");
      const hapusBtn = lastForm.querySelector(".hapus-gambar");
      const uploadBtn = lastForm.querySelector(".room-image-upload");
      if (room.image) {
        preview.src = room.image;
        preview.style.display = "block";
        hapusBtn.style.display = "flex";
        uploadBtn.setAttribute("data-image", room.image);
      }
    });
  }

  function uploadGambarRoom(button) {
    const input = document.createElement("input");
    input.type = "file";
    input.accept = "image/*";
    input.style.display = "none";
    input.onchange = function (e) {
      const file = e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = function (event) {
        const wrapper = button.closest(".room-form");
        const preview = wrapper.querySelector(".gambar-preview");
        const hapusBtn = wrapper.querySelector(".hapus-gambar");
        const imageUrl = event.target.result;
        preview.src = imageUrl;
        preview.style.display = "block";
        hapusBtn.style.display = "flex";
        button.setAttribute("data-image", imageUrl);
      };
      reader.readAsDataURL(file);
    };
    document.body.appendChild(input);
    input.click();
    document.body.removeChild(input);
  }

  function hapusGambarRoom(button) {
    const wrapper = button.closest(".room-form");
    const preview = wrapper.querySelector(".gambar-preview");
    const uploadBtn = wrapper.querySelector(".room-image-upload");
    preview.src = "";
    preview.style.display = "none";
    button.style.display = "none";
    if (uploadBtn) uploadBtn.removeAttribute("data-image");
  }

 function hapusFormRoom(button) {
  const form = button.closest(".room-form");
  if (form) {
    form.remove();
    // Simpan perubahan ke DB supaya update langsung permanen
    // Debounce kecil untuk mencegah banyak panggilan beruntun
    if (window._saveTimeout) clearTimeout(window._saveTimeout);
    window._saveTimeout = setTimeout(() => { simpanData().catch(e=>console.error(e)); }, 300);
  }
}

  async function tampilkanListRoom() {
    try {
      const data = await loadDataFromDB();
      const listContainer = document.getElementById("listRuangan");
      if (!listContainer) return; // ✅ jika elemen tidak ada, skip saja

      listContainer.innerHTML = "";

      if (!data.rooms || data.rooms.length === 0) {
        listContainer.innerHTML = "<p>Tidak ada ruangan yang tersedia.</p>";
        return;
      }

      data.rooms.forEach((room, index) => {
        const item = document.createElement("div");
        item.classList.add("room-card");
        item.innerHTML = `
          <strong>Ruangan ${index + 1}</strong><br>
          🏷️ Nama: ${room.nama}<br>
          💼 Kategori: ${room.kategori}<br>
          💰 Harga: Rp${room.harga}<br>
          👥 Kapasitas: ${room.kapasitas || "-"} orang<br>
          📐 Luas: ${room.luas || "-"} m²<br>
          📝 Catatan: ${room.deskripsi || "-"}
          <hr>
        `;
        listContainer.appendChild(item);
      });
    } catch (err) {
      console.error("Failed to display room list:", err);
    }
  }

  // ====================== NOMOR WA ======================
  function tambahNomorWa() {
    const container = document.getElementById("nomorWaContainer");
    const input = document.createElement("input");
    input.type = "text";
    input.className = "nomor-wa";
    input.placeholder = "Example: 6281234567890";
    container.appendChild(input);
  }

  // ====================== IMAGE ======================
  async function resizeIfNeeded(file, targetSizeKB = 100, maxWidth = 1280) {
  return new Promise((resolve, reject) => {
    const reader = new FileReader();
    reader.onload = e => {
      const img = new Image();
      img.onload = async () => {
        try {
          const scale = Math.min(maxWidth / img.width, 1);
          const canvas = document.createElement("canvas");
          canvas.width = img.width * scale;
          canvas.height = img.height * scale;
          const ctx = canvas.getContext("2d");
          ctx.drawImage(img, 0, 0, canvas.width, canvas.height);

          // Mulai compress loop sampai <= targetSizeKB
          let quality = 0.9;
          let dataUrl = canvas.toDataURL("image/jpeg", quality);
          let sizeKB = Math.round((dataUrl.length * 3 / 4) / 1024);

          while(sizeKB > targetSizeKB && quality > 0.1) {
            quality -= 0.05;
            dataUrl = canvas.toDataURL("image/jpeg", quality);
            sizeKB = Math.round((dataUrl.length * 3 / 4) / 1024);
          }

          resolve(dataUrl);
        } catch(err) {
          reject(err);
        }
      };
      img.onerror = () => reject(new Error("Image load error"));
      img.src = e.target.result;
    };
    reader.onerror = reject;
    reader.readAsDataURL(file);
  });
}

// Example: upload logo
document.getElementById("logoInput")?.addEventListener("change", async function (e) {
  const file = e.target.files[0];
  if (!file) return;
  try {
    const logoUrl = await resizeIfNeeded(file, 100); // target 100KB
    document.getElementById("previewLogo").src = logoUrl;
  } catch (err) {
    console.error("Logo error:", err);
    alert("❌ Failed to prscess logo image.");
  }
});

  function renderImagePreview(tipe, url) {
    const img = document.createElement("img");
    img.src = url;
    img.style.maxWidth = "100px";
    img.style.margin = "5px";
    img.style.borderRadius = "5px";
    img.style.boxShadow = "0 1px 4px rgba(0,0,0,0.1)";

    const wrapper = document.createElement("div");
    wrapper.style.display = "inline-block";
    wrapper.style.position = "relative";
    wrapper.style.margin = "5px";

    const btnHapus = document.createElement("button");
    btnHapus.className = "btn-hapus-gambar";
    btnHapus.setAttribute("aria-label", "Hapus Gambar");
    btnHapus.innerHTML = "×";
    btnHapus.style.position = "absolute";
    btnHapus.style.top = "2px";
    btnHapus.style.right = "2px";
    btnHapus.onclick = () => {
      wrapper.remove();
      if (tipe === "ruangan") flipbookRuanganImages = flipbookRuanganImages.filter(s => s !== url);
      else flipbookMenuImages = flipbookMenuImages.filter(s => s !== url);
    };

    wrapper.appendChild(img);
    wrapper.appendChild(btnHapus);

    const container = document.getElementById(tipe === "ruangan" ? "flipbookRuanganPreview" : "flipbookMenuPreview");
    container.appendChild(wrapper);
  }

  function tambahGambar(tipe) {
    const input = document.createElement("input");
    input.type = "file";
    input.accept = "image/*";
    input.style.display = "none";
    input.onchange = async e => {
      const file = e.target.files[0];
      if (!file) return;
      try {
        const url = await resizeIfNeeded(file);
        renderImagePreview(tipe, url);
        if (tipe === "ruangan") flipbookRuanganImages.push(url);
        else flipbookMenuImages.push(url);
      } catch (err) {
        console.error(err);
        alert("❌ Gagal memproses gambar.");
      }
    };
    document.body.appendChild(input);
    input.click();
    document.body.removeChild(input);
  }

   // Fungsi slugify sederhana (untuk bikin URL-friendly)
function slugify(text) {
  return text
    .toString()
    .toLowerCase()
    .trim()
    .replace(/\s+/g, '-')       // ganti spasi dengan "-"
    .replace(/[^\w\-]+/g, '')   // hapus karakter non-alphanumeric
    .replace(/\-\-+/g, '-');    // ganti "--" menjadi "-"
}

async function simpanData() {
  try {
    showLoader(); // ⏳ mulai loading

    const namaRestoran = document.getElementById("namaRestoran").value.trim();
    const restoAddress = document.getElementById("restoAddress").value.trim();
    const restoPhone = document.getElementById("restoPhone").value.trim();
    const logo = document.getElementById("previewLogo").src || "";
    const nomorWaAdmin = Array.from(document.querySelectorAll(".nomor-wa")).map(i => i.value);

    // --- Hidden restoId selalu sinkron ke restoPhone ---
    let restoIdEl = document.getElementById("restoId");
    if (!restoIdEl) {
      restoIdEl = document.createElement("input");
      restoIdEl.type = "hidden";
      restoIdEl.id = "restoId";
      document.body.appendChild(restoIdEl);
    }

    if (!restoPhone) {
      alert("❌ Please input the restaurant phone number before saving!");
      return;
    }
    // ✅ restoId = restoPhone
    const restoId = restoPhone;
    restoIdEl.value = restoId;

    const menuData = [
      ...ambilMenu("menuFoodContainer"),
      ...ambilMenu("menuSnackContainer"),
      ...ambilMenu("menuDrinkContainer"),
      ...ambilMenu("menuSpecialContainer")
    ];

    const promo = typeof menuPromo !== "undefined" ? menuPromo : [];
    const flipRuangan = typeof flipbookRuanganImages !== "undefined" ? flipbookRuanganImages : [];
    const flipMenu = typeof flipbookMenuImages !== "undefined" ? flipbookMenuImages : [];

    const data = {
      restoId,
      namaRestoran,
      restoAddress,
      restoPhone,
      logo,
      nomorWaAdmin,
      menuPromo: promo,
      flipbookRuanganImages: flipRuangan,
      flipbookMenuImages: flipMenu,
      menu: menuData,
      rooms: ambilSemuaRoom()
    };

    await saveDataToDB(data);
    updateShareUI();

    alert(`✅ All data saved successfully!: ${restoId}`);
  } catch (err) {
    console.error(err);
    alert("❌ Failed to save data.");
  } finally {
    hideLoader(); // ✅ selesai loading
  }
}

let loadDataCalls = 0;

async function loadData() {
  loadDataCalls++;
  console.log("🔄 loadData dipanggil ke-", loadDataCalls);

  try {
    showLoader(); // ⏳ mulai loading

    await initDB();
    const data = await loadDataFromDB();
    if (!data) {
      console.warn("⚠️ Tidak ada data tersimpan di DB");
      return;
    }
    console.log("📦 Data berhasil di-load dari DB:", data);

    // --- CLEAR UI / STATE dulu supaya tidak duplikat ---
    console.log("🧹 Clear semua container & reset state");
    document.getElementById("promoContainer")?.innerHTML = "";
    document.getElementById("menuFoodContainer")?.innerHTML = "";
    document.getElementById("menuSnackContainer")?.innerHTML = "";
    document.getElementById("menuDrinkContainer")?.innerHTML = "";
    document.getElementById("menuSpecialContainer")?.innerHTML = "";
    document.getElementById("roomHotelContainer")?.innerHTML = "";
    document.getElementById("meetingRoomContainer")?.innerHTML = "";
    document.getElementById("packageContainer")?.innerHTML = "";
    document.getElementById("flipbookRuanganPreview")?.innerHTML = "";
    document.getElementById("flipbookMenuPreview")?.innerHTML = "";
    document.getElementById("listRuangan")?.innerHTML = "";

    menuPromo = [];
    flipbookRuanganImages = [];
    flipbookMenuImages = [];

    // isi form di halaman admin
    document.getElementById("namaRestoran").value = data.namaRestoran || "";
    document.getElementById("restoAddress").value = data.restoAddress || "";
    document.getElementById("restoPhone").value = data.restoPhone || "";

    // ✅ sinkron restoId ke hidden field
    let restoIdEl = document.getElementById("restoId");
    if (!restoIdEl) {
      restoIdEl = document.createElement("input");
      restoIdEl.type = "hidden";
      restoIdEl.id = "restoId";
      document.body.appendChild(restoIdEl);
    }
    restoIdEl.value = data.restoId || data.restoPhone || "";

    if (data.logo) {
      document.getElementById("previewLogo").src = data.logo;
      console.log("🖼️ Logo berhasil di-load");
    }

    // nomor WA
    if (Array.isArray(data.nomorWaAdmin)) {
      console.log("📱 Load nomor WA admin:", data.nomorWaAdmin);
      const container = document.getElementById("nomorWaContainer");
      container.innerHTML = "";
      data.nomorWaAdmin.forEach(() => tambahNomorWa());
      const inputs = container.querySelectorAll(".nomor-wa");
      data.nomorWaAdmin.forEach((v, i) => inputs[i].value = v);
    }

    // promo, menu, rooms
    if (Array.isArray(data.menuPromo)) {
      console.log("🎟️ Load promo:", data.menuPromo.length);
      menuPromo = data.menuPromo.slice();
      renderPromoUI();
    }
    if (Array.isArray(data.menu)) {
      console.log("🍽️ Load menu:", data.menu.length);
      data.menu.forEach(m => tambahMenu(m.kategori, m.nama, m.harga, m.image));
    }
    if (Array.isArray(data.rooms)) {
      console.log("🏨 Load rooms:", data.rooms.length);
      restoreRoomFromData(data.rooms);
    }

    // flipbook
    flipbookRuanganImages = (data.flipbookRuanganImages || []).slice();
    console.log("📖 Flipbook ruangan:", flipbookRuanganImages.length);
    flipbookRuanganImages.forEach(src => renderImagePreview("ruangan", src));

    flipbookMenuImages = (data.flipbookMenuImages || []).slice();
    console.log("📖 Flipbook menu:", flipbookMenuImages.length);
    flipbookMenuImages.forEach(src => renderImagePreview("menu", src));

    console.log("✅ loadData Done");
  } catch (err) {
    console.error("❌ loadData Failed:", err);
  } finally {
    hideLoader(); // ✅ selesai loading
  }
}

  // ====================== RESET & BACKUP ======================
  async function resetData() {
    if (!confirm("Are you sure you want to delete all data?")) return;
    try { await clearDataDB(); location.reload(); } 
    catch(err) { alert("❌ Failed to delete data: "+err.message); }
  }

  async function backupData() {
    try {
      const data = await loadDataFromDB();
      if (!data) { 
        alert("No data to backup!"); 
        return; 
      }

      const filename = `menuva-backup-${Date.now()}.json`;
      const blob = new Blob([JSON.stringify(data, null, 2)], { type: "application/json" });
      const url = URL.createObjectURL(blob);

      // trigger download otomatis
      const link = document.createElement("a");
      link.href = url;
      link.download = filename;
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);

      // alert sukses saja, tanpa innerHTML
      alert(`✅ Backup successful! File ${filename} Ready to-download.`);
      
    } catch (err) {
      alert("❌ Backup failed: " + err.message);
      console.error(err);
    }
  }

function restoreDataFromFile(event) {
  const file = event.target.files[0];
  if (!file) return;

  const reader = new FileReader();
  reader.onload = async (e) => {
    try {
      let json = JSON.parse(e.target.result);

      // case: wrapper { profile: {...} } atau { data: {...} }
      if (json.profile && typeof json.profile === "object") {
        json = json.profile;
      } else if (json.data && typeof json.data === "object") {
        json = json.data;
      }

      // case: array → ambil index pertama aja
      if (Array.isArray(json)) {
        if (json.length === 0) throw new Error("File kosong");
        json = json[0];
      }

      // tambahkan restoId kalau belum ada
      if (!json.restoId) {
        const nama = (json.namaRestoran || "").trim();
        json.restoId = nama ? slugify(nama) : ("resto" + Date.now());
      }

      // simpan ke DB sebagai id=1 anchor
      await saveDataToDB(json);

      alert("✅ Data restored successfully! Reloading...");
      location.reload();

    } catch (err) {
      console.error("❌ Restore failed:", err);
      alert("❌ Failed to restore JSON file. Lihat console untuk detail.");
    }
  };
  reader.readAsText(file);
}
  // ====================== INIT ======================
  window.addEventListener("DOMContentLoaded", async () => {
    await initDB();
    await loadData();
    tampilkanListRoom();
  });

   function generateDynamicLink(baseUrl, data) {
  try {
    
    const jsonData = JSON.stringify(data);

    
    const encoded = encodeURIComponent(jsonData);

    
    const link = `${baseUrl}?data=${encoded}`;
    return link;
  } catch (err) {
    console.error("Gagal generate link:", err);
    return null;
  }
}

   async function createMenuvaLink() {
  try {
    const data = await loadDataFromDB(); // ambil data dari DB
    const link = generateDynamicLink("https://menuva.github.io/view.html", data);
    console.log("Dynamic Link:", link);
    return link;
  } catch (err) {
    console.error("Error createMenuvaLink:", err);
  }
}
// ====================== HELPER GET CUSTOMER LINK ======================
function getCustomerLink() {
  const restoId = document.getElementById("restoId")?.value;
  if (!restoId) return null;

  // Ambil base path folder saat ini
  const basePath = window.location.pathname.substring(0, window.location.pathname.lastIndexOf('/'));
  return `${window.location.origin}${basePath}/menu.html?resto=${encodeURIComponent(restoId)}`;
}


// ====================== OPEN CUSTOMER PAGE ======================
function openCustomerPage() {
  const link = getCustomerLink();
  if (!link) return alert("❌ Please click Save All first");
  window.open(link, "_blank");
}

// ====================== UPDATE SHARE UI ======================
function updateShareUI() {
  const link = getCustomerLink();
  if (!link) return;

  // === Tombol Copy Link ===
  const btnCopy = document.getElementById("btnSalinLink");
  if (btnCopy) {
    btnCopy.style.display = "inline-block";
    btnCopy.onclick = () => {
      navigator.clipboard.writeText(link)
        .then(() => alert("✅ Link copied to clipboard"))
        .catch(err => alert("❌ Failed to copy link: " + err));
    };
  }

  // === Tombol See Customer Page ===
  const btnSee = document.getElementById("btnOpenCustomer");
  if (btnSee) {
    btnSee.style.display = "inline-block";
    btnSee.onclick = () => window.open(link, "_blank");
  }

  // === Generate QR Code ===
  const qrContainer = document.getElementById("qrcodePreview");
  if (qrContainer) {
    qrContainer.innerHTML = ""; // bersihkan dulu
    QRCode.toCanvas(link, { width: 128 }, function (error, canvas) {
      if (error) {
        console.error(error);
        qrContainer.textContent = "❌ Failed to generate QR";
        return;
      }

      qrContainer.appendChild(canvas);

      // === Tombol Download QR ===
      const btnDownload = document.getElementById("btnDownloadQR");
      if (btnDownload) {
        btnDownload.style.display = "inline-block";
        btnDownload.onclick = () => {
          const a = document.createElement("a");
          a.href = canvas.toDataURL("image/png");
          a.download = `Resto-${Date.now()}-QRCode.png`;
          a.click();
        };
      }

      // === Tombol Print QR ===
      const btnPrint = document.getElementById("btnPrintQR");
      if (btnPrint) {
        btnPrint.style.display = "inline-block";
        btnPrint.onclick = () => {
          const dataUrl = canvas.toDataURL("image/png");
          const w = window.open("");
          w.document.write(`<img src="${dataUrl}" style="width:250px;height:250px;">`);
          w.document.close();
          w.print();
        };
      }
    });
  }
}
</script>

<div class="fixed-bar">
  <button onclick="window.location.href='index.html'" class="btn-success">🔒 Logout</button>
  <button onclick="resetData()" class="btn-danger">🗑️ Reset Data</button>
</div>

</body>
<script>
  window.addEventListener("load", function() {
    const fixbar = document.querySelector(".fixed-bar");
    if (fixbar) {
      const fixbarHeight = fixbar.offsetHeight;
      document.body.style.paddingBottom = fixbarHeight + 0 + "px"; 
      // +20 biar ada ruang ekstra
    }
  });
</script>
</html>



