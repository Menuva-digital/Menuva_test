<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>

  <title>Admin Menuva</title>
  <style>
    * { box-sizing: border-box; }
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
      padding-bottom: 80px;
      background: linear-gradient(135deg, #003366, #003366);
      margin: 0;
      position: relative;
      overflow-x: hidden;
    }
   /* =====================
   MOBILE-FIRST LOGO & HEADER
   ===================== */
.menuva-logo {
  text-align: center;
  margin-bottom: 10px;
  padding: 0 10px; /* beri sedikit jarak kiri-kanan di HP */
}

.menuva-logo img {
  max-width: 70%;   /* logo menyesuaikan lebar layar HP */
  height: auto;     /* menjaga proporsi asli */
  max-height: 80px; /* batasi tinggi supaya tidak terlalu besar */
  display: block;
  margin: 0 auto;   /* center logo */
}

.menuva-logo p {
  color: white;
  font-size: 13px;  /* ukuran font nyaman di HP */
  margin: 4px 0 0 0;
  line-height: 1.3;
}

/* =====================
   TABLET (min-width: 481px)
   ===================== */
@media (min-width: 481px) {
  .menuva-logo img {
    max-width: 50%;
    max-height: 90px;
  }
  .menuva-logo p {
    font-size: 14px;
  }
}

/* =====================
   DESKTOP (min-width: 769px)
   ===================== */
@media (min-width: 769px) {
  .menuva-logo img {
    max-width: 35%;
    max-height: 100px;
  }
  .menuva-logo p {
    font-size: 16px;
  }
}
    h1, h2, h3 {
      text-align: center;
      margin: 10px 0;
    }
    .section {
      background: #fff;
      padding: 20px;
      margin-bottom: 20px;
      border-radius: 10px;
      box-shadow: 0 3px 6px rgba(0,0,0,0.1);
    }
    input, button, textarea {
      padding: 10px;
      margin: 5px 0;
      border-radius: 5px;
      border: 1px solid #ccc;
      width: 100%;
      font-size: 1rem;
    }
    .menu-item {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items: center;
      margin-bottom: 10px;
    }
    .menu-item input {
      flex: 1 1 40%;
    }
    .menu-item button {
      flex: 1 1 auto;
      white-space: nowrap;
      background: linear-gradient(135deg, #7f5af0, #2cb5e8);
    }
    .btn-danger {
      background-color: #e74c3c;
      color: white;
    }
    .btn-success {
      background-color: #2ecc71;
      color: white;
    }
    .btn-secondary {
      background-color: #3498db;
      color: white;
    }
    .btn-orange {
      background-color: orange;
      color: white;
      border: none;
    }
    .preview img {
      max-width: 100px;
      margin: 5px;
      border-radius: 5px;
      box-shadow: 0 1px 4px rgba(0,0,0,0.1);
    }
    @media (max-width: 600px) {
      .menu-item input, .menu-item button {
        width: 100%;
      }
    }
    .room-section > div:nth-child(2) button {
      padding: 6px 14px;
      border-radius: 6px;
      background-color: #007bff;
      color: white;
      border: none;
      cursor: pointer;
    }
    .room-section-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
    }
    .room-form {
      padding: 10px;
      border: 1px dashed #ccc;
      margin-bottom: 12px;
      border-radius: 6px;
      background-color: #fff;
    }
    .room-form input[type="text"],
    .room-form input[type="number"],
    .room-form input[type="file"] {
      display: block;
      margin-bottom: 8px;
      width: 100%;
      padding: 6px;
      font-size: 14px;
    }
    .room-form .room-preview img {
      max-height: 80px;
      margin-top: 4px;
    }
    .gambar-preview-wrapper {
      position: relative;
      display: inline-block;
      margin-top: 10px;
    }
    .gambar-preview {
      height: auto !important;
      width: auto !important;
      max-height: 200px !important;
      max-width: 100% !important;
      display: block;
    }
    .hapus-gambar {
      position: absolute;
      top: -8px;
      right: -8px;
      background: red;
      color: white;
      border: none;
      border-radius: 50%;
      font-size: 14px;
      width: 24px;
      height: 24px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 2px 6px rgba(0,0,0,0.2);
      transition: background 0.2s;
    }
    .hapus-gambar:hover { background: #cc0000; }
    .btn-hapus-gambar {
      width: 24px;
      height: 24px;
      border-radius: 50%;
      border: none;
      background: red;
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      padding: 0;
      font-size: 14px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.2);
      transition: background 0.2s, transform 0.1s ease;
    }
    .btn-hapus-gambar:hover {
      background: #cc0000;
      transform: scale(1.05);
    }
    .section-box {
      border: none;
      padding: 16px;
      margin-bottom: 24px;
      border-radius: 8px;
      background: #fff;
    }
    .section-box h2,
    .section-box h3 { margin-top: 0; }
    .room-section { margin-bottom: 20px; }
    .room-section button {
      margin-bottom: 10px;
      background-color: #17a2b8;
    }
    .btn-simpan {
      background-color: #17a2b8;
      color: white;
      font-weight: bold;
      border: none;
      padding: 10px 16px;
      border-radius: 6px;
      cursor: pointer;
    }
    .btn-tambah-room {
      background: linear-gradient(135deg, #7f5af0, #2cb5e8);
      color: #fff;
      padding: 8px 14px;
      border: none;
      border-radius: 8px;
      font-weight: bold;
      box-shadow: 0 4px 10px rgba(127, 90, 240, 0.3);
      cursor: pointer;
      transition: transform 0.2s ease;
    }
    .btn-tambah-room:hover {
      transform: scale(1.05);
      box-shadow: 0 4px 12px rgba(44, 181, 232, 0.5);
    }
    .btn-hapus-room {
      background: linear-gradient(135deg, #ff6b6b, #fbc687);
      color: #fff;
      padding: 8px 14px;
      border: none;
      border-radius: 8px;
      font-weight: bold;
      box-shadow: 0 4px 10px rgba(255, 107, 107, 0.3);
      margin-top: 10px;
      cursor: pointer;
      transition: transform 0.2s ease;
    }
    .btn-hapus-room:hover {
      transform: scale(1.05);
      box-shadow: 0 4px 12px rgba(251, 198, 135, 0.5);
    }
    .btn-upload-gambar {
      background: linear-gradient(135deg, #00c6ff, #0072ff);
      color: white;
      padding: 6px 12px;
      border: none;
      border-radius: 6px;
      margin-top: 6px;
      font-weight: 500;
      cursor: pointer;
      transition: opacity 0.3s ease;
    }
    .btn-upload-gambar:hover { opacity: 0.85; }
  
    /* Style umum untuk tombol aksi penting */
.btn-action {
  display: inline-block;
  padding: 10px 16px;
  margin: 6px 4px;
  font-size: 14px;
  font-weight: 600;
  border-radius: 8px;
  border: none;
  cursor: pointer;
  color: #fff;
  transition: all 0.3s ease;
  box-shadow: 0 3px 6px rgba(0,0,0,0.15);
}

/* Copy Link â†’ biru elegan */
#btnSalinLink.btn-action {
  background: #007BFF;
}
#btnSalinLink.btn-action:hover {
  background: #0056b3;
}

/* Download QR â†’ hijau segar */
#btnDownloadQR.btn-action {
  background: #28a745;
}
#btnDownloadQR.btn-action:hover {
  background: #1e7e34;
}

/* Print QR â†’ oranye elegan */
#btnPrintQR.btn-action {
  background: #fd7e14;
}
#btnPrintQR.btn-action:hover {
  background: #e8590c;
}

/* Backup Data â†’ ungu premium */
#btnBackup.btn-action {
  background: #6f42c1;
}
#btnBackup.btn-action:hover {
  background: #5936a2;
}
/* Blue â€“ untuk backup */
.btn-blue {
  background: linear-gradient(135deg, #3b82f6, #1e3a8a);
  color: white;
}
.btn-blue:hover {
  background: linear-gradient(135deg, #1e3a8a, #172554);
  transform: scale(1.05);
}
/* Base style tombol */
button {
  padding: 10px 16px;
  font-size: 15px;
  border: none;
  border-radius: 6px;
  cursor: pointer;
  font-weight: 600;
  transition: all 0.25s ease;
}

/* Orange â€“ utama */
.btn-orange {
  background: linear-gradient(135deg, #ff914d, #ff6a00);
  color: white;
}
.btn-orange:hover {
  background: linear-gradient(135deg, #ff6a00, #cc5500);
  transform: scale(1.05);
}

/* Teal â€“ untuk salin link */
.btn-teal {
  background: linear-gradient(135deg, #20c997, #0f766e);
  color: white;
}
.btn-teal:hover {
  background: linear-gradient(135deg, #0f766e, #0c5f56);
  transform: scale(1.05);
}

/* Purple â€“ untuk download */
.btn-purple {
  background: linear-gradient(135deg, #a855f7, #6b21a8);
  color: white;
}
.btn-purple:hover {
  background: linear-gradient(135deg, #6b21a8, #4c1d95);
  transform: scale(1.05);
}

/* Red â€“ untuk print */
.btn-red {
  background: linear-gradient(135deg, #ef4444, #b91c1c);
  color: white;
}
.btn-red:hover {
  background: linear-gradient(135deg, #b91c1c, #7f1d1d);
  transform: scale(1.05);
}
 .setting-card {
    background: linear-gradient(135deg, #ffffff, #f9fafb);
    border: 1px solid #e2e8f0;
    border-radius: 16px;
    padding: 20px;
    margin-bottom: 20px;
    box-shadow: 0 4px 10px rgba(0,0,0,0.05);
  }
  .setting-card h2 {
    font-size: 18px;
    margin: 0 0 12px;
    color: #1e293b;
  }

  /* Switch toggle elegan */
  .switch {
    position: relative;
    display: inline-block;
    width: 60px;
    height: 32px;
    margin-right: 10px;
  }
  .switch input {
    opacity: 0;
    width: 0;
    height: 0;
  }
  .slider {
    position: absolute;
    cursor: pointer;
    inset: 0;
    background-color: #cbd5e1;
    transition: .4s;
    border-radius: 32px;
  }
  .slider:before {
    position: absolute;
    content: "";
    height: 24px;
    width: 24px;
    left: 4px;
    bottom: 4px;
    background-color: white;
    transition: .4s;
    border-radius: 50%;
  }
  input:checked + .slider {
    background: linear-gradient(135deg, #2563eb, #1e40af);
  }
  input:checked + .slider:before {
    transform: translateX(28px);
  }

  .setting-label {
    font-size: 12px;
    font-weight: 600;
    color: #334155;
    vertical-align: middle;
  }

    /* Tombol simpan voucher */
  #saveVoucherBtn {
    background: linear-gradient(135deg, #b8860b, #ffd700);
    color: #1a1a1a;
    box-shadow: 0 3px 6px rgba(0,0,0,0.2);
  }
  #saveVoucherBtn:hover {
    background: linear-gradient(135deg, #ffd700, #ffcc33);
    transform: translateY(-2px);
  }

  /* Tombol copy voucher */
  #voucherPreview button {
    background: linear-gradient(135deg, #b8860b, #ffd700);
    color: #1a1a1a;
    font-size: 14px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.2);
  }
  #voucherPreview button:hover {
    background: linear-gradient(135deg, #ffd700, #ffcc33);
    transform: translateY(-2px);
  }
  .fixed-bar {
  position: fixed;
  bottom: 0;
  left: 0;
  right: 0;
  display: flex;
  justify-content: space-around;
  background: linear-gradient(135deg, #003366, #003366);
  padding: 6px 0;
  border-top: 1px solid #ddd;
  z-index: 1000;
}

.nav-btn {
  flex: 1;
  background: none;
  border: none;
  cursor: pointer;
  display: flex;
  flex-direction: column;
  align-items: center;
  padding: 4px 0;
  font-size: 14px;
  transition: color 0.3s ease;
}

/* standby putih */
.nav-btn .icon,
.nav-btn .label {
  color: #ffffff; /* putih */
  transition: color 0.3s ease;
}

.nav-btn .icon {
  font-size: 20px;
  line-height: 1;
}

.nav-btn .label {
  font-size: 11px;
  margin-top: 2px;
}

/* hover emas */
.nav-btn:hover .icon,
.nav-btn:hover .label {
  color: #FFD700; /* emas */
}

/* aktif (misal ditekan) boleh kasih efek lain */
.nav-btn:active .icon,
.nav-btn:active .label {
  color: #FFA500; /* oranye keemasan */
}

  </style>
</head>
<body>
<div class="menuva-logo">
  <img src="menuva-logo.png" alt="Logo Menuva">
  <br>
  <p style="color: white;">Digital Solution For Restaurant, Hotel, & Cafe's</p>
</div>

<div class="section">
  <h2>ğŸ“‡ Business Identity</h2>
  
  <label for="logoInput">Your Business Logo</label>
  <input type="file" id="logoInput" name="logoInput" accept="image/*" />

  <img id="previewLogo" src="" alt="Logo Restoran" style="max-height: 80px; margin-top: 10px;" />

  <label for="namaRestoran">Your Business Name</label>
  <input type="text" id="namaRestoran" name="namaRestoran" placeholder="Your Business Name" />

  <label for="restoAddress">Your Business Address</label>
  <input id="restoAddress" name="restoAddress" type="text" placeholder="Jl. Sudirman No. 10, Jakarta" />

  <label for="restoPhone">Phone Number</label>
  <input id="restoPhone" name="restoPhone" type="text" placeholder="08xx-xxxx-xxxx" />
</div>

<div class="section">
  <h2>ğŸ”¥ Menu Promo</h2>
  <div id="promoContainer"></div>
  <button class="btn-orange" onclick="tambahPromo()">+ Add Promo Menu</button>
</div>

<div class="section">
  <h2>ğŸ“‹ SPECIAL MENU</h2>
  <div id="menuSpecialContainer"></div>
  <button class="btn-success" onclick="tambahMenu('special')">+ Add Special Menu</button>
</div>

<div class="section">
  <h2>ğŸ“‹ FOOD MENU</h2>
  <div id="menuFoodContainer"></div>
  <button class="btn-success" onclick="tambahMenu('food')">+ Add Menu</button>
</div>

<div class="section">
  <h2>ğŸ“‹ SNACK & DESSERT</h2>
  <div id="menuSnackContainer"></div>
  <button class="btn-success" onclick="tambahMenu('snack')">+ Add Menu</button>
</div>

<div class="section">
  <h2>ğŸ“‹ DRINK</h2>
  <div id="menuDrinkContainer"></div>
  <button class="btn-success" onclick="tambahMenu('drink')">+ Add Menu</button>
</div>

<div class="section-box" id="waContainerBox">
  <h3>ğŸ“± Admin WhatsApp Number (Order/Reservation Recipient)</h3>
  <div id="nomorWaContainer">
    <label for="waNumber1" class="sr-only">WhatsApp Number</label>
    <input type="text" id="waNumber1" name="waNumber[]" class="nomor-wa" placeholder="Example: 6281234567890">
  </div>
  <button onclick="tambahNomorWa()">+ Add WA Number</button>
</div>

<div class="section">
  <h2>ğŸ“¸ Room Gallery</h2>
  <button onclick="tambahGambar('ruangan')">+ Add Room Image</button>
  <input type="file" id="flipbookRuanganUpload" name="flipbookRuanganUpload" accept="image/*" multiple style="display:none;" />
  <div id="flipbookRuanganPreview"></div>
</div>

<div class="section">
  <h2>ğŸ“– Restaurant Menu</h2>
  <button onclick="tambahGambar('menu')">+ Add Menu Image</button>
  <input type="file" id="flipbookMenuUpload" name="flipbookMenuUpload" accept="image/*" multiple style="display:none;" />
  <div id="flipbookMenuPreview"></div>
</div>

<div class="setting-card" id="orderToggleBox">
  <h2>âš™ï¸ Reservation & Delivery Setting</h2>
  <label class="switch">
    <input type="checkbox" id="toggleOrderPage" name="toggleOrderPage">
    <span class="slider"></span>
  </label>
  <span class="setting-label">Enable/Disable Reservation & Delivery Page</span>
</div>

<div class="setting-card" id="roomToggleBox">
  <h2>âš™ï¸ Room Page Setting</h2>
  <label class="switch">
    <input type="checkbox" id="toggleRoomPage" name="toggleRoomPage">
    <span class="slider"></span>
  </label>
  <span class="setting-label">Enable/Disable Room Page.</span>
</div>

<div class="section-box" id="roomContainerBox">
  <h2>ğŸ¨ Room / Packages</h2>
  <div class="room-section">
    <h3>ğŸ›ï¸ Room Hotel</h3>
    <button onclick="tambahRoom('hotel')" class="btn-tambah-room">+ Add Hotel Room</button>
    <div id="roomHotelContainer"></div>
  </div>
  <div class="room-section">
    <h3>ğŸ’¼ Meeting Room</h3>
    <button onclick="tambahRoom('meeting')" class="btn-tambah-room">+ Add Meeting Room</button>
    <div id="meetingRoomContainer"></div>
  </div>
  <div class="room-section">
    <h3>ğŸ Packages</h3>
    <button onclick="tambahRoom('package')" class="btn-tambah-room">+ Add Packages</button>
    <div id="packageContainer"></div>
  </div>
</div>

<div class="section-box" id="voucherContainerBox">
  <h2>ğŸŸï¸ Voucher Diskon</h2>
  <label class="switch">
    <input type="checkbox" id="toggleVoucherPage" name="toggleVoucherPage">
    <span class="slider round"></span>
  </label>

  <div id="voucherForm" style="margin-top:15px; display:none;">
    <label for="voucherCode">Voucher Code</label>
    <input type="text" id="voucherCode" name="voucherCode" placeholder="Kode Voucher">

    <label for="voucherDiscount">Discount (%)</label>
    <input type="number" id="voucherDiscount" name="voucherDiscount" placeholder="Diskon (%)">

    <label for="voucherExpiry">Expiry Date</label>
    <input type="date" id="voucherExpiry" name="voucherExpiry">

    <button id="saveVoucherBtn" onclick="saveVoucher()">ğŸ’¾ Save Voucher Code</button>
  </div>

  <div id="voucherPreview"></div>
</div>

<hr>

<div class="section">
  <button class="btn-simpan" onclick="simpanData()">ğŸ’¾ Save All</button>
  <input type="hidden" id="restoId" name="restoId" />

  <button id="btnOpenCustomer" class="btn-orange" onclick="openCustomerPage()">ğŸ‘ï¸ See Customer Page</button>
  <button id="btnSalinLink" class="btn-teal" style="display:none;">ğŸ“‹ Copy Link to Share with Customers</button>

  <div id="qrcodePreview" style="margin-top:10px;"></div>

  <button id="btnDownloadQR" class="btn-purple" style="margin-top:10px; display:none;">â¬‡ï¸ Download QR Code</button>
  <button id="btnPrintQR" class="btn-red" style="margin-top:5px; display:none;">ğŸ–¨ï¸ Print QR Code</button>

  <div class="section">
    <h2>ğŸ” Backup & Restore Data</h2>
    <button id="btnBackup" class="btn-blue" onclick="backupData()">ğŸ“¦ Backup Data</button>
    <div id="backupDownloadLink" style="margin-top:10px;"></div>

    <label for="restoreInput" style="margin-top: 20px; display: block;">ğŸ“‚ Select JSON File to Restore:</label>
    <input type="file" id="restoreInput" name="restoreInput" accept=".json" onchange="restoreDataFromFile(event)" />
  </div>
  
  <!-- Panduan -->
  <div style="background: #fef9e7; padding: 10px; border-left: 5px solid #f1c40f; margin-top: 10px; font-size: 14px;">
    <strong>Panduan Penggunaan:</strong><br>
    PENTING!!<br>
    ğŸ”¹ Klik <strong>â¬‡ï¸ Backup Data</strong> untuk menyimpan semua data restoran ke file <strong>.json</strong>.<br>
    ğŸ”¹ Simpan file tersebut dengan baik.<br>
    ğŸ”¹ Klik <strong>ğŸ“‚ Pilih File</strong> untuk me-restore data.<br>
    âš ï¸ Proses restore menggantikan seluruh data saat ini.<br>
  </div>

  <div style="background: #fef9e7; padding: 10px; border-left: 5px solid #f1c40f; margin-top: 10px; font-size: 14px;">
    <strong>User Guide:</strong><br>
    IMPORTANT!!<br>
    ğŸ”¹ Click <strong>â¬‡ï¸ Backup Data</strong> to save all data.<br>
    ğŸ”¹ Keep the file safe.<br>
    ğŸ”¹ Click <strong>ğŸ“‚ Choose File</strong> to restore data.<br>
    âš ï¸ The restore process replaces all existing data.<br>
  </div>

  <button onclick="resetData()" class="btn-danger">ğŸ—‘ï¸ Reset Data</button>
</div>
  <script>
/*
  Admin Unified Script - Menuva
  Merged & fixed (part1 + part2) â€” prevents duplicated menu & room rendering
  Date: 2025-11-10
*/

// ----- GUARDS -----
if (window.__AdminInitDone) {
  console.warn("âš ï¸ Admin script sudah di-init sebelumnya - skrip ini akan berhenti.");
} else {
  window.__AdminInitDone = true;

  // ====================== GLOBAL DB HANDLER ======================
  let dbReady = null;
  const DB_NAME = "MenuvaDB";
  const STORE_NAME = "menuvaData";
  const DB_VERSION = 9;

  let dbInstance = null;
  let dbPromise = null; // lock to prevent race

  // quick check for presence of indexedDB (mobile)
  if (!window.indexedDB) {
    alert("âš ï¸ Browser ini tidak mendukung IndexedDB!");
  } else {
    try {
      const testReq = indexedDB.open("TestDB_Check");
      testReq.onsuccess = () => {
        testReq.result.close();
        indexedDB.deleteDatabase("TestDB_Check");
        console.log("âœ… IndexedDB bisa dibuka di perangkat ini");
      };
      testReq.onerror = (e) => {
        console.warn("âš ï¸ Test IndexedDB error:", e);
      };
    } catch (err) {
      console.warn("âš ï¸ Test IndexedDB failed:", err);
    }
  }

  async function initDB() {
    if (dbInstance) return dbInstance;
    if (dbPromise) return dbPromise;

    console.groupCollapsed("ğŸŸ¢ initDB()");
    console.trace("initDB called from");
    console.groupEnd();

    dbPromise = new Promise((resolve, reject) => {
      const request = indexedDB.open(DB_NAME, DB_VERSION);

      request.onupgradeneeded = (e) => {
        const db = e.target.result;
        if (!db.objectStoreNames.contains(STORE_NAME)) {
          db.createObjectStore(STORE_NAME, { keyPath: "id" });
        }
      };

      request.onsuccess = (e) => {
        dbInstance = e.target.result;
        resolve(dbInstance);
        dbPromise = null;
      };

      request.onerror = (e) => {
        console.error("âŒ initDB error:", e.target.error);
        reject(e.target.error);
        dbPromise = null;
      };
    });

    return dbPromise;
  }

  async function getDB() {
    if (dbInstance) return dbInstance;
    return initDB();
  }

  // ====================== SAVE & LOAD ======================
  async function saveDataToDB(data) {
    if (!data || typeof data !== "object") throw new Error("Invalid data");

    // Use fixed id 1 to store single admin profile
    const recordId = 1;
    const record = { id: recordId, ...data };

    const db = await getDB();
    return new Promise((resolve, reject) => {
      const tx = db.transaction(STORE_NAME, "readwrite");
      const store = tx.objectStore(STORE_NAME);
      const req = store.put(record);
      req.onsuccess = () => {
        console.log("âœ… Data saved:", record);
        resolve(record);
      };
      req.onerror = (e) => {
        console.error("âŒ saveDataToDB error:", e.target.error);
        reject(e.target.error);
      };
    });
  }

  async function loadDataFromDB(id = 1) {
    // small delay to let things settle in some devices
    await new Promise(res => setTimeout(res, 100));
    try {
      const db = await getDB();
      return new Promise((resolve, reject) => {
        const tx = db.transaction(STORE_NAME, "readonly");
        const store = tx.objectStore(STORE_NAME);
        const req = store.get(id);
        req.onsuccess = (e) => {
          const data = e.target.result;
          if (data) resolve(data);
          else resolve(null);
        };
        req.onerror = (e) => {
          console.error("âŒ loadDataFromDB error:", e.target.error);
          resolve(null);
        };
      });
    } catch (err) {
      console.error("âŒ loadDataFromDB init failed:", err);
      return null;
    }
  }

  function buatDataDefault(id = 1) {
    return {
      id,
      restoId: "resto-main",
      namaRestoran: "",
      restoAddress: "",
      restoPhone: "",
      logo: "",
      nomorWaAdmin: [],
      menuPromo: [],
      flipbookRuanganImages: [],
      flipbookMenuImages: [],
      menu: [],
      rooms: [],
      menuVoucher: []
    };
  }

  async function clearDataDB() {
    const db = await initDB();
    return new Promise((resolve, reject) => {
      try {
        const tx = db.transaction(STORE_NAME, "readwrite");
        const store = tx.objectStore(STORE_NAME);
        const req = store.clear();
        req.onsuccess = () => {
          console.log("ğŸ§¹ Semua data dihapus dari IndexedDB");
          resolve();
        };
        req.onerror = (e) => reject(e.target.error);
      } catch (err) {
        reject(err);
      }
    });
  }

  // ====================== GLOBAL STATE ======================
  let menuPromo = [];
  let flipbookRuanganImages = [];
  let flipbookMenuImages = [];
  let isLoadingFromDB = false;
  let voucherLoaded = false;

  // ----- loader UI (from part1) -----
  function showLoader() {
    let loader = document.getElementById("loader");
    if (!loader) {
      loader = document.createElement("div");
      loader.id = "loader";
      loader.innerHTML = `
        <div class="loader-overlay">
          <div class="loader-content">
            <div class="spinner"></div>
            <p>Loading data...</p>
          </div>
        </div>
      `;
      document.body.appendChild(loader);

      const style = document.createElement("style");
      style.id = "loader-style";
      style.textContent = `
        #loader { position: fixed; top:0;left:0;width:100%;height:100%;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,0.45);z-index:9999;opacity:0;transition:opacity .3s;}
        #loader.show { opacity:1; }
        .loader-content { text-align:center; color:#fff; font-family:Segoe UI, sans-serif; animation:fadeUp .6s; }
        .spinner { width:64px;height:64px;border:6px solid rgba(255,255,255,0.3);border-top-color:#00d4ff;border-radius:50%;animation:spin 1s linear infinite;margin:0 auto 16px;}
        @keyframes spin { to { transform: rotate(360deg); } } @keyframes fadeUp { from{opacity:0;transform:translateY(10px);}to{opacity:1;transform:translateY(0);} }
      `;
      document.head.appendChild(style);
    }
    loader.style.display = "flex";
    requestAnimationFrame(() => loader.classList.add("show"));
  }

  function hideLoader() {
    const loader = document.getElementById("loader");
    if (loader) {
      loader.classList.remove("show");
      setTimeout(() => { loader.style.display = "none"; }, 300);
    }
  }

  // ====================== UI HELPERS (menu / promo / rooms / flipbook) ======================

  // ensure containers id's are cleared to avoid duplicates
  function clearRenderContainers() {
    const idsToClear = [
      "promoContainer",
      "menuFoodContainer",
      "menuSnackContainer",
      "menuDrinkContainer",
      "menuSpecialContainer",
      "nomorWaContainer",
      "flipbookRuanganPreview",
      "flipbookMenuPreview",
      "roomHotelContainer",
      "meetingRoomContainer",
      "packageContainer",
      "listRuangan"
    ];
    idsToClear.forEach(id => {
      const el = document.getElementById(id);
      if (el) el.innerHTML = "";
    });
  }

  // ---------- PROMO ----------
  function renderPromoUI() {
    const container = document.getElementById("promoContainer");
    if (!container) return;
    container.innerHTML = "";

    const promoCategories = ["PROMO", "DISKON", "SPECIAL", "EVENT"];

    menuPromo.forEach((promo, index) => {
      const div = document.createElement("div");
      div.className = "menu-item";

      const optionsHTML = promoCategories
        .map(cat => `<option value="${cat}" ${promo.kategori === cat ? "selected" : ""}>${cat}</option>`)
        .join("");

      div.innerHTML = `
        <input type="text" id="promoName_${index}" name="promoName[]" placeholder="Promo Name" value="${promo.namaPromo || ""}" />
        <input type="file" id="promoImage_${index}" name="promoImage[]" accept="image/*" />
        <img id="promoImgPreview${index}" src="${promo.image || ""}" style="max-height:80px; margin:5px 0; ${promo.image ? "" : "display:none"}">
        <input type="text" id="promoDesc_${index}" name="promoDesc[]" placeholder="Description Promo" value="${promo.deskripsi || ""}" />
        <input type="number" id="promoPrice_${index}" name="promoPrice[]" placeholder="Promo Price" value="${promo.harga || ""}" />
        <select id="promoCat_${index}" name="promoCat[]">${optionsHTML}</select>
        <input type="date" id="promoDate_${index}" name="promoDate[]" value="${promo.tanggalAkhir || ""}" />
        <button class="btn-danger" data-promo-index="${index}">Delete Promo List</button>
      `;

      // attach delete handler
      div.querySelector(".btn-danger")?.addEventListener("click", (ev) => {
        const idx = parseInt(ev.currentTarget.dataset.promoIndex, 10);
        if (!Number.isNaN(idx)) {
          hapusPromo(idx);
        }
      });

      // attach file change handler
      const fileInput = div.querySelector(`#promoImage_${index}`);
      if (fileInput) {
        fileInput.addEventListener("change", (e) => {
          const file = e.target.files[0];
          if (!file) return;
          resizeIfNeeded(file).then(resized => {
            const imgEl = document.getElementById(`promoImgPreview${index}`);
            if (imgEl) { imgEl.src = resized; imgEl.style.display = "block"; }
            menuPromo[index].image = resized;
          }).catch(err => console.error(err));
        });
      }

      container.appendChild(div);
    });
  }

  function tambahPromo(promo = {}) {
    menuPromo.push({
      namaPromo: promo.namaPromo || "",
      image: promo.image || "",
      deskripsi: promo.deskripsi || "",
      harga: promo.harga || "",
      kategori: promo.kategori || "PROMO",
      tanggalAkhir: promo.tanggalAkhir || ""
    });
    renderPromoUI();
  }

  function updatePromo(index, key, value) {
    if (!menuPromo[index]) return;
    menuPromo[index][key] = value;
  }

  function hapusPromo(index) {
    menuPromo.splice(index, 1);
    renderPromoUI();
    if (window._saveTimeout) clearTimeout(window._saveTimeout);
    window._saveTimeout = setTimeout(() => { simpanData().catch(e=>console.error(e)); }, 300);
  }

  // ---------- MENU ----------
  function uid() { return `${Date.now().toString(36)}_${Math.floor(Math.random()*10000)}`; }

  function tambahMenu(kategori = "food", nama = "", harga = "", image = "", providedUid = null) {
    const containerId = {
      food: "menuFoodContainer",
      snack: "menuSnackContainer",
      drink: "menuDrinkContainer",
      special: "menuSpecialContainer"
    }[kategori] || "menuFoodContainer";

    const container = document.getElementById(containerId);
    if (!container) return;

    const elementUid = providedUid || uid();

    const div = document.createElement("div");
    div.className = "menu-item";
    div.innerHTML = `
      <input type="text" id="menuName_${elementUid}" name="menuName[]" placeholder="Menu Name" value="${nama}" />
      <input type="number" id="menuPrice_${elementUid}" name="menuPrice[]" placeholder="Price" value="${harga}" />
      <select id="menuCat_${elementUid}" name="menuCat[]">
        <option value="food" ${kategori === "food" ? "selected" : ""}>Food</option>
        <option value="snack" ${kategori === "snack" ? "selected" : ""}>Snack</option>
        <option value="drink" ${kategori === "drink" ? "selected" : ""}>Drink</option>
        <option value="special" ${kategori === "special" ? "selected" : ""}>Special</option>
      </select>
      <input type="file" id="menuImage_${elementUid}" name="menuImage[]" accept="image/*" />
      <img class="menuPreview" id="menuPreview_${elementUid}" src="${image}" style="max-height:80px; margin:5px 0; ${image ? "" : "display:none"}">
      <button class="btn-danger btn-delete-menu">Delete</button>
    `;

    // file input handler
    const fileInput = div.querySelector(`#menuImage_${elementUid}`);
    if (fileInput) {
      fileInput.addEventListener("change", (e) => {
        const file = e.target.files[0];
        if (!file) return;
        resizeIfNeeded(file).then(resized => {
          const preview = div.querySelector(`#menuPreview_${elementUid}`);
          if (preview) { preview.src = resized; preview.style.display = "block"; }
          fileInput.setAttribute("data-image", resized);
        }).catch(err => console.error(err));
      });
    }

    // delete handler
    div.querySelector(".btn-delete-menu")?.addEventListener("click", () => {
      div.remove();
      if (window._saveTimeout) clearTimeout(window._saveTimeout);
      window._saveTimeout = setTimeout(() => { simpanData().catch(e=>console.error(e)); }, 300);
    });

    container.appendChild(div);
  }

  function uploadMenuImage(event, inputEl) {
    const file = event.target.files[0];
    if (!file) return;
    resizeIfNeeded(file)
      .then((resized) => {
        const preview = inputEl.parentElement.querySelector(".menuPreview");
        preview.src = resized;
        preview.style.display = "block";
        inputEl.setAttribute("data-image", resized);
      })
      .catch(err => console.error("Upload menu image failed:", err));
  }

  function ambilMenu(containerId) {
    const container = document.getElementById(containerId);
    const items = container ? container.querySelectorAll(".menu-item") : [];
    const result = [];
    items.forEach(item => {
      const nameEl = item.querySelector('input[type="text"]');
      const priceEl = item.querySelector('input[type="number"]');
      const catEl = item.querySelector('select');
      const imgEl = item.querySelector('input[type="file"]');
      const nama = nameEl?.value?.trim() || "";
      const harga = parseInt(priceEl?.value || "0") || 0;
      const kategori = catEl?.value || "food";
      const image = imgEl?.getAttribute("data-image") || item.querySelector('.menuPreview')?.src || "";
      if (nama && harga >= 0) {
        result.push({ nama, harga, kategori, image });
      }
    });
    return result;
  }

  // ---------- ROOM ----------
  function tambahRoom(kategori, data = {}) {
    const containerId = {
      hotel: "roomHotelContainer",
      meeting: "meetingRoomContainer",
      package: "packageContainer"
    }[kategori];

    if (!containerId) return;
    const container = document.getElementById(containerId);
    if (!container) return;

    const uidRoom = uid();
    const wrapper = document.createElement("div");
    wrapper.className = "room-form";
    wrapper.dataset.roomUid = uidRoom;

    wrapper.innerHTML = `
      <input type="text" id="${uidRoom}_nama" name="roomName[]" class="room-nama" placeholder="Name" value="${data.nama || ""}" />
      <input type="number" id="${uidRoom}_harga" name="roomPrice[]" class="room-harga" placeholder="Price" value="${data.harga || ""}" />
      <input type="number" id="${uidRoom}_kapasitas" name="roomCapacity[]" class="room-kapasitas" placeholder="Capacity" value="${data.kapasitas || ""}" />
      <input type="number" id="${uidRoom}_luas" name="roomSize[]" class="room-luas" placeholder="Room size (mÂ²)" value="${data.luas || ""}" />
      <textarea id="${uidRoom}_deskripsi" name="roomDesc[]" class="room-deskripsi" placeholder="Notes">${data.deskripsi || ""}</textarea>
      <div class="gambar-preview-wrapper">
        <img id="${uidRoom}_preview" class="gambar-preview" alt="Room Preview" style="display:${data.image ? "block" : "none"}; max-width:120px; margin-top:6px; border-radius:6px;" src="${data.image || ""}" />
        <button type="button" class="hapus-gambar" style="display:${data.image ? "flex" : "none"};">Ã—</button>
      </div>
      <button type="button" id="${uidRoom}_uploadBtn" class="btn-upload-gambar room-image-upload">ğŸ–¼ï¸ Upload Image</button>
      <button type="button" id="${uidRoom}_hapusBtn" class="btn-hapus-room">ğŸ—‘ï¸ Delete</button>
      <hr>
    `;

    // upload handler
    wrapper.querySelector(`#${uidRoom}_uploadBtn`).addEventListener("click", (ev) => {
      const input = document.createElement("input");
      input.type = "file";
      input.accept = "image/*";
      input.style.display = "none";
      input.onchange = function (e) {
        const file = e.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = function (event) {
          const preview = wrapper.querySelector(`#${uidRoom}_preview`);
          const hapusBtn = wrapper.querySelector(".hapus-gambar");
          preview.src = event.target.result;
          preview.style.display = "block";
          hapusBtn.style.display = "flex";
          wrapper.querySelector(`#${uidRoom}_uploadBtn`).setAttribute("data-image", event.target.result);
        };
        reader.readAsDataURL(file);
      };
      document.body.appendChild(input);
      input.click();
      document.body.removeChild(input);
    });

    // hapus gambar
    wrapper.querySelector(".hapus-gambar").addEventListener("click", (ev) => {
      const preview = wrapper.querySelector(`#${uidRoom}_preview`);
      preview.src = "";
      preview.style.display = "none";
      ev.currentTarget.style.display = "none";
      wrapper.querySelector(`#${uidRoom}_uploadBtn`).removeAttribute("data-image");
    });

    // hapus form
    wrapper.querySelector(`#${uidRoom}_hapusBtn`).addEventListener("click", () => {
      wrapper.remove();
      if (window._saveTimeout) clearTimeout(window._saveTimeout);
      window._saveTimeout = setTimeout(() => { simpanData().catch(e=>console.error(e)); }, 300);
    });

    container.appendChild(wrapper);
  }

  function ambilSemuaRoom() {
    const kategoriIds = [
      { id: "roomHotelContainer", kategori: "hotel" },
      { id: "meetingRoomContainer", kategori: "meeting" },
      { id: "packageContainer", kategori: "package" }
    ];
    const hasil = [];
    kategoriIds.forEach(({ id, kategori }) => {
      const container = document.getElementById(id);
      if (!container) return;
      const forms = container.querySelectorAll(".room-form");
      forms.forEach(form => {
        const nama = form.querySelector(".room-nama")?.value || "";
        const harga = parseInt(form.querySelector(".room-harga")?.value || "0");
        const kapasitas = parseInt(form.querySelector(".room-kapasitas")?.value || "0");
        const luas = parseInt(form.querySelector(".room-luas")?.value || "0");
        const deskripsi = form.querySelector(".room-deskripsi")?.value || "";
        const image = form.querySelector(".room-image-upload")?.getAttribute("data-image") ||
                      form.querySelector(".gambar-preview")?.src || "";

        if (nama && harga >= 0) {
          hasil.push({
            id: "R" + Date.now() + Math.floor(Math.random() * 1000),
            nama,
            harga,
            kapasitas,
            luas,
            deskripsi,
            image,
            kategori
          });
        }
      });
    });
    return hasil;
  }

  function restoreRoomFromData(rooms = []) {
    // clear containers first to avoid duplicates
    const containers = ["roomHotelContainer", "meetingRoomContainer", "packageContainer"];
    containers.forEach(id => {
      const c = document.getElementById(id);
      if (c) c.innerHTML = "";
    });

    rooms.forEach(room => {
      tambahRoom(room.kategori, room);
    });
  }

  // ---------- FLIPBOOK & IMAGE ----------
  function renderImagePreview(tipe, url) {
    // prevent duplicate preview in arrays
    if (tipe === "ruangan") {
      if (!flipbookRuanganImages.includes(url)) flipbookRuanganImages.push(url);
    } else {
      if (!flipbookMenuImages.includes(url)) flipbookMenuImages.push(url);
    }

    const img = document.createElement("img");
    img.src = url;
    img.style.maxWidth = "100px";
    img.style.margin = "5px";
    img.style.borderRadius = "5px";
    img.style.boxShadow = "0 1px 4px rgba(0,0,0,0.1)";

    const wrapper = document.createElement("div");
    wrapper.style.display = "inline-block";
    wrapper.style.position = "relative";
    wrapper.style.margin = "5px";

    const btnHapus = document.createElement("button");
    btnHapus.className = "btn-hapus-gambar";
    btnHapus.setAttribute("aria-label", "Hapus Gambar");
    btnHapus.innerHTML = "Ã—";
    btnHapus.style.position = "absolute";
    btnHapus.style.top = "2px";
    btnHapus.style.right = "2px";
    btnHapus.onclick = () => {
      wrapper.remove();
      if (tipe === "ruangan") flipbookRuanganImages = flipbookRuanganImages.filter(s => s !== url);
      else flipbookMenuImages = flipbookMenuImages.filter(s => s !== url);
    };

    wrapper.appendChild(img);
    wrapper.appendChild(btnHapus);

    const container = document.getElementById(tipe === "ruangan" ? "flipbookRuanganPreview" : "flipbookMenuPreview");
    if (container) container.appendChild(wrapper);
  }

  function tambahGambar(tipe) {
    const input = document.createElement("input");
    input.type = "file";
    input.accept = "image/*";
    input.style.display = "none";
    input.onchange = async e => {
      const file = e.target.files[0];
      if (!file) return;
      try {
        const url = await resizeIfNeeded(file);
        renderImagePreview(tipe, url);
      } catch (err) {
        console.error(err);
        alert("âŒ Gagal memproses gambar.");
      }
    };
    document.body.appendChild(input);
    input.click();
    document.body.removeChild(input);
  }

  // ---------- IMAGE RESIZE Helper ----------
  async function resizeIfNeeded(file, targetSizeKB = 100, maxWidth = 1280) {
    return new Promise((resolve, reject) => {
      const reader = new FileReader();
      reader.onload = e => {
        const img = new Image();
        img.onload = async () => {
          try {
            const scale = Math.min(maxWidth / img.width, 1);
            const canvas = document.createElement("canvas");
            canvas.width = img.width * scale;
            canvas.height = img.height * scale;
            const ctx = canvas.getContext("2d");
            ctx.drawImage(img, 0, 0, canvas.width, canvas.height);

            let quality = 0.9;
            let dataUrl = canvas.toDataURL("image/jpeg", quality);
            let sizeKB = Math.round((dataUrl.length * 3 / 4) / 1024);

            while(sizeKB > targetSizeKB && quality > 0.1) {
              quality -= 0.05;
              dataUrl = canvas.toDataURL("image/jpeg", quality);
              sizeKB = Math.round((dataUrl.length * 3 / 4) / 1024);
            }

            resolve(dataUrl);
          } catch(err) {
            reject(err);
          }
        };
        img.onerror = () => reject(new Error("Image load error"));
        img.src = e.target.result;
      };
      reader.onerror = reject;
      reader.readAsDataURL(file);
    });
  }

  // ---------- nomor WA ----------
  function tambahNomorWa() {
    const container = document.getElementById("nomorWaContainer");
    if (!container) return;

    const count = container.querySelectorAll(".nomor-wa").length;
    const uniqueId = `nomorWa${count + 1}`;

    const input = document.createElement("input");
    input.type = "text";
    input.id = uniqueId;
    input.name = uniqueId;
    input.className = "nomor-wa";
    input.placeholder = "Example: 6281234567890";
    input.inputMode = "numeric";
    input.autocomplete = "off";
    input.pattern = "62[0-9]{8,}";
    input.title = "Gunakan format: 6281234567890";

    input.addEventListener("input", () => {
      input.value = input.value.replace(/[^0-9]/g, "");
    });

    container.appendChild(input);
  }

  // ---------- slugify ----------
  function slugify(text) {
    return text.toString().toLowerCase().trim().replace(/\s+/g,'-').replace(/[^\w\-]+/g,'').replace(/\-\-+/g,'-');
  }

  // ====================== SIMPAN (form -> DB) ======================
  async function simpanData() {
    try {
      showLoader();
      const namaRestoran = document.getElementById("namaRestoran")?.value.trim() || "";
      const restoAddress = document.getElementById("restoAddress")?.value.trim() || "";
      const restoPhone = document.getElementById("restoPhone")?.value.trim() || "";
      const logo = document.getElementById("previewLogo")?.src || "";
      const nomorWaAdmin = Array.from(document.querySelectorAll(".nomor-wa")).map(i => i.value);

      if (!restoPhone) {
        alert("âŒ Please input the restaurant phone number before saving!");
        hideLoader();
        return;
      }
      const restoId = document.getElementById("restoId")?.value || "resto-main";
      const menuData = [
        ...ambilMenu("menuFoodContainer"),
        ...ambilMenu("menuSnackContainer"),
        ...ambilMenu("menuDrinkContainer"),
        ...ambilMenu("menuSpecialContainer")
      ];

      const promo = Array.isArray(menuPromo) ? menuPromo : [];
      const flipRuangan = Array.isArray(flipbookRuanganImages) ? flipbookRuanganImages : [];
      const flipMenu = Array.isArray(flipbookMenuImages) ? flipbookMenuImages : [];

      const data = {
        restoId,
        namaRestoran,
        restoAddress,
        restoPhone,
        logo,
        nomorWaAdmin,
        menuPromo: promo,
        flipbookRuanganImages: flipRuangan,
        flipbookMenuImages: flipMenu,
        menu: menuData,
        rooms: ambilSemuaRoom(),
        menuVoucher: [] // keep structure
      };

      await saveDataToDB(data);

      // ensure restoId hidden exists
      let restoIdEl = document.getElementById("restoId");
      if (!restoIdEl) {
        restoIdEl = document.createElement("input");
        restoIdEl.type = "hidden";
        restoIdEl.id = "restoId";
        document.body.appendChild(restoIdEl);
      }
      restoIdEl.value = restoId;

      updateShareUI();
      alert(`âœ… All data saved successfully!: ${restoId}`);
    } catch (err) {
      console.error(err);
      alert("âŒ Failed to save data.");
    } finally {
      hideLoader();
    }
  }

  // Flag global untuk mencegah render ganda
  window.sudahLoadData = window.sudahLoadData || false;

  async function loadData(data) {
    // data can be raw object
    try {
      showLoader();

      // clear render containers to avoid duplicates (important)
      clearRenderContainers();

      // If array wrapper provided, use first element
      if (Array.isArray(data)) data = data[0] || {};
      if (!data || typeof data !== "object") {
        console.warn("âš ï¸ Data kosong atau bukan object di loadData");
        data = buatDataDefault();
      }

      // set form fields safely
      const safeSet = (id, value) => {
        const el = document.getElementById(id);
        if (el) el.value = value || "";
      };

      safeSet("namaRestoran", data.namaRestoran);
      safeSet("restoAddress", data.restoAddress);
      safeSet("restoPhone", data.restoPhone);

      const preview = document.getElementById("previewLogo");
      if (preview && data.logo) preview.src = data.logo;

      // nomor WA
      const container = document.getElementById("nomorWaContainer");
      if (container && Array.isArray(data.nomorWaAdmin)) {
        container.innerHTML = "";
        data.nomorWaAdmin.forEach(v => {
          tambahNomorWa();
        });
        const inputs = container.querySelectorAll(".nomor-wa");
        data.nomorWaAdmin.forEach((v, i) => {
          if (inputs[i]) inputs[i].value = v;
        });
      }

      // PROMO
      menuPromo = Array.isArray(data.menuPromo) ? data.menuPromo.slice() : [];
      if (typeof renderPromoUI === "function") renderPromoUI();

      // MENU MAIN - clear done already, restore items
      if (Array.isArray(data.menu)) {
        // ensure we don't reuse old containers (already cleared)
        data.menu.forEach((m) => {
          // protect against malformed entries
          const k = m.kategori || "food";
          const nama = m.nama || "";
          const harga = m.harga || 0;
          const image = m.image || "";
          tambahMenu(k, nama, harga, image);
        });
      }

      // ROOMS
      if (Array.isArray(data.rooms)) {
        restoreRoomFromData(data.rooms);
      }

      // FLIPBOOK RUANGAN
      flipbookRuanganImages = Array.isArray(data.flipbookRuanganImages) ? data.flipbookRuanganImages.slice() : [];
      flipbookRuanganImages.forEach(src => renderImagePreview("ruangan", src));

      // FLIPBOOK MENU
      flipbookMenuImages = Array.isArray(data.flipbookMenuImages) ? data.flipbookMenuImages.slice() : [];
      flipbookMenuImages.forEach(src => renderImagePreview("menu", src));

      // RESTO ID hidden
      let restoIdEl = document.getElementById("restoId");
      if (!restoIdEl) {
        restoIdEl = document.createElement("input");
        restoIdEl.type = "hidden";
        restoIdEl.id = "restoId";
        document.body.appendChild(restoIdEl);
      }
      restoIdEl.value = data.restoId || data.restoPhone || "";

      console.log("âœ… loadData selesai.");
    } catch (err) {
      console.error("âŒ loadData gagal:", err);
    } finally {
      hideLoader();
    }
  }

  // ====================== RESET & BACKUP & RESTORE ======================
  async function resetData() {
    if (!confirm("Are you sure you want to delete all data?")) return;
    try {
      await clearDataDB();
      location.reload();
    } catch(err) {
      alert("âŒ Failed to delete data: "+err.message);
    }
  }

  async function backupData() {
    try {
      const db = await initDB();
      const tx = db.transaction(STORE_NAME, "readonly");
      const store = tx.objectStore(STORE_NAME);
      const req = store.getAll();
      req.onsuccess = () => {
        const allData = req.result || [];
        if (allData.length === 0) {
          alert("âš ï¸ Tidak ada data di database untuk di-backup!");
          return;
        }
        const filename = `menuva-backup-${Date.now()}.json`;
        const blob = new Blob([JSON.stringify(allData, null, 2)], { type: "application/json" });
        const url = URL.createObjectURL(blob);
        const link = document.createElement("a");
        link.href = url;
        link.download = filename;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        URL.revokeObjectURL(url);
        alert(`âœ… Backup berhasil! File ${filename} siap diunduh.`);
      };
      req.onerror = (e) => { console.error("âŒ Backup read error:", e); alert("âŒ Backup gagal"); };
    } catch (err) {
      console.error("âŒ Backup fatal error:", err);
      alert("âŒ Terjadi kesalahan: " + err.message);
    }
  }

  function restoreDataFromFile(event) {
    const file = event.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = async (e) => {
      try {
        let json = JSON.parse(e.target.result);
        if (json.profile && typeof json.profile === "object") json = json.profile;
        else if (json.data && typeof json.data === "object") json = json.data;
        if (Array.isArray(json)) {
          if (json.length === 0) throw new Error("File kosong");
          json = json[0];
        }
        if (!json.restoId) {
          json.restoId = json.restoPhone || (json.namaRestoran ? slugify(json.namaRestoran) : ("resto" + Date.now()));
        }
        if (!json.restoPhone) json.restoPhone = json.restoId;
        await saveDataToDB(json);
        alert("âœ… Data restored successfully! Reloading...");
        location.reload();
      } catch (err) {
        console.error("âŒ Restore failed:", err);
        alert("âŒ Failed to restore JSON file. Lihat console untuk detail.");
      }
    };
    reader.readAsText(file);
  }

  // ====================== LINKS / QR / SHARE ======================
  function generateDynamicLink(baseUrl, data) {
    try {
      const jsonData = JSON.stringify(data);
      const encoded = encodeURIComponent(jsonData);
      return `${baseUrl}?data=${encoded}`;
    } catch (err) {
      console.error("Gagal generate link:", err);
      return null;
    }
  }

  async function createMenuvaLink() {
    try {
      const restoId = document.getElementById("restoId")?.value || document.getElementById("restoPhone")?.value || null;
      const data = await loadDataFromDB(restoId);
      const link = generateDynamicLink("https://menuva.github.io/view.html", data);
      console.log("Dynamic Link:", link);
      return link;
    } catch (err) {
      console.error("Error createMenuvaLink:", err);
    }
  }

  function getCustomerLink() {
    const restoId = document.getElementById("restoId")?.value;
    if (!restoId) return null;
    const basePath = window.location.pathname.substring(0, window.location.pathname.lastIndexOf('/'));
    return `${window.location.origin}${basePath}/menu.html?resto=${encodeURIComponent(restoId)}`;
  }

  function openCustomerPage() {
    const link = getCustomerLink();
    if (!link) return alert("âŒ Please click Save All first");
    window.open(link, "_blank");
  }

  function updateShareUI() {
    const link = getCustomerLink();
    if (!link) return;
    const btnCopy = document.getElementById("btnSalinLink");
    if (btnCopy) {
      btnCopy.style.display = "inline-block";
      btnCopy.onclick = () => {
        navigator.clipboard.writeText(link).then(() => alert("âœ… Link copied to clipboard")).catch(err => alert("âŒ Failed to copy link: " + err));
      };
    }
    const btnSee = document.getElementById("btnOpenCustomer");
    if (btnSee) { btnSee.style.display = "inline-block"; btnSee.onclick = () => window.open(link, "_blank"); }

    const qrContainer = document.getElementById("qrcodePreview");
    if (!qrContainer) return;
    qrContainer.innerHTML = "";
    if (typeof QRCode !== "undefined") {
      QRCode.toCanvas(link, { width: 128 }, function (error, canvas) {
        if (error) { console.error(error); qrContainer.textContent = "âŒ Failed to generate QR"; return; }
        qrContainer.appendChild(canvas);
        const btnDownload = document.getElementById("btnDownloadQR");
        if (btnDownload) {
          btnDownload.style.display = "inline-block";
          btnDownload.onclick = () => {
            const a = document.createElement("a");
            a.href = canvas.toDataURL("image/png");
            a.download = `Resto-${Date.now()}-QRCode.png`;
            a.click();
          };
        }
        const btnPrint = document.getElementById("btnPrintQR");
        if (btnPrint) {
          btnPrint.style.display = "inline-block";
          btnPrint.onclick = () => {
            const dataUrl = canvas.toDataURL("image/png");
            const w = window.open("");
            w.document.write(`<img src="${dataUrl}" style="width:250px;height:250px;">`);
            w.document.close();
            w.print();
          };
        }
      });
    } else {
      qrContainer.textContent = link;
    }
  }

  // ====================== VOUCHER FUNCTIONS (from part2) ======================
  async function initVoucherToggle() {
    const toggleVoucherPage = document.getElementById("toggleVoucherPage");
    const voucherForm = document.getElementById("voucherForm");
    const voucherContainerBox = document.getElementById("voucherContainerBox");

    if (!toggleVoucherPage || !voucherForm || !voucherContainerBox) {
      console.warn("âš ï¸ Elemen voucher toggle/form/container tidak lengkap, skip initVoucherToggle()");
      return;
    }

    const plan = localStorage.getItem("user_plan");
    if (plan === "monthly") {
      voucherContainerBox.style.display = "none";
      return;
    }

    const enabled = localStorage.getItem("page_voucher") === "true";
    toggleVoucherPage.checked = enabled;
    voucherForm.style.display = enabled ? "block" : "none";

    toggleVoucherPage.onchange = (e) => {
      const v = e.target.checked;
      localStorage.setItem("page_voucher", v);
      voucherForm.style.display = v ? "block" : "none";
      if (!v) {
        localStorage.removeItem("voucher");
        renderVoucher(null);
      }
    };

    await loadVoucherOnInit();
  }

  async function loadVoucherOnInit() {
    if (voucherLoaded) return;
    voucherLoaded = true;

    const fromLocal = localStorage.getItem("voucher");
    if (fromLocal) {
      try {
        const voucher = JSON.parse(fromLocal);
        renderVoucher(voucher);
        return;
      } catch (err) { console.warn("voucher local parse error", err); }
    }

    try {
      const db = await initDB();
      const tx = db.transaction(STORE_NAME, "readonly");
      const store = tx.objectStore(STORE_NAME);
      const req = store.get(1);
      req.onsuccess = (e) => {
        const data = e.target.result || {};
        const voucher = (data.menuVoucher && data.menuVoucher.length) ? data.menuVoucher[0] : null;
        if (voucher) {
          localStorage.setItem("voucher", JSON.stringify(voucher));
          renderVoucher(voucher);
        } else {
          renderVoucher(null);
        }
      };
      req.onerror = (e) => console.error("Voucher read error", e);
    } catch (err) {
      console.error("âŒ Gagal load voucher dari DB:", err);
    }
  }

  function renderVoucher(voucher) {
    const voucherPreview = document.getElementById("voucherPreview");
    if (!voucherPreview) return;
    if (voucher) {
      voucherPreview.innerHTML = `
        <p><strong>Kode Voucher:</strong> <span id="voucherCodeText">${voucher.code}</span> <button id="voucherCopyBtn">ğŸ“‹ Copy</button></p>
        <p><strong>Diskon:</strong> ${voucher.discount}%</p>
        <p><strong>Berlaku sampai:</strong> ${voucher.expiry}</p>
      `;
      document.getElementById("voucherCopyBtn")?.addEventListener("click", copyVoucherCode);
    } else {
      voucherPreview.innerHTML = "<em>Belum ada voucher aktif</em>";
    }
  }

  function copyVoucherCode() {
    const codeText = document.getElementById("voucherCodeText")?.innerText;
    if (!codeText) return;
    navigator.clipboard.writeText(codeText).then(() => alert("Kode voucher berhasil di-copy: " + codeText)).catch(err => console.error("Gagal copy", err));
  }

  // ====================== TOGGLES & INIT FLOW (part2) ======================
  function initOrderToggle() {
    const toggleOrderPage = document.getElementById("toggleOrderPage");
    const orderContainerBox = document.getElementById("orderContainerBox") || document.getElementById("orderToggleBox");
    if (!toggleOrderPage || !orderContainerBox) {
      console.warn("âš ï¸ Order toggle elements missing");
      return;
    }
    const saved = localStorage.getItem("page_order");
    toggleOrderPage.checked = saved === "true";
    orderContainerBox.style.display = toggleOrderPage.checked ? "block" : "none";
    toggleOrderPage.onchange = (e) => {
      const enabled = e.target.checked;
      localStorage.setItem("page_order", enabled);
      orderContainerBox.style.display = enabled ? "block" : "none";
    };
  }

  function initRoomToggle() {
    const toggleRoomPage = document.getElementById("toggleRoomPage");
    const roomContainerBox = document.getElementById("roomContainerBox");
    if (!toggleRoomPage || !roomContainerBox) { console.warn("âš ï¸ Room toggle missing"); return; }
    const saved = localStorage.getItem("page_room");
    toggleRoomPage.checked = saved === "true";
    roomContainerBox.style.display = toggleRoomPage.checked ? "block" : "none";
    toggleRoomPage.onchange = (e) => {
      const enabled = e.target.checked;
      localStorage.setItem("page_room", enabled);
      roomContainerBox.style.display = enabled ? "block" : "none";
    };
  }

  async function initAllToggles() {
    await new Promise((resolve) => {
      if (document.readyState === "complete") return resolve();
      document.addEventListener("readystatechange", () => { if (document.readyState === "complete") resolve(); });
    });
    initOrderToggle();
    initRoomToggle();
    await initVoucherToggle();
  }

  // ====================== SAFE LOAD WRAPPERS & INIT ======================
  async function safeLoadDataFromDB(id = 1) {
    if (isLoadingFromDB) {
      console.warn("âš ï¸ loadDataFromDB() di-skip, masih jalan");
      return null;
    }
    isLoadingFromDB = true;
    const data = await loadDataFromDB(id);
    isLoadingFromDB = false;
    return data;
  }

  async function safeLoadData(data) {
    if (window.sudahLoadData) {
      console.warn("âš ï¸ loadData() sudah pernah jalan, skip render ulang");
      return;
    }
    window.sudahLoadData = true;
    await loadData(data);
  }

  // ====================== INIT ON DOMContentLoaded (single entry) ======================
  async function initAdminPage() {
    console.log("ğŸš€ Init mulai...");
    showLoader();

    const timeout = setTimeout(() => {
      console.warn("âš ï¸ Init terlalu lama, sembunyikan loader paksa.");
      hideLoader();
    }, 8000);

    try {
      await initDB();
      console.log("âœ… IndexedDB siap");

      const data = await safeLoadDataFromDB(1);
      if (data) {
        await safeLoadData(data);
        console.log("ğŸ“¦ Data diambil:", data);
      } else {
        // if no data, set default state
        console.warn("âš ï¸ Tidak ada data ditemukan di DB, isi default");
        const def = buatDataDefault(1);
        await saveDataToDB(def);
        await safeLoadData(def);
      }

      await initAllToggles();

      const fixbar = document.querySelector(".fixed-bar");
      if (fixbar) document.body.style.paddingBottom = fixbar.offsetHeight + "px";

      console.log("âœ… Admin siap digunakan");
    } catch (err) {
      console.error("âŒ Error saat init:", err);
      alert("Terjadi kesalahan saat memuat data. Coba refresh halaman.");
    } finally {
      clearTimeout(timeout);
      hideLoader();
    }
  }

  // attach single DOMContentLoaded listener
  if (document.readyState === "loading") {
    document.addEventListener("DOMContentLoaded", initAdminPage);
  } else {
    // already ready
    setTimeout(initAdminPage, 0);
  }

  // Expose some helpers to global for UI buttons
  window.simpanData = simpanData;
  window.backupData = backupData;
  window.resetData = resetData;
  window.restoreDataFromFile = restoreDataFromFile;
  window.tambahNomorWa = tambahNomorWa;
  window.tambahPromo = tambahPromo;
  window.tambahMenu = tambahMenu;
  window.tambahRoom = tambahRoom;
  window.tambahGambar = tambahGambar;
  window.createMenuvaLink = createMenuvaLink;
  window.openCustomerPage = openCustomerPage;
  window.copyVoucherCode = copyVoucherCode;
}
</script>

</body>
</html>







